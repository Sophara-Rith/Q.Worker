{% extends 'base.html' %} {% load static %} {% block title %}Session Results{% endblock %} {% block content %}

<style>
    .custom-scrollbar::-webkit-scrollbar {
        width: 10px;
        height: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }
    .dark .custom-scrollbar::-webkit-scrollbar-track {
        background: #374151;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
    }
    .dark .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #4b5563;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
    thead.sticky-header th {
        position: sticky;
        top: 0;
        z-index: 20;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }
    .sticky-group {
        position: sticky;
        top: 0;
        z-index: 30;
    }
</style>

<div x-data="resultsDashboard()" x-init="init()" class="h-[calc(110vh-1.5rem)] flex flex-col relative overflow-hidden bg-gray-50 dark:bg-gray-900">
    <meta name="csrf-token" content="{{ csrf_token }}" />

    <div x-show="showHistoryModal" @keydown.escape.window="showHistoryModal = false" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" style="display: none" x-transition.opacity>
        <div @click.outside="showHistoryModal = false" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl p-6 relative flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h3 class="text-lg font-bold text-gray-900 dark:text-white">Edit History - Row <span x-text="historyRowId"></span></h3>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-500">Filter:</span>
                        <select x-model="historyFilter" class="text-sm border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="">All Fields</option>
                            <template x-for="field in uniqueHistoryFields" :key="field"><option :value="field" x-text="field"></option></template>
                        </select>
                    </div>
                    <button @click="showHistoryModal = false" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            </div>

            <div class="overflow-y-auto border rounded-lg flex-1 custom-scrollbar">
                <template x-if="historyLoading"><div class="text-center py-10 text-gray-500">Loading history...</div></template>
                <template x-if="!historyLoading && filteredHistoryLogs.length === 0"><div class="text-center py-10 text-gray-500">No edits recorded matching filter.</div></template>
                <table x-show="!historyLoading && filteredHistoryLogs.length > 0" class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400 sticky top-0 shadow-sm z-10">
                        <tr>
                            <th class="px-4 py-3 w-40">Time</th>
                            <th class="px-4 py-3 w-40">Modified Field</th>
                            <th class="px-4 py-3 text-red-600">Old Value</th>
                            <th class="px-4 py-3 text-green-600">New Value</th>
                            <th class="px-4 py-3 w-24 text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                        <template x-for="log in filteredHistoryLogs" :key="log.timestamp + log.field">
                            <tr class="bg-white hover:bg-gray-50 dark:bg-gray-800 dark:hover:bg-gray-700 transition-colors">
                                <td class="px-4 py-3 whitespace-nowrap text-xs text-gray-400" x-text="log.timestamp"></td>
                                <td class="px-4 py-3 font-mono font-bold text-gray-700 dark:text-gray-300" x-text="log.field"></td>
                                <td class="px-4 py-3 text-red-500 line-through" x-text="log.old_value"></td>
                                <td class="px-4 py-3 text-green-600 font-bold" x-text="log.new_value"></td>
                                <td class="px-4 py-3 text-center">
                                    <button @click="restoreHistoryValue(log)" class="px-3 py-1.5 bg-blue-50 text-blue-600 border border-blue-200 hover:bg-blue-600 hover:text-white hover:border-blue-600 dark:bg-blue-900/30 dark:border-blue-800 dark:text-blue-400 dark:hover:bg-blue-600 dark:hover:text-white rounded-md text-[10px] font-bold uppercase tracking-wider transition-all shadow-sm">
                                        Restore
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="flex flex-col md:flex-row justify-between items-center mb-4 flex-shrink-0 px-4 pt-4 border-b border-gray-200 dark:border-gray-800 pb-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white flex items-center gap-3">
                Session Results

                <div x-show="ovatrCode" x-transition class="hidden md:flex items-center gap-2 bg-indigo-50 dark:bg-indigo-900/30 border border-indigo-100 dark:border-indigo-800 px-2 py-0.5 rounded-xl shadow-sm">
                    <span class="text-[9px] font-bold text-indigo-400 dark:text-indigo-300 uppercase tracking-wider">Session Key</span>
                    <span class="text-sm font-mono font-bold text-indigo-700 dark:text-indigo-400" x-text="ovatrCode"></span>
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse ml-1"></div>
                </div>

                <span x-show="isCached" class="px-2 py-0.5 text-[10px] bg-green-100 text-green-800 rounded-xl font-bold uppercase tracking-wider" style="display: none">Cached</span>
            </h1>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Review and resolve data anomalies.</p>
        </div>

        <div class="flex gap-2 mt-4 md:mt-0 items-center">
            <div class="flex bg-gray-100 dark:bg-gray-700 rounded-lg p-1 mr-4 shadow-inner">
                <button @click="undo()" :disabled="historyIndex < 0" class="p-1.5 rounded hover:bg-white dark:hover:bg-gray-600 disabled:opacity-30 transition-all" title="Undo">
                    <svg class="w-4 h-4 text-gray-700 dark:text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" /></svg>
                </button>
                <button @click="redo()" :disabled="historyIndex >= history.length - 1" class="p-1.5 rounded hover:bg-white dark:hover:bg-gray-600 disabled:opacity-30 transition-all" title="Redo">
                    <svg class="w-4 h-4 text-gray-700 dark:text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6" /></svg>
                </button>
            </div>

            <button @click="fetchData(true)" class="px-4 py-2 text-sm font-bold text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                Refresh Cache
            </button>

            <div class="px-4 py-2 text-sm font-bold rounded-lg shadow-sm transition-all flex items-center gap-2 border" :class="isSaving ? 'bg-yellow-50 text-yellow-700 border-yellow-200 dark:bg-yellow-900/30 dark:text-yellow-400 dark:border-yellow-800' : 'bg-green-50 text-green-700 border-green-200 dark:bg-green-900/30 dark:text-green-400 dark:border-green-800'">
                <svg x-show="isSaving" class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <svg x-show="!isSaving" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                <span x-text="isSaving ? 'Saving...' : 'All changes saved'"></span>
            </div>

            <a :href="'{% url 'crosscheck:report' %}?ovatr_code=' + ovatrCode" class="px-5 py-2 text-sm font-bold text-white bg-indigo-600 rounded-lg shadow-md hover:bg-indigo-700 transition-colors flex items-center gap-2">
                Final Report <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" /></svg>
            </a>
            <button @click="downloadFile()" class="px-5 py-2 text-sm font-bold text-white bg-brand-600 rounded-lg shadow-md hover:bg-brand-700 transition-colors flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>Export Core
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-3 flex-shrink-0 px-4">
        <div class="bg-white dark:bg-gray-800 p-3 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
            <div class="text-xs font-bold text-gray-400 uppercase tracking-wider">Total Rows</div>
            <div class="text-2xl font-bold text-gray-900 dark:text-white mt-0.5" x-text="formatNumber(stats.total)">0</div>
            <div class="flex gap-3 mt-1 text-[10px] font-mono text-gray-400">
                <span>Local: <span x-text="stats.local_count || 0"></span></span><span>Import: <span x-text="stats.import_count || 0"></span></span>
            </div>
        </div>
        <div class="bg-green-50 dark:bg-green-900/20 p-3 rounded-xl shadow-sm border border-green-100 dark:border-green-800">
            <div class="text-xs font-bold text-green-600 uppercase tracking-wider">Matched / Shortage</div>
            <div class="text-2xl font-bold text-green-700 dark:text-green-400 mt-0.5" x-text="formatNumber(stats.matched)">0</div>
        </div>
        <div class="bg-red-50 dark:bg-red-900/20 p-3 rounded-xl shadow-sm border border-red-100 dark:border-red-800">
            <div class="text-xs font-bold text-red-600 uppercase tracking-wider">Not Found</div>
            <div class="text-2xl font-bold text-red-700 dark:text-red-400 mt-0.5" x-text="formatNumber(stats.not_found)">0</div>
        </div>
        <div class="bg-orange-50 dark:bg-orange-900/20 p-3 rounded-xl shadow-sm border border-orange-100 dark:border-orange-800">
            <div class="text-xs font-bold text-orange-600 uppercase tracking-wider">Mismatches</div>
            <div class="text-2xl font-bold text-orange-700 dark:text-orange-400 mt-0.5" x-text="formatNumber(stats.mismatch)">0</div>
        </div>
    </div>

    <div class="flex-1 mx-2 mb-2 bg-white dark:bg-gray-800 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 flex flex-col overflow-hidden relative group/table min-h-0">
        <div class="p-3 border-b border-gray-200 dark:border-gray-700 flex flex-col md:flex-row justify-between items-center bg-gray-50 dark:bg-gray-900/50 flex-shrink-0 gap-3">
            <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                <div class="relative w-full md:w-64">
                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </span>
                    <input type="text" x-model="search" placeholder="Search..." class="pl-9 w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white text-xs py-1.5 shadow-sm focus:ring-brand-500" />
                </div>
                <div class="flex bg-gray-200 dark:bg-gray-700 rounded-lg p-1">
                    <button @click="switchTable('local')" class="px-3 py-1 rounded-md text-sm font-bold transition-all" :class="tableType === 'local' ? 'bg-white dark:bg-gray-600 shadow text-brand-700 dark:text-white' : 'text-gray-500 hover:text-gray-700'">Local</button>
                    <button @click="switchTable('import')" class="px-3 py-1 rounded-md text-sm font-bold transition-all" :class="tableType === 'import' ? 'bg-white dark:bg-gray-600 shadow text-brand-700 dark:text-white' : 'text-gray-500 hover:text-gray-700'">Import</button>
                </div>
            </div>
            <div class="flex gap-2 text-sm font-bold">
                <button class="px-2 py-1 rounded-lg border transition-all text-xs" :class="filter === 'ALL' ? 'bg-gray-800 text-white' : 'bg-white hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-300'" @click="filter = 'ALL'">All</button>
                <button class="px-2 py-1 rounded-lg border transition-all text-green-700 border-green-200 text-xs" :class="filter === 'MATCHED' ? 'bg-green-100' : 'bg-white hover:bg-green-50 dark:bg-gray-700 dark:text-green-400'" @click="filter = 'MATCHED'">Matched</button>
                <button class="px-2 py-1 rounded-lg border transition-all text-orange-700 border-orange-200 text-xs" :class="filter === 'MISMATCH' ? 'bg-orange-100' : 'bg-white hover:bg-orange-50 dark:bg-gray-700 dark:text-orange-400'" @click="filter = 'MISMATCH'">Mismatch</button>
                <button class="px-2 py-1 rounded-lg border transition-all text-red-700 border-red-200 text-xs" :class="filter === 'NOT FOUND' ? 'bg-red-100' : 'bg-white hover:bg-red-50 dark:bg-gray-700 dark:text-red-400'" @click="filter = 'NOT FOUND'">Not Found</button>
            </div>
        </div>

        <div class="flex-1 overflow-auto w-full relative scroll-smooth custom-scrollbar" id="tableContainer" @scroll="handleScroll($el)">
            <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400 border-separate border-spacing-0">
                <thead class="text-xs text-gray-700 uppercase sticky-group shadow-md">
                    <tr class="h-6">
                        <th class="sticky left-0 z-30 bg-gray-100 dark:bg-gray-800 border-b border-r border-gray-300 dark:border-gray-600 w-16"></th>
                        <th colspan="7" class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-center border-b border-r border-blue-200 dark:border-blue-800 py-1 font-bold">Purchase Invoice</th>
                        <th colspan="6" class="bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-200 text-center border-b border-r border-orange-200 dark:border-orange-800 py-1 font-bold">Validation</th>
                        <th colspan="22" class="bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200 text-center border-b border-purple-200 dark:border-purple-800 py-1 font-bold">Tax Declaration (Matched)</th>
                    </tr>

                    <tr class="bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600">
                        <th class="px-3 py-2 sticky left-0 z-30 bg-gray-50 dark:bg-gray-700 border-r border-gray-200 dark:border-gray-600 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] w-16 text-center">No</th>
                        <th class="px-3 py-2 whitespace-nowrap bg-blue-50 dark:bg-gray-800">Description</th>
                        <th class="px-3 py-2 whitespace-nowrap bg-blue-50 dark:bg-gray-800">Supplier</th>
                        <th class="px-3 py-2 whitespace-nowrap bg-blue-50 dark:bg-gray-800">TIN</th>
                        <th class="px-3 py-2 whitespace-nowrap bg-blue-50 dark:bg-gray-800">Invoice #</th>
                        <th class="px-3 py-2 whitespace-nowrap bg-blue-50 dark:bg-gray-800">Date</th>
                        <th class="px-3 py-2 whitespace-nowrap text-right bg-blue-50 dark:bg-gray-800 border-r border-gray-200 dark:border-gray-600 font-bold">Amount</th>
                        <th class="px-3 py-2 text-center bg-blue-50 dark:bg-gray-800 border-r border-gray-200 dark:border-gray-600 font-bold w-48 min-w-[200px]">Status</th>
                        <th class="px-3 py-2 text-center whitespace-nowrap bg-orange-50 dark:bg-gray-800">P-Clean</th>
                        <th class="px-3 py-2 text-center whitespace-nowrap bg-orange-50 dark:bg-gray-800">D-Clean</th>
                        <th class="px-3 py-2 text-center whitespace-nowrap bg-orange-50 dark:bg-gray-800">Inv Match</th>
                        <th class="px-3 py-2 text-center whitespace-nowrap bg-orange-50 dark:bg-gray-800">Date Match</th>
                        <th class="px-3 py-2 text-center whitespace-nowrap bg-orange-50 dark:bg-gray-800">TIN Match</th>
                        <th class="px-3 py-2 text-right whitespace-nowrap bg-orange-50 dark:bg-gray-800 border-r border-gray-200 dark:border-gray-600 font-bold">Diff</th>
                        <th class="px-3 py-2 whitespace-nowrap bg-purple-50 dark:bg-gray-800">Date</th>
                        <th class="px-3 py-2 whitespace-nowrap bg-purple-50 dark:bg-gray-800">Invoice #</th>
                        <th class="px-3 py-2 whitespace-nowrap bg-purple-50 dark:bg-gray-800">Credit No</th>
                        <th class="px-3 py-2 whitespace-nowrap bg-purple-50 dark:bg-gray-800">Buyer Type</th>
                        <th class="px-3 py-2 whitespace-nowrap bg-purple-50 dark:bg-gray-800">TIN</th>
                        <th class="px-3 py-2 whitespace-nowrap bg-purple-50 dark:bg-gray-800">Buyer / Name</th>
                        <th class="px-3 py-2 whitespace-nowrap text-right bg-purple-50 dark:bg-gray-800 font-bold">Total Amt</th>
                        <th class="px-3 py-2 whitespace-nowrap text-right bg-purple-50 dark:bg-gray-800">Excl VAT</th>
                        <th class="px-3 py-2 whitespace-nowrap text-right bg-purple-50 dark:bg-gray-800">Non VAT</th>
                        <th class="px-3 py-2 whitespace-nowrap text-right bg-purple-50 dark:bg-gray-800">VAT 0</th>
                        <th class="px-3 py-2 whitespace-nowrap text-right bg-purple-50 dark:bg-gray-800 font-bold">VAT Local</th>
                        <th class="px-3 py-2 whitespace-nowrap text-right bg-purple-50 dark:bg-gray-800 font-bold">VAT Export</th>
                        <th class="px-3 py-2 whitespace-nowrap text-right bg-purple-50 dark:bg-gray-800">State Burden</th>
                        <th class="px-3 py-2 whitespace-nowrap text-right bg-purple-50 dark:bg-gray-800">Withheld</th>
                        <th class="px-3 py-2 whitespace-nowrap text-right bg-purple-50 dark:bg-gray-800">PLT</th>
                        <th class="px-3 py-2 whitespace-nowrap text-right bg-purple-50 dark:bg-gray-800">Spec Goods</th>
                        <th class="px-3 py-2 whitespace-nowrap text-right bg-purple-50 dark:bg-gray-800">Spec Serv</th>
                        <th class="px-3 py-2 whitespace-nowrap text-right bg-purple-50 dark:bg-gray-800">Accom</th>
                        <th class="px-3 py-2 whitespace-nowrap text-right bg-purple-50 dark:bg-gray-800">Redemption</th>
                        <th class="px-3 py-2 whitespace-nowrap bg-purple-50 dark:bg-gray-800">Notes</th>
                        <th class="px-3 py-2 whitespace-nowrap bg-purple-50 dark:bg-gray-800">Desc</th>
                        <th class="px-3 py-2 whitespace-nowrap bg-purple-50 dark:bg-gray-800">Dec Status</th>
                    </tr>
                </thead>

                <tbody class="divide-y divide-gray-100 dark:divide-gray-700 bg-white dark:bg-gray-800">
                    <template x-for="row in filteredRows" :key="row.no">
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors group text-xs">
                            <td class="px-2 py-2 font-mono text-gray-400 sticky left-0 z-10 bg-white dark:bg-gray-800 group-hover:bg-gray-50 dark:group-hover:bg-gray-700/50 border-r border-gray-100 dark:border-gray-700 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)] text-center">
                                <div class="flex items-center justify-between h-full">
                                    <span x-text="row.no"></span>
                                    <button x-show="row.has_history" @click="viewHistory(row.no)" class="text-blue-300 hover:text-blue-600 transition-colors ml-1" title="View History">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    </button>
                                </div>
                            </td>

                            <td @click="handleCellAction(row, 'p_desc', row.p_desc)" title="Click to copy, Dbl-click to edit" class="px-3 py-2 whitespace-nowrap max-w-xs truncate text-gray-600 dark:text-gray-300 cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/30">
                                <template x-if="editing.id === row.no && editing.field === 'p_desc'"><input type="text" x-model="row.p_desc" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full p-1 text-xs border rounded dark:bg-gray-700 dark:text-white dark:border-gray-600" autofocus /></template>
                                <template x-if="!(editing.id === row.no && editing.field === 'p_desc')"><span x-text="row.p_desc"></span></template>
                            </td>
                            <td @click="handleCellAction(row, 'p_supp', row.p_supp)" title="Click to copy, Dbl-click to edit" class="px-3 py-2 whitespace-nowrap max-w-xs truncate font-medium text-gray-800 dark:text-white cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/30">
                                <template x-if="editing.id === row.no && editing.field === 'p_supp'"><input type="text" x-model="row.p_supp" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full p-1 text-xs border rounded dark:bg-gray-700 dark:text-white dark:border-gray-600" autofocus /></template>
                                <template x-if="!(editing.id === row.no && editing.field === 'p_supp')"><span x-text="row.p_supp"></span></template>
                            </td>
                            <td @click="handleCellAction(row, 'p_tin', row.p_tin)" title="Click to copy, Dbl-click to edit" class="px-3 py-2 whitespace-nowrap font-mono text-blue-500 dark:text-blue-400 cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/30">
                                <template x-if="editing.id === row.no && editing.field === 'p_tin'"><input type="text" x-model="row.p_tin" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full p-1 text-xs border rounded font-mono dark:bg-gray-700 dark:text-white dark:border-gray-600" autofocus /></template>
                                <template x-if="!(editing.id === row.no && editing.field === 'p_tin')"><span x-text="row.p_tin"></span></template>
                            </td>
                            <td @click="handleCellAction(row, 'p_inv', row.p_inv)" title="Click to copy, Dbl-click to edit" class="px-3 py-2 whitespace-nowrap font-mono text-blue-600 dark:text-blue-400 cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/30">
                                <template x-if="editing.id === row.no && editing.field === 'p_inv'"><input type="text" x-model="row.p_inv" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full p-1 text-xs border rounded font-mono dark:bg-gray-700 dark:text-white dark:border-gray-600" autofocus /></template>
                                <template x-if="!(editing.id === row.no && editing.field === 'p_inv')"><span x-text="row.p_inv"></span></template>
                            </td>
                            <td @click="handleCellAction(row, 'p_date', row.p_date)" title="Click to copy, Dbl-click to edit" class="px-3 py-2 whitespace-nowrap font-mono text-gray-500 dark:text-gray-300 cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/30">
                                <template x-if="editing.id === row.no && editing.field === 'p_date'"><input type="text" x-model="row.p_date" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full p-1 text-xs border rounded font-mono dark:bg-gray-700 dark:text-white dark:border-gray-600" autofocus /></template>
                                <template x-if="!(editing.id === row.no && editing.field === 'p_date')"><span x-text="row.p_date"></span></template>
                            </td>
                            <td @click="handleCellAction(row, 'p_amt', row.p_amt)" title="Click to copy, Dbl-click to edit" class="px-3 py-2 whitespace-nowrap text-right font-mono font-bold text-gray-700 dark:text-gray-200 border-r border-gray-100 dark:border-gray-700 bg-blue-50/30 dark:bg-blue-900/10 cursor-pointer hover:bg-blue-100 dark:hover:bg-blue-900/50">
                                <template x-if="editing.id === row.no && editing.field === 'p_amt'"><input type="number" step="0.01" x-model="row.p_amt" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full p-1 text-xs border rounded font-mono text-right dark:bg-gray-700 dark:text-white dark:border-gray-600" autofocus /></template>
                                <template x-if="!(editing.id === row.no && editing.field === 'p_amt')"><span x-text="row.p_amt ? formatNumber(row.p_amt) : '-'"></span></template>
                            </td>

                            <td class="px-3 py-2 text-center border-r border-gray-100 dark:border-gray-700">
                                <span
                                    class="px-2 py-1 rounded text-[10px] font-bold border shadow-sm block w-full whitespace-normal leading-tight"
                                    :class="{ 'bg-green-50 text-green-700 border-green-200': row.status === 'MATCHED', 'bg-blue-50 text-blue-700 border-blue-200': row.status === 'SHORTAGE', 'bg-red-50 text-red-700 border-red-200': row.status === 'NOT FOUND', 'bg-orange-50 text-orange-700 border-orange-200': row.status === 'MISMATCH' }"
                                    x-text="statusText(row.status)"
                                ></span>
                            </td>

                            <td class="px-3 py-2 text-center whitespace-nowrap font-mono text-gray-500 dark:text-gray-300 bg-orange-50/30 dark:bg-orange-900/10"><span x-text="row.p_inv_clean"></span></td>
                            <td class="px-3 py-2 text-center whitespace-nowrap font-mono text-gray-500 dark:text-gray-300 bg-orange-50/30 dark:bg-orange-900/10"><span x-text="row.d_inv_clean"></span></td>
                            <td class="px-3 py-2 text-center bg-orange-50/30 dark:bg-orange-900/10"><span x-show="row.v_inv" class="text-green-500 text-sm">●</span><span x-show="!row.v_inv" class="text-red-500 text-sm font-bold">✕</span></td>
                            <td class="px-3 py-2 text-center bg-orange-50/30 dark:bg-orange-900/10"><span x-show="row.v_date" class="text-green-500 text-sm">●</span><span x-show="!row.v_date" class="text-red-500 text-sm font-bold">✕</span></td>
                            <td class="px-3 py-2 text-center bg-orange-50/30 dark:bg-orange-900/10"><span x-show="row.v_tin" class="text-green-500 text-sm">●</span><span x-show="!row.v_tin" class="text-red-500 text-sm font-bold">✕</span></td>
                            <td @click="handleCellAction(row, 'v_diff', row.v_diff)" class="px-3 py-2 text-right font-mono border-r border-gray-100 dark:border-gray-700 bg-orange-50/30 dark:bg-orange-900/10 font-bold cursor-pointer" :class="row.v_diff < -0.05 ? 'text-red-500' : (row.v_diff > 0.05 ? 'text-green-500' : 'text-gray-400 dark:text-gray-500')">
                                <template x-if="editing.id === row.no && editing.field === 'v_diff'"><input type="number" step="0.01" x-model="row.v_diff" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full p-1 text-xs border rounded font-mono text-right dark:bg-gray-700 dark:text-white dark:border-gray-600" autofocus /></template>
                                <template x-if="!(editing.id === row.no && editing.field === 'v_diff')"><span x-text="Math.abs(row.v_diff) > 0.05 ? formatNumber(row.v_diff) : '-'"></span></template>
                            </td>

                            <td @click="handleCellAction(row, 'd_data.date', row.d_data.date)" title="Click to copy, Dbl-click to edit" class="px-3 py-2 whitespace-nowrap font-mono text-purple-700 dark:text-purple-300 bg-purple-50/20 dark:bg-purple-900/20 cursor-pointer hover:bg-purple-100 dark:hover:bg-purple-900/50">
                                <template x-if="editing.id === row.no && editing.field === 'd_data.date'"><input type="text" x-model="row.d_data.date" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full p-1 text-xs border rounded font-mono dark:bg-gray-700 dark:text-white dark:border-gray-600" autofocus /></template>
                                <template x-if="!(editing.id === row.no && editing.field === 'd_data.date')"><span x-text="row.d_data.date || '-'"></span></template>
                            </td>
                            <td @click="handleCellAction(row, 'd_data.invoice_no', row.d_data.invoice_no)" title="Click to copy, Dbl-click to edit" class="px-3 py-2 whitespace-nowrap font-mono text-purple-600 dark:text-purple-300 bg-purple-50/20 dark:bg-purple-900/20 cursor-pointer hover:bg-purple-100 dark:hover:bg-purple-900/50">
                                <template x-if="editing.id === row.no && editing.field === 'd_data.invoice_no'"><input type="text" x-model="row.d_data.invoice_no" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full p-1 text-xs border rounded font-mono dark:bg-gray-700 dark:text-white dark:border-gray-600" autofocus /></template>
                                <template x-if="!(editing.id === row.no && editing.field === 'd_data.invoice_no')"><span x-text="row.d_data.invoice_no || '-'"></span></template>
                            </td>
                            <td @click="handleCellAction(row, 'd_data.credit_no', row.d_data.credit_no)" title="Click to copy, Dbl-click to edit" class="px-3 py-2 whitespace-nowrap font-mono text-gray-600 dark:text-gray-300 bg-purple-50/20 dark:bg-purple-900/20 cursor-pointer hover:bg-purple-100 dark:hover:bg-purple-900/50">
                                <template x-if="editing.id === row.no && editing.field === 'd_data.credit_no'"><input type="text" x-model="row.d_data.credit_no" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full p-1 text-xs border rounded font-mono dark:bg-gray-700 dark:text-white dark:border-gray-600" autofocus /></template>
                                <template x-if="!(editing.id === row.no && editing.field === 'd_data.credit_no')"><span x-text="row.d_data.credit_no || '-'"></span></template>
                            </td>
                            <td @click="handleCellAction(row, 'd_data.buyer_type', row.d_data.buyer_type)" title="Click to copy, Dbl-click to edit" class="px-3 py-2 whitespace-nowrap max-w-[120px] truncate text-gray-600 dark:text-gray-300 bg-purple-50/20 dark:bg-purple-900/20 cursor-pointer hover:bg-purple-100 dark:hover:bg-purple-900/50" :title="row.d_data.buyer_type">
                                <template x-if="editing.id === row.no && editing.field === 'd_data.buyer_type'"><input type="text" x-model="row.d_data.buyer_type" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full p-1 text-xs border rounded dark:bg-gray-700 dark:text-white dark:border-gray-600" autofocus /></template>
                                <template x-if="!(editing.id === row.no && editing.field === 'd_data.buyer_type')"><span x-text="row.d_data.buyer_type || '-'"></span></template>
                            </td>
                            <td @click="handleCellAction(row, 'd_data.tin', row.d_data.tin)" title="Click to copy, Dbl-click to edit" class="px-3 py-2 whitespace-nowrap font-mono text-blue-500 dark:text-blue-400 bg-purple-50/20 dark:bg-purple-900/20 cursor-pointer hover:bg-purple-100 dark:hover:bg-purple-900/50">
                                <template x-if="editing.id === row.no && editing.field === 'd_data.tin'"><input type="text" x-model="row.d_data.tin" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full p-1 text-xs border rounded font-mono dark:bg-gray-700 dark:text-white dark:border-gray-600" autofocus /></template>
                                <template x-if="!(editing.id === row.no && editing.field === 'd_data.tin')"><span x-text="row.d_data.tin || '-'"></span></template>
                            </td>
                            <td @click="handleCellAction(row, 'd_data.name', row.d_data.name)" title="Click to copy, Dbl-click to edit" class="px-3 py-2 whitespace-nowrap max-w-[180px] truncate text-gray-700 dark:text-gray-200 bg-purple-50/20 dark:bg-purple-900/20 cursor-pointer hover:bg-purple-100 dark:hover:bg-purple-900/50" :title="row.d_data.name">
                                <template x-if="editing.id === row.no && editing.field === 'd_data.name'"><input type="text" x-model="row.d_data.name" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full p-1 text-xs border rounded dark:bg-gray-700 dark:text-white dark:border-gray-600" autofocus /></template>
                                <template x-if="!(editing.id === row.no && editing.field === 'd_data.name')"><span x-text="row.d_data.name || '-'"></span></template>
                            </td>
                            <td @click="handleCellAction(row, 'd_data.total_amt', row.d_data.total_amt)" title="Click to copy, Dbl-click to edit" class="px-3 py-2 whitespace-nowrap text-right font-mono font-bold text-gray-700 dark:text-gray-200 bg-purple-50/20 dark:bg-purple-900/20 cursor-pointer hover:bg-purple-100 dark:hover:bg-purple-900/50">
                                <template x-if="editing.id === row.no && editing.field === 'd_data.total_amt'"><input type="number" step="0.01" x-model="row.d_data.total_amt" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full p-1 text-xs border rounded font-mono text-right dark:bg-gray-700 dark:text-white dark:border-gray-600" autofocus /></template>
                                <template x-if="!(editing.id === row.no && editing.field === 'd_data.total_amt')"><span x-text="row.d_data.total_amt ? formatNumber(row.d_data.total_amt) : '-'"></span></template>
                            </td>
                            <td @click="handleCellAction(row, 'd_data.excl_vat', row.d_data.excl_vat)" title="Click to copy, Dbl-click to edit" class="px-3 py-2 whitespace-nowrap text-right font-mono text-gray-600 dark:text-gray-300 bg-purple-50/20 dark:bg-purple-900/20 cursor-pointer hover:bg-purple-100 dark:hover:bg-purple-900/50">
                                <template x-if="editing.id === row.no && editing.field === 'd_data.excl_vat'"><input type="number" step="0.01" x-model="row.d_data.excl_vat" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full p-1 text-xs border rounded font-mono text-right dark:bg-gray-700 dark:text-white dark:border-gray-600" autofocus /></template>
                                <template x-if="!(editing.id === row.no && editing.field === 'd_data.excl_vat')"><span x-text="row.d_data.excl_vat ? formatNumber(row.d_data.excl_vat) : '-'"></span></template>
                            </td>
                            <td @click="handleCellAction(row, 'd_data.non_vat', row.d_data.non_vat)" title="Click to copy, Dbl-click to edit" class="px-3 py-2 whitespace-nowrap text-right font-mono text-gray-500 dark:text-gray-300 bg-purple-50/20 dark:bg-purple-900/20 cursor-pointer hover:bg-purple-100 dark:hover:bg-purple-900/50">
                                <template x-if="editing.id === row.no && editing.field === 'd_data.non_vat'"><input type="number" step="0.01" x-model="row.d_data.non_vat" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full p-1 text-xs border rounded font-mono text-right dark:bg-gray-700 dark:text-white dark:border-gray-600" autofocus /></template>
                                <template x-if="!(editing.id === row.no && editing.field === 'd_data.non_vat')"><span x-text="row.d_data.non_vat ? formatNumber(row.d_data.non_vat) : '-'"></span></template>
                            </td>
                            <td @click="handleCellAction(row, 'd_data.vat_0', row.d_data.vat_0)" title="Click to copy, Dbl-click to edit" class="px-3 py-2 whitespace-nowrap text-right font-mono text-gray-500 dark:text-gray-300 bg-purple-50/20 dark:bg-purple-900/20 cursor-pointer hover:bg-purple-100 dark:hover:bg-purple-900/50">
                                <template x-if="editing.id === row.no && editing.field === 'd_data.vat_0'"><input type="number" step="0.01" x-model="row.d_data.vat_0" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full p-1 text-xs border rounded font-mono text-right dark:bg-gray-700 dark:text-white dark:border-gray-600" autofocus /></template>
                                <template x-if="!(editing.id === row.no && editing.field === 'd_data.vat_0')"><span x-text="row.d_data.vat_0 ? formatNumber(row.d_data.vat_0) : '-'"></span></template>
                            </td>
                            <td @click="handleCellAction(row, 'd_data.vat_local', row.d_data.vat_local)" title="Click to copy, Dbl-click to edit" class="px-3 py-2 whitespace-nowrap text-right font-mono font-bold text-purple-700 dark:text-purple-300 bg-purple-50/20 dark:bg-purple-900/20 cursor-pointer hover:bg-purple-100 dark:hover:bg-purple-900/50">
                                <template x-if="editing.id === row.no && editing.field === 'd_data.vat_local'"><input type="number" step="0.01" x-model="row.d_data.vat_local" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full p-1 text-xs border rounded font-mono text-right dark:bg-gray-700 dark:text-white dark:border-gray-600" autofocus /></template>
                                <template x-if="!(editing.id === row.no && editing.field === 'd_data.vat_local')"><span x-text="row.d_data.vat_local ? formatNumber(row.d_data.vat_local) : '-'"></span></template>
                            </td>
                            <td @click="handleCellAction(row, 'd_data.vat_export', row.d_data.vat_export)" title="Click to copy, Dbl-click to edit" class="px-3 py-2 whitespace-nowrap text-right font-mono font-bold text-indigo-600 dark:text-indigo-400 bg-purple-50/20 dark:bg-purple-900/20 cursor-pointer hover:bg-purple-100 dark:hover:bg-purple-900/50">
                                <template x-if="editing.id === row.no && editing.field === 'd_data.vat_export'"><input type="number" step="0.01" x-model="row.d_data.vat_export" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full p-1 text-xs border rounded font-mono text-right dark:bg-gray-700 dark:text-white dark:border-gray-600" autofocus /></template>
                                <template x-if="!(editing.id === row.no && editing.field === 'd_data.vat_export')"><span x-text="row.d_data.vat_export ? formatNumber(row.d_data.vat_export) : '-'"></span></template>
                            </td>
                            <td @click="handleCellAction(row, 'd_data.state_burden', row.d_data.state_burden)" title="Click to copy, Dbl-click to edit" class="px-3 py-2 whitespace-nowrap text-right font-mono text-gray-500 dark:text-gray-300 bg-purple-50/20 dark:bg-purple-900/20 cursor-pointer hover:bg-purple-100 dark:hover:bg-purple-900/50">
                                <template x-if="editing.id === row.no && editing.field === 'd_data.state_burden'"><input type="number" step="0.01" x-model="row.d_data.state_burden" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full p-1 text-xs border rounded font-mono text-right dark:bg-gray-700 dark:text-white dark:border-gray-600" autofocus /></template>
                                <template x-if="!(editing.id === row.no && editing.field === 'd_data.state_burden')"><span x-text="row.d_data.state_burden ? formatNumber(row.d_data.state_burden) : '-'"></span></template>
                            </td>
                            <td @click="handleCellAction(row, 'd_data.withheld', row.d_data.withheld)" title="Click to copy, Dbl-click to edit" class="px-3 py-2 whitespace-nowrap text-right font-mono text-gray-500 dark:text-gray-300 bg-purple-50/20 dark:bg-purple-900/20 cursor-pointer hover:bg-purple-100 dark:hover:bg-purple-900/50">
                                <template x-if="editing.id === row.no && editing.field === 'd_data.withheld'"><input type="number" step="0.01" x-model="row.d_data.withheld" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full p-1 text-xs border rounded font-mono text-right dark:bg-gray-700 dark:text-white dark:border-gray-600" autofocus /></template>
                                <template x-if="!(editing.id === row.no && editing.field === 'd_data.withheld')"><span x-text="row.d_data.withheld ? formatNumber(row.d_data.withheld) : '-'"></span></template>
                            </td>
                            <td @click="handleCellAction(row, 'd_data.plt', row.d_data.plt)" title="Click to copy, Dbl-click to edit" class="px-3 py-2 whitespace-nowrap text-right font-mono text-gray-500 dark:text-gray-300 bg-purple-50/20 dark:bg-purple-900/20 cursor-pointer hover:bg-purple-100 dark:hover:bg-purple-900/50">
                                <template x-if="editing.id === row.no && editing.field === 'd_data.plt'"><input type="number" step="0.01" x-model="row.d_data.plt" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full p-1 text-xs border rounded font-mono text-right dark:bg-gray-700 dark:text-white dark:border-gray-600" autofocus /></template>
                                <template x-if="!(editing.id === row.no && editing.field === 'd_data.plt')"><span x-text="row.d_data.plt ? formatNumber(row.d_data.plt) : '-'"></span></template>
                            </td>
                            <td @click="handleCellAction(row, 'd_data.spec_goods', row.d_data.spec_goods)" title="Click to copy, Dbl-click to edit" class="px-3 py-2 whitespace-nowrap text-right font-mono text-gray-500 dark:text-gray-300 bg-purple-50/20 dark:bg-purple-900/20 cursor-pointer hover:bg-purple-100 dark:hover:bg-purple-900/50">
                                <template x-if="editing.id === row.no && editing.field === 'd_data.spec_goods'"><input type="number" step="0.01" x-model="row.d_data.spec_goods" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full p-1 text-xs border rounded font-mono text-right dark:bg-gray-700 dark:text-white dark:border-gray-600" autofocus /></template>
                                <template x-if="!(editing.id === row.no && editing.field === 'd_data.spec_goods')"><span x-text="row.d_data.spec_goods ? formatNumber(row.d_data.spec_goods) : '-'"></span></template>
                            </td>
                            <td @click="handleCellAction(row, 'd_data.spec_serv', row.d_data.spec_serv)" title="Click to copy, Dbl-click to edit" class="px-3 py-2 whitespace-nowrap text-right font-mono text-gray-500 dark:text-gray-300 bg-purple-50/20 dark:bg-purple-900/20 cursor-pointer hover:bg-purple-100 dark:hover:bg-purple-900/50">
                                <template x-if="editing.id === row.no && editing.field === 'd_data.spec_serv'"><input type="number" step="0.01" x-model="row.d_data.spec_serv" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full p-1 text-xs border rounded font-mono text-right dark:bg-gray-700 dark:text-white dark:border-gray-600" autofocus /></template>
                                <template x-if="!(editing.id === row.no && editing.field === 'd_data.spec_serv')"><span x-text="row.d_data.spec_serv ? formatNumber(row.d_data.spec_serv) : '-'"></span></template>
                            </td>
                            <td @click="handleCellAction(row, 'd_data.accom', row.d_data.accom)" title="Click to copy, Dbl-click to edit" class="px-3 py-2 whitespace-nowrap text-right font-mono text-gray-500 dark:text-gray-300 bg-purple-50/20 dark:bg-purple-900/20 cursor-pointer hover:bg-purple-100 dark:hover:bg-purple-900/50">
                                <template x-if="editing.id === row.no && editing.field === 'd_data.accom'"><input type="number" step="0.01" x-model="row.d_data.accom" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full p-1 text-xs border rounded font-mono text-right dark:bg-gray-700 dark:text-white dark:border-gray-600" autofocus /></template>
                                <template x-if="!(editing.id === row.no && editing.field === 'd_data.accom')"><span x-text="row.d_data.accom ? formatNumber(row.d_data.accom) : '-'"></span></template>
                            </td>
                            <td @click="handleCellAction(row, 'd_data.redemption', row.d_data.redemption)" title="Click to copy, Dbl-click to edit" class="px-3 py-2 whitespace-nowrap text-right font-mono text-gray-500 dark:text-gray-300 bg-purple-50/20 dark:bg-purple-900/20 cursor-pointer hover:bg-purple-100 dark:hover:bg-purple-900/50">
                                <template x-if="editing.id === row.no && editing.field === 'd_data.redemption'"><input type="number" step="0.01" x-model="row.d_data.redemption" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full p-1 text-xs border rounded font-mono text-right dark:bg-gray-700 dark:text-white dark:border-gray-600" autofocus /></template>
                                <template x-if="!(editing.id === row.no && editing.field === 'd_data.redemption')"><span x-text="row.d_data.redemption ? formatNumber(row.d_data.redemption) : '-'"></span></template>
                            </td>
                            <td @click="handleCellAction(row, 'd_data.notes', row.d_data.notes)" title="Click to copy, Dbl-click to edit" class="px-3 py-2 max-w-[140px] truncate text-gray-500 dark:text-gray-300 bg-purple-50/20 dark:bg-purple-900/20 cursor-pointer hover:bg-purple-100 dark:hover:bg-purple-900/50">
                                <template x-if="editing.id === row.no && editing.field === 'd_data.notes'"><input type="text" x-model="row.d_data.notes" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full p-1 text-xs border rounded dark:bg-gray-700 dark:text-white dark:border-gray-600" autofocus /></template>
                                <template x-if="!(editing.id === row.no && editing.field === 'd_data.notes')"><span x-text="row.d_data.notes || '-'"></span></template>
                            </td>
                            <td @click="handleCellAction(row, 'd_data.desc', row.d_data.desc)" title="Click to copy, Dbl-click to edit" class="px-3 py-2 max-w-[140px] truncate text-gray-500 dark:text-gray-300 bg-purple-50/20 dark:bg-purple-900/20 cursor-pointer hover:bg-purple-100 dark:hover:bg-purple-900/50">
                                <template x-if="editing.id === row.no && editing.field === 'd_data.desc'"><input type="text" x-model="row.d_data.desc" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full p-1 text-xs border rounded dark:bg-gray-700 dark:text-white dark:border-gray-600" autofocus /></template>
                                <template x-if="!(editing.id === row.no && editing.field === 'd_data.desc')"><span x-text="row.d_data.desc || '-'"></span></template>
                            </td>
                            <td @click="handleCellAction(row, 'd_data.dec_status', row.d_data.dec_status)" title="Click to copy, Dbl-click to edit" class="px-3 py-2 whitespace-nowrap bg-purple-50/20 dark:bg-purple-900/20 cursor-pointer hover:bg-purple-100 dark:hover:bg-purple-900/50">
                                <template x-if="editing.id === row.no && editing.field === 'd_data.dec_status'"><input type="text" x-model="row.d_data.dec_status" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full p-1 text-xs border rounded dark:bg-gray-700 dark:text-white dark:border-gray-600" autofocus /></template>
                                <template x-if="!(editing.id === row.no && editing.field === 'd_data.dec_status')">
                                    <span>
                                        <span x-show="row.d_data.dec_status" class="px-2 py-0.5 rounded-full text-[10px] font-bold bg-purple-100 text-purple-700 dark:bg-purple-900/40 dark:text-purple-300" x-text="row.d_data.dec_status"></span>
                                        <span x-show="!row.d_data.dec_status" class="text-gray-300 dark:text-gray-500">-</span>
                                    </span>
                                </template>
                            </td>
                        </tr>
                    </template>

                    <tr x-show="rows.length === 0 && !loading" class="h-64">
                        <td colspan="36" class="text-center text-gray-400">
                            <div class="flex flex-col items-center justify-center gap-2">
                                <svg class="w-12 h-12 text-gray-200 dark:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                <span>No records found for this view.</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div x-show="loading" class="absolute inset-0 bg-white/50 dark:bg-gray-900/50 backdrop-blur-sm flex items-center justify-center z-30">
                <div class="flex items-center gap-3 bg-white dark:bg-gray-800 px-6 py-4 rounded-xl shadow-xl border border-gray-100 dark:border-gray-700">
                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-brand-600"></div>
                    <span class="text-gray-600 dark:text-gray-300 font-medium">Loading Data...</span>
                </div>
            </div>
        </div>

        <button x-show="showScrollTop" x-transition @click="scrollToTop()" class="absolute bottom-20 right-8 z-50 p-3 rounded-full bg-blue-600 hover:bg-blue-700 text-white shadow-xl hover:shadow-2xl transition-all transform hover:-translate-y-1 focus:outline-none" title="Scroll to Top" style="display: none">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
        </button>

        <div x-show="rows.length > 0" class="px-5 py-3 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 flex flex-col sm:flex-row justify-between items-center text-xs text-gray-600 dark:text-gray-300 flex-shrink-0 z-30 gap-2">
            <div class="truncate">Showing <span class="font-bold" x-text="startRecord"></span> to <span class="font-bold" x-text="endRecord"></span> of <span class="font-bold" x-text="formatNumber(totalRows)"></span> results</div>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                    <span class="text-gray-500 hidden sm:inline">Rows:</span>
                    <select x-model="pageSizePreset" @change="handlePageSizeChange()" class="text-xs border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 py-1.5 pl-2 pr-6 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="500">500</option>
                        <option value="1000">1000</option>
                        <option value="custom">Custom</option>
                    </select>
                    <div x-show="pageSizePreset === 'custom'" x-transition class="w-16">
                        <input x-model.number="pageSize" @keydown.enter="changePageSize()" @blur="changePageSize()" type="number" min="1" class="w-full text-xs border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 py-1.5 px-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="#" />
                    </div>
                </div>
                <div class="flex items-center gap-2 border-l border-gray-300 dark:border-gray-600 pl-4">
                    <button @click="changePage(page - 1)" :disabled="page <= 1" class="px-2 py-1.5 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed bg-white dark:bg-gray-700 transition">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <span class="px-2 min-w-[80px] text-center font-medium">Page <span x-text="page"></span> of <span x-text="totalPages"></span></span>
                    <button @click="changePage(page + 1)" :disabled="page >= totalPages" class="px-2 py-1.5 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed bg-white dark:bg-gray-700 transition">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="fixed bottom-10 left-0 right-0 z-50 flex justify-center pointer-events-none">
        <div
            x-show="toastMsg"
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0 translate-y-8 scale-95"
            x-transition:enter-end="opacity-100 translate-y-0 scale-100"
            x-transition:leave="transition ease-in duration-200"
            x-transition:leave-start="opacity-100 translate-y-0 scale-100"
            x-transition:leave-end="opacity-0 translate-y-8 scale-95"
            class="bg-gray-900 dark:bg-gray-100 text-white dark:text-gray-900 px-5 py-3 rounded-xl shadow-2xl text-sm font-bold flex items-center gap-3 pointer-events-auto"
            style="display: none"
        >
            <div class="bg-green-500/20 text-green-400 dark:text-green-600 rounded-full p-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
            </div>
            <span x-text="toastMsg"></span>
        </div>
    </div>
</div>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('resultsDashboard', () => ({
            ovatrCode: '{{ ovatr_code }}',
            rows: [],
            stats: {total: 0, matched: 0, not_found: 0, mismatch: 0, local_count: 0, import_count: 0},
            search: '',
            filter: 'ALL',
            tableType: 'local',
            loading: true,
            isCached: false,
            isSaving: false,
            autoSavePending: 0,
            page: 1,
            pageSize: 50,
            pageSizePreset: '50',
            totalPages: 1,
            totalRows: 0,
            showScrollTop: false,
            showHistoryModal: false,
            historyRowId: null,
            historyLogs: [],
            historyLoading: false,
            historyFilter: '',
            editing: {id: null, field: null},
            history: [],
            historyIndex: -1,
            unsavedChanges: new Set(),
            toastMsg: '',

            clicks: 0,
            clickTimer: null,
            clickDelay: 250,

            // SMART CLICK HANDLERS
            handleCellAction(row, field, textToCopy) {
                if (this.editing.id === row.no && this.editing.field === field) return;

                this.clicks++;
                if (this.clicks === 1) {
                    this.clickTimer = setTimeout(() => {
                        this.clicks = 0;
                        this.copyToClipboard(textToCopy);
                    }, this.clickDelay);
                } else if (this.clicks === 2) {
                    clearTimeout(this.clickTimer);
                    this.clicks = 0;
                    this.editCell(row, field);
                }
            },

            copyToClipboard(text) {
                if (text === null || text === undefined || text === '') return;
                navigator.clipboard.writeText(String(text)).then(() => {
                    this.toastMsg = 'Copied: ' + text;
                    setTimeout(() => {
                        this.toastMsg = '';
                    }, 2000);
                });
            },

            formatDateStr(val) {
                if (!val) return '';
                let s = String(val).trim().split(' ')[0];
                if (s.includes('-')) {
                    let p = s.split('-');
                    if (p.length === 3 && p[0].length === 4) return `${p[2]}-${p[1]}-${p[0]}`;
                    return s;
                }
                if (s.includes('/')) {
                    let p = s.split('/');
                    if (p.length === 3 && p[0].length === 4) return `${p[2]}-${p[1]}-${p[0]}`;
                    if (p.length === 3) return `${p[0]}-${p[1]}-${p[2]}`;
                    return s.replace(/\//g, '-');
                }
                return s;
            },

            async init() {
                this.loadStats();
                await this.fetchData();
            },

            // --- IndexedDB Cache System ---
            openDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('AutoCrosscheck_DB', 1);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('resultsCache')) {
                            db.createObjectStore('resultsCache', {keyPath: 'id'});
                        }
                    };
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            async getLocalCache(key) {
                const db = await this.openDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('resultsCache', 'readonly');
                    const store = tx.objectStore('resultsCache');
                    const req = store.get(key);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            },
            async setLocalCache(key, dataPayload) {
                const db = await this.openDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('resultsCache', 'readwrite');
                    const store = tx.objectStore('resultsCache');
                    store.put({id: key, timestamp: Date.now(), data: dataPayload});
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            },
            async clearLocalCache() {
                const db = await this.openDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('resultsCache', 'readwrite');
                    const store = tx.objectStore('resultsCache');
                    const req = store.clear();
                    req.onsuccess = () => resolve();
                    req.onerror = () => reject(req.error);
                });
            },

            get startRecord() {
                return (this.page - 1) * this.pageSize + 1;
            },
            get endRecord() {
                return Math.min(this.page * this.pageSize, this.totalRows);
            },
            get uniqueHistoryFields() {
                return Array.from(new Set(this.historyLogs.map((l) => l.field))).sort();
            },
            get filteredHistoryLogs() {
                return !this.historyFilter ? this.historyLogs : this.historyLogs.filter((l) => l.field === this.historyFilter);
            },
            get hasUnsavedChanges() {
                return this.unsavedChanges.size > 0;
            },
            get filteredRows() {
                if (!this.search && this.filter === 'ALL') return this.rows;
                const term = this.search.toLowerCase();
                return this.rows.filter((row) => {
                    const matchesSearch = !term || (row.p_desc || '').toLowerCase().includes(term) || (row.p_inv || '').toLowerCase().includes(term) || (row.p_tin || '').toLowerCase().includes(term) || (row.d_data?.invoice_no || '').toLowerCase().includes(term) || (row.d_data?.tin || '').toLowerCase().includes(term);
                    let matchesFilter = false;
                    if (this.filter === 'ALL') matchesFilter = true;
                    else if (this.filter === 'MATCHED') matchesFilter = row.status === 'MATCHED' || row.status === 'SHORTAGE';
                    else matchesFilter = row.status === this.filter;
                    return matchesSearch && matchesFilter;
                });
            },

            async loadStats() {
                if (!this.ovatrCode) return;
                try {
                    const res = await fetch(`{% url "crosscheck:get_stats" %}?ovatr_code=${this.ovatrCode}`);
                    const data = await res.json();
                    if (data.status === 'success') {
                        this.stats.local_count = data.local_count;
                        this.stats.import_count = data.import_count;
                        this.stats.total = data.total_rows;
                    }
                } catch (e) {
                    console.error(e);
                }
            },

            applyData(data) {
                this.rows = data.data.map((r) => {
                    let d = r.d_data || {
                        date: '',
                        invoice_no: '',
                        credit_no: '',
                        buyer_type: '',
                        tin: '',
                        name: '',
                        total_amt: '',
                        excl_vat: '',
                        non_vat: '',
                        vat_0: '',
                        vat_local: '',
                        vat_export: '',
                        state_burden: '',
                        withheld: '',
                        plt: '',
                        spec_goods: '',
                        spec_serv: '',
                        accom: '',
                        redemption: '',
                        notes: '',
                        desc: '',
                        dec_status: '',
                    };

                    d.date = this.formatDateStr(d.date);

                    const newRow = {
                        ...r,
                        d_data: d,
                        _orig_d_inv: r.d_inv,
                        _orig_d_tin: r.d_tin,
                        _orig_d_date: r.d_date,
                        _session_history: {},
                    };
                    this.recalculate(newRow);
                    return newRow;
                });

                let m = 0,
                    nf = 0,
                    mm = 0;
                this.rows.forEach((r) => {
                    if (r.status === 'MATCHED' || r.status === 'SHORTAGE') m++;
                    else if (r.status === 'NOT FOUND') nf++;
                    else if (r.status === 'MISMATCH') mm++;
                });
                this.stats.matched = m;
                this.stats.not_found = nf;
                this.stats.mismatch = mm;

                if (data.pagination) {
                    this.totalPages = data.pagination.total_pages;
                    this.totalRows = data.pagination.total_rows;
                    this.page = data.pagination.current_page;
                }
            },

            async fetchData(forceRefresh = false) {
                if (!this.ovatrCode) return;

                if (!this.isSaving) this.loading = true;
                this.isCached = false;

                const cacheKey = `${this.ovatrCode}_${this.tableType}_${this.page}_${this.pageSize}`;

                if (forceRefresh) {
                    await this.clearLocalCache();
                } else {
                    try {
                        const cached = await this.getLocalCache(cacheKey);
                        if (cached && cached.data) {
                            this.applyData(cached.data);
                            this.isCached = true;
                            this.loading = false;
                            this.scrollToTop();
                            return;
                        }
                    } catch (e) {
                        console.warn('Cache read failed', e);
                    }
                }

                try {
                    const timestamp = new Date().getTime();
                    const url = `{% url "crosscheck:get_results_data" %}?ovatr_code=${this.ovatrCode}&page=${this.page}&page_size=${this.pageSize}&table_type=${this.tableType}&_cb=${timestamp}`;

                    const res = await fetch(url, {
                        headers: {
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            Pragma: 'no-cache',
                            Expires: '0',
                        },
                    });

                    const data = await res.json();

                    if (data.status === 'success') {
                        if (!this.isSaving) this.rows = [];
                        this.applyData(data);

                        const cleanData = JSON.parse(JSON.stringify(data));
                        await this.setLocalCache(cacheKey, cleanData);
                    }
                } catch (e) {
                    console.error(e);
                } finally {
                    this.loading = false;
                    if (!this.isSaving) this.scrollToTop();
                }
            },

            handleScroll(el) {
                this.showScrollTop = el.scrollTop > 200;
            },
            scrollToTop() {
                const el = document.getElementById('tableContainer');
                if (el) el.scrollTo({top: 0, behavior: 'smooth'});
            },
            changePage(newPage) {
                if (newPage < 1 || newPage > this.totalPages) return;
                this.page = newPage;
                this.fetchData();
            },
            handlePageSizeChange() {
                if (this.pageSizePreset !== 'custom') {
                    this.pageSize = parseInt(this.pageSizePreset);
                    this.page = 1;
                    this.fetchData();
                }
            },
            changePageSize() {
                if (this.pageSize > 0) {
                    this.page = 1;
                    this.fetchData();
                }
            },

            pushHistoryAction(rowId, field, oldValue, newValue) {
                if (this.historyIndex < this.history.length - 1) this.history = this.history.slice(0, this.historyIndex + 1);
                this.history.push({rowId, field, oldValue, newValue});
                this.historyIndex++;
                const row = this.rows.find((r) => r.no === rowId);
                if (row) {
                    if (!row._session_history[field]) row._session_history[field] = {old: oldValue, new: newValue};
                    else row._session_history[field].new = newValue;
                }
            },

            setFieldValue(row, field, value) {
                if (field.includes('.')) {
                    const [obj, key] = field.split('.');
                    row[obj][key] = value;
                } else {
                    row[field] = value;
                }
            },

            undo() {
                if (this.historyIndex < 0) return;
                const action = this.history[this.historyIndex];
                const row = this.rows.find((r) => r.no === action.rowId);
                if (row) {
                    this.setFieldValue(row, action.field, action.oldValue);
                    this.recalculate(row);
                    this.autoSaveRow(row);
                }
                this.historyIndex--;
            },
            redo() {
                if (this.historyIndex >= this.history.length - 1) return;
                this.historyIndex++;
                const action = this.history[this.historyIndex];
                const row = this.rows.find((r) => r.no === action.rowId);
                if (row) {
                    this.setFieldValue(row, action.field, action.newValue);
                    this.recalculate(row);
                    this.autoSaveRow(row);
                }
            },

            // --- RESTORE SPECIFIC HISTORY LOG ---
            restoreHistoryValue(log) {
                const row = this.rows.find((r) => r.no === String(this.historyRowId));
                if (!row) {
                    this.toastMsg = 'Row not found in current view.';
                    setTimeout(() => {
                        this.toastMsg = '';
                    }, 3000);
                    return;
                }

                const field = log.field;
                let currentValue;

                if (field.includes('.')) {
                    const [obj, key] = field.split('.');
                    currentValue = row[obj][key];
                } else {
                    currentValue = row[field];
                }

                const restoredValue = log.old_value;

                if (String(currentValue) === String(restoredValue)) {
                    this.toastMsg = 'Value is already set to this.';
                    setTimeout(() => {
                        this.toastMsg = '';
                    }, 2000);
                    return;
                }

                this.setFieldValue(row, field, restoredValue);
                this.pushHistoryAction(row.no, field, currentValue, restoredValue);
                this.recalculate(row);

                this.toastMsg = `Restored ${field}`;
                setTimeout(() => {
                    this.toastMsg = '';
                }, 3000);

                // Run auto-save in background. When it finishes, refresh history modal silently.
                this.autoSaveRow(row).then(() => {
                    if (this.showHistoryModal && String(this.historyRowId) === String(row.no)) {
                        this.viewHistory(row.no, true);
                    }
                });
            },

            editCell(row, field) {
                this.editing = {id: row.no, field};
                if (field.includes('.')) {
                    const [obj, key] = field.split('.');
                    row._originalValue = row[obj][key];
                } else {
                    row._originalValue = row[field];
                }
                this.$nextTick(() => {
                    const input = this.$el.querySelector('input');
                    if (input) input.focus();
                });
            },

            stopEdit(row) {
                if (this.editing.id === null) return;
                const field = this.editing.field;
                let newValue;
                if (field.includes('.')) {
                    const [obj, key] = field.split('.');
                    newValue = row[obj][key];
                } else {
                    newValue = row[field];
                }
                const oldValue = row._originalValue;
                if (newValue != oldValue) {
                    this.pushHistoryAction(row.no, field, oldValue, newValue);
                    this.recalculate(row);
                    this.autoSaveRow(row);
                }
                this.editing = {id: null, field: null};
            },

            cleanInvoice(val) {
                return !val ? '' : String(val).replace(/[^a-zA-Z0-9]/g, '');
            },

            recalculate(row) {
                if (this.editing.field !== 'p_inv_clean') row.p_inv_clean = this.cleanInvoice(row.p_inv);
                row.d_inv_clean = this.cleanInvoice(row.d_data ? row.d_data.invoice_no : row.d_inv);

                const d_amt_val = this.tableType === 'local' ? row.d_data?.vat_local : row.d_data?.vat_export;
                const p_amt = parseFloat(row.p_amt) || 0;
                const d_amt = parseFloat(row.d_data ? d_amt_val : row.d_amt) || 0;
                const diff = p_amt - d_amt;
                row.v_diff = diff;

                row.v_inv = row.p_inv_clean !== '' && row.d_inv_clean !== '' && row.p_inv_clean === row.d_inv_clean;
                const O = row.v_inv;
                const P = row.v_date;
                const Q = row.v_tin;

                if (O && P && Q) {
                    row.status = diff < -0.05 ? 'SHORTAGE' : 'MATCHED';
                } else if (!O && !P && !Q) {
                    row.status = 'NOT FOUND';
                } else {
                    row.status = 'MISMATCH';
                }
            },

            statusText(st) {
                if (st === 'MATCHED') return 'បានប្រកាស (អនុញ្ញាត)';
                if (st === 'SHORTAGE') return 'អនុញ្ញាត (អ្នកផ្គត់ផ្គង់ប្រកាសខ្វះ)';
                if (st === 'NOT FOUND') return 'ព្យួរទុក (មិនមានទិន្នន័យ)';
                if (st === 'MISMATCH') return 'ប្រកាសខុស (ព្យួរទុក)';
                return st;
            },

            // --- AUTO-SAVE LOGIC ---
            async autoSaveRow(row) {
                this.autoSavePending++;
                this.isSaving = true;

                try {
                    const payload = {
                        ovatr: this.ovatrCode,
                        type: this.tableType,
                        no: String(row.no),
                        updates: {
                            p_desc: row.p_desc,
                            p_supp: row.p_supp,
                            p_inv: row.p_inv,
                            p_date: row.p_date,
                            p_amt: row.p_amt,
                            p_tin: row.p_tin,
                            d_inv: row.d_data.invoice_no,
                            d_tin: row.d_data.tin,
                            d_name: row.d_data.name,
                            d_date: row.d_data.date,
                            d_amt: row.d_data.total_amt,
                            d_data: row.d_data,
                            original_d_inv: row._orig_d_inv,
                            original_d_tin: row._orig_d_tin,
                            original_d_date: row._orig_d_date,
                        },
                        history: row._session_history,
                    };

                    const response = await fetch('{% url "crosscheck:update_result_row" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
                        },
                        body: JSON.stringify(payload),
                    });

                    if (!response.ok) {
                        const err = await response.text();
                        throw new Error(err);
                    }
                    const resJson = await response.json();
                    if (resJson.status !== 'success') {
                        throw new Error(resJson.message);
                    }

                    row._session_history = {};
                    row._orig_d_inv = row.d_data.invoice_no;
                    row._orig_d_tin = row.d_data.tin;
                    row._orig_d_date = row.d_data.date;

                    await this.clearLocalCache();
                    await this.fetchData(true);
                } catch (e) {
                    console.error('Auto-save failed', e);
                    this.toastMsg = 'Failed to save edit: ' + e.message.substring(0, 50);
                    setTimeout(() => {
                        this.toastMsg = '';
                    }, 4000);
                } finally {
                    this.autoSavePending--;
                    if (this.autoSavePending <= 0) {
                        this.autoSavePending = 0;
                        this.isSaving = false;
                        this.unsavedChanges.clear();
                    }
                }
            },

            async saveChanges() {
                if (this.unsavedChanges.size === 0) return;
                const dirtyRows = this.rows.filter((r) => this.unsavedChanges.has(r.no));
                for (const row of dirtyRows) {
                    await this.autoSaveRow(row);
                }
            },

            async viewHistory(rowId, silent = false) {
                this.historyRowId = rowId;
                if (!silent) {
                    this.historyLogs = [];
                    this.historyFilter = '';
                    this.showHistoryModal = true;
                }
                this.historyLoading = true;
                try {
                    const res = await fetch(`{% url "crosscheck:get_row_history" %}?ovatr=${this.ovatrCode}&no=${rowId}`);
                    const data = await res.json();
                    if (data.status === 'success') {
                        this.historyLogs = data.data;
                    }
                } catch (e) {
                    console.error(e);
                } finally {
                    this.historyLoading = false;
                }
            },

            switchTable(type) {
                if (this.tableType === type) return;
                this.tableType = type;
                this.page = 1;
                this.rows = [];
                this.history = [];
                this.historyIndex = -1;
                this.unsavedChanges.clear();
                this.fetchData();
            },

            downloadFile() {
                window.location.href = "{% url 'crosscheck:download_report' %}?ovatr_code=" + this.ovatrCode;
            },
            formatNumber(num) {
                return new Intl.NumberFormat('en-US').format(num);
            },
        }));
    });
</script>
{% endblock %}
