{% extends 'base.html' %} {% load static %} {% block title %}Session Results{% endblock %} {% block content %}

<style>
    .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
        border: 2px solid transparent;
        background-clip: padding-box;
    }
    .dark .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #475569;
        border: 2px solid transparent;
        background-clip: padding-box;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
        border: 2px solid transparent;
        background-clip: padding-box;
    }
    .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #64748b;
        border: 2px solid transparent;
        background-clip: padding-box;
    }
    thead.sticky-header th {
        position: sticky;
        top: 0;
        z-index: 20;
    }
    .sticky-group {
        position: sticky;
        top: 0;
        z-index: 30;
    }

    input[type='number']::-webkit-inner-spin-button,
    input[type='number']::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    /* Smooth transition for table rows */
    .table-row-hover {
        transition: background-color 0.15s ease-in-out;
    }
</style>

<div x-data="resultsDashboard()" x-init="init()" class="h-[calc(113vh-1rem)] flex flex-col relative overflow-hidden bg-slate-50 dark:bg-[#0f172a] text-slate-800 dark:text-slate-200">
    <meta name="csrf-token" content="{{ csrf_token }}" />

    <div x-show="showHistoryModal" @keydown.escape.window="showHistoryModal = false" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm" style="display: none" x-transition.opacity>
        <div @click.outside="showHistoryModal = false" class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-4xl p-6 relative flex flex-col max-h-[85vh] border border-slate-200 dark:border-slate-700">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h3 class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
                    <svg class="w-5 h-5 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    Edit History - Row <span x-text="historyRowId" class="text-indigo-500"></span>
                </h3>
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-slate-500">Filter:</span>
                        <select x-model="historyFilter" class="text-xs border-slate-300 rounded-lg shadow-sm py-1.5 pl-3 pr-8 focus:border-indigo-500 focus:ring focus:ring-indigo-500/20 dark:bg-slate-900 dark:border-slate-600 dark:text-white transition-all">
                            <option value="">All Fields</option>
                            <template x-for="field in uniqueHistoryFields" :key="field"><option :value="field" x-text="field"></option></template>
                        </select>
                    </div>
                    <button @click="showHistoryModal = false" class="text-slate-400 hover:text-slate-700 dark:hover:text-white transition-colors bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 p-1.5 rounded-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            </div>

            <div class="overflow-y-auto border border-slate-200 dark:border-slate-700 rounded-xl flex-1 custom-scrollbar bg-slate-50 dark:bg-slate-900/50">
                <template x-if="historyLoading"><div class="text-center py-10 text-xs text-slate-500 animate-pulse">Loading history logs...</div></template>
                <template x-if="!historyLoading && filteredHistoryLogs.length === 0"><div class="text-center py-10 text-xs text-slate-500">No edits recorded matching this filter.</div></template>
                <table x-show="!historyLoading && filteredHistoryLogs.length > 0" class="w-full text-xs text-left text-slate-600 dark:text-slate-300">
                    <thead class="text-[10px] text-slate-500 uppercase bg-slate-100 dark:bg-slate-800/80 sticky top-0 shadow-sm z-10 backdrop-blur-md">
                        <tr>
                            <th class="px-4 py-3 w-36 tracking-wider font-semibold">Time</th>
                            <th class="px-4 py-3 w-36 tracking-wider font-semibold">Modified Field</th>
                            <th class="px-4 py-3 text-rose-500 tracking-wider font-semibold">Old Value</th>
                            <th class="px-4 py-3 text-emerald-500 tracking-wider font-semibold">New Value</th>
                            <th class="px-4 py-3 w-24 text-center tracking-wider font-semibold">Action</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-200 dark:divide-slate-700/50">
                        <template x-for="log in filteredHistoryLogs" :key="log.timestamp + log.field">
                            <tr class="hover:bg-white dark:hover:bg-slate-800 transition-colors group">
                                <td class="px-4 py-3 whitespace-nowrap text-[10px] text-slate-400 font-mono" x-text="log.timestamp"></td>
                                <td class="px-4 py-3 font-mono font-medium text-slate-700 dark:text-slate-200" x-text="log.field"></td>
                                <td class="px-4 py-3 text-rose-500 line-through decoration-rose-500/30" x-text="log.old_value"></td>
                                <td class="px-4 py-3 text-emerald-500 font-medium" x-text="log.new_value"></td>
                                <td class="px-4 py-3 text-center">
                                    <button @click="restoreHistoryValue(log)" class="px-3 py-1.5 bg-indigo-50 text-indigo-600 border border-indigo-200 hover:bg-indigo-600 hover:text-white dark:bg-indigo-500/10 dark:border-indigo-500/20 dark:text-indigo-400 dark:hover:bg-indigo-500 dark:hover:text-white rounded-lg text-[10px] font-bold uppercase tracking-wider transition-all shadow-sm">
                                        Restore
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div x-show="showStatusModal" @keydown.escape.window="showStatusModal = false" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm" style="display: none" x-transition.opacity>
        <div @click.outside="showStatusModal = false" class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-5xl p-6 relative flex flex-col max-h-[85vh] border border-slate-200 dark:border-slate-700">
            <div class="flex justify-between items-start mb-5 flex-shrink-0">
                <div>
                    <h3 class="text-xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                        <svg class="w-6 h-6 text-fuchsia-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                            ></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Manage User Statuses
                    </h3>
                    <p class="text-[11px] text-slate-500 mt-1.5">Define custom status labels and map them to Excel Report formulas (COUNTIF/SUMIF).</p>
                </div>
                <button @click="showStatusModal = false" class="text-slate-400 hover:text-slate-700 dark:hover:text-white transition-colors bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 p-1.5 rounded-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div class="overflow-y-auto border border-slate-200 dark:border-slate-700 rounded-xl flex-1 custom-scrollbar mb-5 bg-slate-50 dark:bg-slate-900/50">
                <table class="w-full text-xs text-left text-slate-600 dark:text-slate-300">
                    <thead class="text-[10px] text-slate-500 uppercase bg-slate-100 dark:bg-slate-800/80 sticky top-0 shadow-sm z-10 backdrop-blur-md tracking-wider font-semibold">
                        <tr>
                            <th class="px-4 py-3 w-1/4">Status (Dropdown)</th>
                            <th class="px-4 py-3 w-1/3">Summary Text (Footer)</th>
                            <th class="px-4 py-3 w-1/5">Action (Col E)</th>
                            <th class="px-4 py-3 w-1/5 text-center">Color Tag</th>
                            <th class="px-4 py-3 w-12 text-center"></th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-200 dark:divide-slate-700/50">
                        <template x-for="(status, index) in availableStatuses" :key="index">
                            <tr class="hover:bg-white dark:hover:bg-slate-800/80 transition-colors group">
                                <td class="px-4 py-3 font-semibold text-slate-800 dark:text-slate-100" x-text="status.name"></td>
                                <td class="px-4 py-3 text-slate-500 dark:text-slate-400" x-text="status.summary"></td>
                                <td class="px-4 py-3 font-mono text-slate-500 dark:text-slate-400 text-[11px]" x-text="status.action"></td>
                                <td class="px-4 py-3 text-center"><span class="px-3 py-1 rounded-md text-[10px] font-bold border shadow-sm" :class="getStatusColor(status.name)" x-text="status.color.toUpperCase()"></span></td>
                                <td class="px-4 py-3 text-center">
                                    <button @click="deleteStatus(index)" class="text-slate-400 hover:text-rose-500 bg-white hover:bg-rose-50 dark:bg-slate-800 dark:hover:bg-rose-500/10 p-1.5 rounded-lg opacity-0 group-hover:opacity-100 transition-all border border-transparent hover:border-rose-200 dark:hover:border-rose-500/30">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <div class="bg-indigo-50/50 dark:bg-indigo-900/10 p-5 rounded-xl border border-indigo-100 dark:border-indigo-500/20">
                <h4 class="text-xs font-bold text-indigo-800 dark:text-indigo-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg> Add New Configuration
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                    <div class="col-span-3">
                        <label class="block text-[10px] font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1.5">New Status</label>
                        <input type="text" x-model="newStatus.name" class="w-full px-3 py-2 text-xs border border-slate-300 rounded-lg dark:bg-slate-900 dark:text-white dark:border-slate-600 focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500 transition-all shadow-sm" placeholder="e.g. ព្យួរទុក (មិនមានទិន្នន័យ)" />
                    </div>
                    <div class="col-span-4">
                        <label class="block text-[10px] font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1.5">Report Summary</label>
                        <input type="text" x-model="newStatus.summary" class="w-full px-3 py-2 text-xs border border-slate-300 rounded-lg dark:bg-slate-900 dark:text-white dark:border-slate-600 focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500 transition-all shadow-sm" placeholder="e.g. ចំនួនប្រាក់អាករដែលមិនមានទិន្នន័យ" />
                    </div>
                    <div class="col-span-2">
                        <label class="block text-[10px] font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1.5">Action (Col E)</label>
                        <select x-model="newStatus.action" class="w-full px-3 py-2 text-xs border border-slate-300 rounded-lg dark:bg-slate-900 dark:text-white dark:border-slate-600 focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500 transition-all shadow-sm cursor-pointer">
                            <option value="" disabled>Select action...</option>
                            <option value="គួរអនុញ្ញាត">គួរអនុញ្ញាត</option>
                            <option value="ព្យួរទុក">ព្យួរទុក</option>
                        </select>
                    </div>
                    <div class="col-span-3 flex items-end gap-3">
                        <div class="flex-1">
                            <label class="block text-[10px] font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1.5">Color</label>
                            <select
                                x-model="newStatus.color"
                                @keydown.enter="saveNewStatus()"
                                class="w-full px-3 py-2 text-xs border border-slate-300 rounded-lg dark:bg-slate-900 dark:text-white dark:border-slate-600 focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500 transition-all shadow-sm font-bold"
                                :class="{'text-emerald-600 dark:text-emerald-400': newStatus.color==='green', 'text-amber-500 dark:text-amber-400': newStatus.color==='orange', 'text-rose-500 dark:text-rose-400': newStatus.color==='red', 'text-blue-500 dark:text-blue-400': newStatus.color==='blue'}"
                            >
                                <option value="green" class="text-emerald-600 font-bold">Green</option>
                                <option value="orange" class="text-amber-500 font-bold">Orange</option>
                                <option value="red" class="text-rose-500 font-bold">Red</option>
                                <option value="blue" class="text-blue-500 font-bold">Blue</option>
                            </select>
                        </div>
                        <button @click="saveNewStatus()" :disabled="!newStatus.name || !newStatus.summary" class="px-5 py-2 bg-gradient-to-r from-indigo-600 to-violet-600 text-white text-xs font-bold rounded-lg hover:from-indigo-500 hover:to-violet-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-lg shadow-indigo-500/30 h-[36px]">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="flex flex-col md:flex-row justify-between items-center mb-3 flex-shrink-0 px-4 pt-4 pb-2">
        <div>
            <h1 class="text-3xl font-extrabold text-slate-900 dark:text-white flex items-center gap-3 tracking-tight">
                Session Results
                <span x-show="isCached" class="px-2.5 text-[10px] bg-emerald-500/10 text-emerald-600 dark:text-emerald-400 border border-emerald-500/20 rounded-lg font-bold uppercase tracking-wider ring-1 ring-inset ring-emerald-500/20 shadow-sm" style="display: none">Cached</span>
            </h1>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Review and resolve data anomalies.</p>
        </div>

        <div class="flex gap-2.5 mt-3 md:mt-0 items-center">
            <div x-show="ovatrCode" x-transition class="hidden md:flex items-center gap-2 bg-indigo-500/10 border border-indigo-500/20 px-3 py-1 rounded-lg shadow-inner ring-1 ring-inset ring-indigo-500/20 mr-1 h-[30px]">
                <span class="text-[10px] font-bold text-indigo-600 dark:text-indigo-400 uppercase tracking-widest opacity-80">Session ID</span>
                <span class="text-xs font-mono font-bold text-indigo-700 dark:text-indigo-300 leading-none" x-text="ovatrCode"></span>
                <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse ml-1 shadow-[0_0_8px_rgba(16,185,129,0.8)]"></div>
            </div>

            <div class="flex bg-white dark:bg-slate-800 rounded-lg p-1 mr-2 shadow-sm border border-slate-200 dark:border-slate-700 h-[30px] items-center">
                <button @click="undo()" :disabled="historyIndex < 0" class="p-1 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 disabled:opacity-30 transition-all text-slate-600 dark:text-slate-300" title="Undo">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" /></svg>
                </button>
                <div class="w-px h-4 bg-slate-200 dark:bg-slate-700 self-center mx-0.5"></div>
                <button @click="redo()" :disabled="historyIndex >= history.length - 1" class="p-1 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 disabled:opacity-30 transition-all text-slate-600 dark:text-slate-300" title="Redo">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6" /></svg>
                </button>
            </div>

            <div
                class="px-3 py-1.5 text-[11px] font-bold rounded-lg shadow-sm transition-all flex items-center gap-2 border bg-white dark:bg-slate-800 h-[30px]"
                :class="isSaving ? 'text-amber-600 border-amber-200 dark:border-amber-500/30 dark:text-amber-400 ring-1 ring-inset ring-amber-500/10' : 'text-emerald-600 border-emerald-200 dark:border-emerald-500/30 dark:text-emerald-400 ring-1 ring-inset ring-emerald-500/10'"
            >
                <svg x-show="isSaving" class="animate-spin h-3.5 w-3.5" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <svg x-show="!isSaving" class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                <span x-text="isSaving ? 'Syncing...' : 'Saved'"></span>
            </div>

            <button @click="refreshData()" class="px-3.5 py-1.5 text-xs font-bold text-slate-700 dark:text-slate-200 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors flex items-center gap-1.5 h-[30px]">
                <svg class="w-3.5 h-3.5 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                Refresh
            </button>

            <button @click="goToReport()" class="px-4 py-1.5 text-xs font-bold text-white bg-gradient-to-r from-indigo-600 to-violet-600 rounded-lg shadow-lg shadow-indigo-500/20 hover:shadow-indigo-500/40 hover:from-indigo-500 hover:to-violet-500 transition-all flex items-center gap-1.5 ring-1 ring-inset ring-white/20 h-[30px]">
                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" /></svg> Final Report
            </button>

            <button @click="downloadFile()" class="px-4 py-1.5 text-xs font-bold text-white bg-gradient-to-r from-sky-600 to-blue-600 rounded-lg shadow-lg shadow-blue-500/20 hover:shadow-blue-500/40 hover:from-sky-500 hover:to-blue-500 transition-all flex items-center gap-1.5 ring-1 ring-inset ring-white/20 h-[30px]">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg> Export
            </button>
        </div>
    </div>

    <div class="flex overflow-x-auto custom-scrollbar gap-3 mb-3 pb-2 flex-shrink-0 px-4">
        <div class="p-3 rounded-xl shadow-[0_4px_15px_-3px_rgba(0,0,0,0.1)] dark:shadow-[0_4px_20px_-4px_rgba(0,0,0,0.4)] border bg-white dark:bg-gradient-to-br dark:from-slate-800 dark:to-slate-900 border-slate-200 dark:border-slate-700/80 min-w-[150px] flex-shrink-0 relative overflow-hidden group">
            <div class="absolute -right-6 -top-6 w-16 h-16 bg-slate-500/10 rounded-full blur-xl transition-all"></div>
            <div class="text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest">Total Rows</div>
            <div class="text-2xl font-black text-slate-800 dark:text-white leading-none mt-1.5 tracking-tight" x-text="formatNumber(stats.total)">0</div>
            <div class="flex gap-2.5 mt-2 text-[10px] font-mono text-slate-400 dark:text-slate-500">
                <span>L: <span x-text="stats.local_count || 0" class="text-slate-600 dark:text-slate-300"></span></span>
                <span>I: <span x-text="stats.import_count || 0" class="text-slate-600 dark:text-slate-300"></span></span>
            </div>
        </div>

        <template x-for="stat in orderedStats" :key="stat.name">
            <div class="p-3 rounded-xl border min-w-[170px] flex-shrink-0 flex flex-col justify-between relative overflow-hidden group transition-all duration-300" :class="getStatusBoxColor(stat.name)">
                <div class="absolute -right-8 -top-8 w-24 h-24 rounded-full blur-2xl opacity-40 transition-all duration-500 group-hover:opacity-60" :class="getAmbientGlow(stat.name)"></div>

                <div class="relative z-10 text-[11px] font-bold tracking-wide truncate drop-shadow-sm" x-text="stat.name" :title="stat.name"></div>
                <div class="relative z-10 text-2xl font-black leading-none mt-1.5 tracking-tight drop-shadow-sm" x-text="formatNumber(stat.count)">0</div>
            </div>
        </template>
    </div>

    <div class="flex-1 mx-4 mb-4 bg-white dark:bg-[#111827] rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-800 flex flex-col overflow-hidden relative group/table min-h-0 z-0">
        <div class="p-2.5 border-b border-slate-200 dark:border-slate-800 flex flex-col md:flex-row justify-between items-center bg-slate-50/80 dark:bg-slate-900/80 backdrop-blur-md flex-shrink-0 gap-3 z-10">
            <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto items-center">
                <div class="relative w-full md:w-56">
                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </span>
                    <input type="text" x-model="search" placeholder="Search invoices, TIN..." class="pl-9 w-full rounded-lg border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 dark:text-white text-xs py-1.5 shadow-sm focus:ring-2 focus:ring-indigo-500/40 focus:border-indigo-500 transition-all" />
                </div>
                <div class="flex bg-slate-200/50 dark:bg-slate-800 p-0.5 rounded-lg border border-slate-200 dark:border-slate-700 shadow-inner">
                    <button @click="switchTable('local')" class="px-4 py-1 rounded-md text-[11px] font-bold transition-all duration-200" :class="tableType === 'local' ? 'bg-white dark:bg-slate-600 shadow-sm text-indigo-600 dark:text-white ring-1 ring-slate-900/5 dark:ring-white/10' : 'text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-slate-200'">Local</button>
                    <button @click="switchTable('import')" class="px-4 py-1 rounded-md text-[11px] font-bold transition-all duration-200" :class="tableType === 'import' ? 'bg-white dark:bg-slate-600 shadow-sm text-indigo-600 dark:text-white ring-1 ring-slate-900/5 dark:ring-white/10' : 'text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-slate-200'">Import</button>
                </div>
            </div>

            <div class="flex gap-3 text-[11px] font-bold items-center">
                <button @click="showStatusModal = true" class="px-3 py-1.5 text-indigo-600 dark:text-indigo-400 bg-indigo-50/50 hover:bg-indigo-100 dark:bg-indigo-500/10 dark:hover:bg-indigo-500/20 rounded-lg border border-indigo-200/50 dark:border-indigo-500/20 transition-all flex items-center gap-1.5 shadow-sm">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                        ></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    Manage
                </button>
                <div class="w-px h-5 bg-slate-300 dark:bg-slate-700 mx-0.5"></div>

                <div class="flex items-center gap-2">
                    <span class="text-[10px] text-slate-500 dark:text-slate-400 font-semibold uppercase tracking-widest">Filter:</span>
                    <select x-model="filter" class="w-64 px-3 py-1.5 rounded-lg border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 dark:text-white shadow-sm focus:ring-2 focus:ring-indigo-500/40 focus:border-indigo-500 text-[11px] font-bold transition-all cursor-pointer">
                        <option value="ALL">All Statuses</option>
                        <template x-for="stat in orderedStats" :key="stat.name">
                            <option :value="stat.name" x-text="stat.name + ' (' + formatNumber(stat.count) + ')'"></option>
                        </template>
                    </select>
                </div>
            </div>
        </div>

        <div class="flex-1 relative flex flex-col min-h-0 w-full">
            <div class="flex-1 overflow-auto w-full scroll-smooth custom-scrollbar" id="tableContainer" @scroll="handleScroll($el)">
                <table class="w-full text-[11px] text-left text-slate-600 dark:text-slate-300 border-separate border-spacing-0">
                    <thead class="text-[10px] text-slate-100 uppercase sticky-group z-30">
                        <tr class="h-7 shadow-md">
                            <th class="sticky left-0 z-40 bg-slate-200 dark:bg-slate-900 border-b border-r border-slate-300 dark:border-slate-800 w-12"></th>

                            <th colspan="9" class="bg-gradient-to-r from-blue-700 to-indigo-800 text-center border-b border-r border-blue-900/50 py-1.5 font-bold tracking-widest shadow-inner relative overflow-hidden">
                                <div class="absolute inset-0 bg-white/5 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4xKSIvPjwvc3ZnPg==')] opacity-30"></div>
                                <span class="relative z-10 text-blue-50 drop-shadow-md">Purchase Invoice</span>
                            </th>

                            <th colspan="6" class="bg-gradient-to-r from-orange-600 to-red-700 text-center border-b border-r border-red-900/50 py-1.5 font-bold tracking-widest shadow-inner relative overflow-hidden">
                                <div class="absolute inset-0 bg-white/5 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4xKSIvPjwvc3ZnPg==')] opacity-30"></div>
                                <span class="relative z-10 text-orange-50 drop-shadow-md">Validation</span>
                            </th>

                            <th colspan="22" class="bg-gradient-to-r from-purple-700 to-fuchsia-800 text-center border-b border-purple-900/50 py-1.5 font-bold tracking-widest shadow-inner relative overflow-hidden">
                                <div class="absolute inset-0 bg-white/5 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4xKSIvPjwvc3ZnPg==')] opacity-30"></div>
                                <span class="relative z-10 text-purple-50 drop-shadow-md">Tax Declaration (Matched)</span>
                            </th>
                        </tr>

                        <tr class="bg-slate-100 dark:bg-[#1e293b] border-b border-slate-300 dark:border-slate-700 leading-tight text-slate-600 dark:text-slate-400">
                            <th class="px-2 py-2 sticky left-0 z-40 bg-slate-100 dark:bg-[#1e293b] border-r border-b border-slate-300 dark:border-slate-700 shadow-[2px_0_10px_-3px_rgba(0,0,0,0.2)] w-12 text-center">No</th>

                            <th class="px-2 py-2 text-center whitespace-nowrap border-b border-slate-300 dark:border-slate-700 bg-slate-50 dark:bg-[#1e293b]/50 min-w-[180px] max-w-[250px]">Description</th>
                            <th class="px-2 py-2 text-center whitespace-nowrap border-b border-slate-300 dark:border-slate-700 bg-slate-50 dark:bg-[#1e293b]/50 min-w-[250px] max-w-[300px]">Supplier</th>
                            <th class="px-2 py-2 text-center whitespace-nowrap border-b border-slate-300 dark:border-slate-700 bg-slate-50 dark:bg-[#1e293b]/50">TIN</th>
                            <th class="px-2 py-2 text-center whitespace-nowrap border-b border-slate-300 dark:border-slate-700 bg-slate-50 dark:bg-[#1e293b]/50">Invoice #</th>
                            <th class="px-2 py-2 text-center whitespace-nowrap border-b border-slate-300 dark:border-slate-700 bg-slate-50 dark:bg-[#1e293b]/50">Date</th>
                            <th class="px-2 py-2 text-center whitespace-nowrap border-b border-slate-300 dark:border-slate-700 bg-slate-50 dark:bg-[#1e293b]/50 font-bold min-w-[75px]">Amount</th>
                            <th class="px-2 py-2 text-center border-b border-slate-300 dark:border-slate-700 bg-slate-50 dark:bg-[#1e293b]/50 font-bold min-w-[180px]">System Status</th>
                            <th class="px-2 py-2 text-center border-b border-slate-300 dark:border-slate-700 bg-slate-50 dark:bg-[#1e293b]/50 border-r dark:border-r-slate-700 font-bold min-w-[250px] text-indigo-600 dark:text-indigo-400">User Status</th>
                            <th class="px-2 py-2 text-center border-b border-slate-300 dark:border-slate-700 bg-slate-50 dark:bg-[#1e293b]/50 border-r dark:border-r-slate-700 font-bold min-w-[200px]">Comment</th>

                            <th class="px-2 py-2 text-center border-b border-slate-300 dark:border-slate-700 whitespace-nowrap bg-orange-50/50 dark:bg-[#1e293b]/30">P-Clean</th>
                            <th class="px-2 py-2 text-center border-b border-slate-300 dark:border-slate-700 whitespace-nowrap bg-orange-50/50 dark:bg-[#1e293b]/30">D-Clean</th>
                            <th class="px-2 py-2 text-center border-b border-slate-300 dark:border-slate-700 whitespace-nowrap bg-orange-50/50 dark:bg-[#1e293b]/30">Inv</th>
                            <th class="px-2 py-2 text-center border-b border-slate-300 dark:border-slate-700 whitespace-nowrap bg-orange-50/50 dark:bg-[#1e293b]/30">Date</th>
                            <th class="px-2 py-2 text-center border-b border-slate-300 dark:border-slate-700 whitespace-nowrap bg-orange-50/50 dark:bg-[#1e293b]/30">TIN</th>
                            <th class="px-2 py-2 text-center border-b border-slate-300 dark:border-slate-700 whitespace-nowrap bg-orange-50/50 dark:bg-[#1e293b]/30 border-r dark:border-r-slate-700 font-bold">Diff</th>

                            <th class="px-2 py-2 whitespace-nowrap border-b border-slate-300 dark:border-slate-700 bg-purple-50/30 dark:bg-[#1e293b]/20">Date</th>
                            <th class="px-2 py-2 whitespace-nowrap border-b border-slate-300 dark:border-slate-700 bg-purple-50/30 dark:bg-[#1e293b]/20">Invoice #</th>
                            <th class="px-2 py-2 whitespace-nowrap border-b border-slate-300 dark:border-slate-700 bg-purple-50/30 dark:bg-[#1e293b]/20">Credit No</th>
                            <th class="px-2 py-2 whitespace-nowrap border-b border-slate-300 dark:border-slate-700 bg-purple-50/30 dark:bg-[#1e293b]/20">Buyer Type</th>
                            <th class="px-2 py-2 whitespace-nowrap border-b border-slate-300 dark:border-slate-700 bg-purple-50/30 dark:bg-[#1e293b]/20">TIN</th>
                            <th class="px-2 py-2 whitespace-nowrap border-b border-slate-300 dark:border-slate-700 bg-purple-50/30 dark:bg-[#1e293b]/20">Buyer / Name</th>
                            <th class="px-2 py-2 whitespace-nowrap border-b border-slate-300 dark:border-slate-700 text-center bg-purple-50/30 dark:bg-[#1e293b]/20 font-bold min-w-[150px]">Total Amt</th>
                            <th class="px-2 py-2 whitespace-nowrap border-b border-slate-300 dark:border-slate-700 text-center bg-purple-50/30 dark:bg-[#1e293b]/20 min-w-[120px]">Excl VAT</th>
                            <th class="px-2 py-2 whitespace-nowrap border-b border-slate-300 dark:border-slate-700 text-center bg-purple-50/30 dark:bg-[#1e293b]/20 min-w-[120px]">Non VAT</th>
                            <th class="px-2 py-2 whitespace-nowrap border-b border-slate-300 dark:border-slate-700 text-center bg-purple-50/30 dark:bg-[#1e293b]/20 min-w-[120px]">VAT 0</th>
                            <th class="px-2 py-2 whitespace-nowrap border-b border-slate-300 dark:border-slate-700 text-center bg-purple-50/30 dark:bg-[#1e293b]/20 font-bold min-w-[120px]">VAT Local</th>
                            <th class="px-2 py-2 whitespace-nowrap border-b border-slate-300 dark:border-slate-700 text-center bg-purple-50/30 dark:bg-[#1e293b]/20 font-bold min-w-[120px]">VAT Export</th>
                            <th class="px-2 py-2 whitespace-nowrap border-b border-slate-300 dark:border-slate-700 text-center bg-purple-50/30 dark:bg-[#1e293b]/20 min-w-[120px]">State Burden</th>
                            <th class="px-2 py-2 whitespace-nowrap border-b border-slate-300 dark:border-slate-700 text-center bg-purple-50/30 dark:bg-[#1e293b]/20 min-w-[120px]">Withheld</th>
                            <th class="px-2 py-2 whitespace-nowrap border-b border-slate-300 dark:border-slate-700 text-center bg-purple-50/30 dark:bg-[#1e293b]/20 min-w-[120px]">PLT</th>
                            <th class="px-2 py-2 whitespace-nowrap border-b border-slate-300 dark:border-slate-700 text-center bg-purple-50/30 dark:bg-[#1e293b]/20 min-w-[120px]">Spec Goods</th>
                            <th class="px-2 py-2 whitespace-nowrap border-b border-slate-300 dark:border-slate-700 text-center bg-purple-50/30 dark:bg-[#1e293b]/20 min-w-[120px]">Spec Serv</th>
                            <th class="px-2 py-2 whitespace-nowrap border-b border-slate-300 dark:border-slate-700 text-center bg-purple-50/30 dark:bg-[#1e293b]/20 min-w-[120px]">Accom</th>
                            <th class="px-2 py-2 whitespace-nowrap border-b border-slate-300 dark:border-slate-700 text-center bg-purple-50/30 dark:bg-[#1e293b]/20 min-w-[120px]">Redemption</th>
                            <th class="px-2 py-2 whitespace-nowrap border-b border-slate-300 dark:border-slate-700 bg-purple-50/30 dark:bg-[#1e293b]/20">Notes</th>
                            <th class="px-2 py-2 whitespace-nowrap border-b border-slate-300 dark:border-slate-700 bg-purple-50/30 dark:bg-[#1e293b]/20">Desc</th>
                            <th class="px-2 py-2 whitespace-nowrap border-b border-slate-300 dark:border-slate-700 bg-purple-50/30 dark:bg-[#1e293b]/20">Dec Status</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 dark:divide-slate-800 bg-white dark:bg-[#0b1121]">
                        <template x-for="row in filteredRows" :key="row.no">
                            <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/80 table-row-hover group">
                                <td class="px-2 py-2 font-mono text-slate-400 sticky left-0 z-20 bg-white dark:bg-[#0b1121] group-hover:bg-slate-50 dark:group-hover:bg-slate-800/80 border-r border-slate-100 dark:border-slate-800 shadow-[2px_0_10px_-3px_rgba(0,0,0,0.1)] text-center">
                                    <div class="flex items-center justify-between h-full">
                                        <span x-text="row.no" class="text-[10px]"></span>
                                        <button x-show="row.has_history" @click="viewHistory(row.no)" class="text-indigo-400 hover:text-indigo-600 dark:text-indigo-500 dark:hover:text-indigo-300 transition-colors ml-1" title="View History">
                                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        </button>
                                    </div>
                                </td>
                                <td @click="handleCellAction(row, 'p_desc', row.p_desc)" title="Click to copy, Dbl-click to edit" class="px-2 py-2 whitespace-nowrap max-w-[250px] min-w-[180px] truncate text-slate-600 dark:text-slate-300 cursor-pointer hover:bg-indigo-50/50 dark:hover:bg-indigo-900/20">
                                    <template x-if="editing.id === row.no && editing.field === 'p_desc'"
                                        ><input type="text" x-model="row.p_desc" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full px-2 py-1 text-[11px] border border-indigo-300 rounded shadow-inner dark:bg-slate-900 dark:text-white dark:border-indigo-500/50 focus:outline-none focus:ring-1 focus:ring-indigo-500" autofocus
                                    /></template>
                                    <template x-if="!(editing.id === row.no && editing.field === 'p_desc')"><span x-text="row.p_desc"></span></template>
                                </td>
                                <td @click="handleCellAction(row, 'p_supp', row.p_supp)" title="Click to copy, Dbl-click to edit" class="px-2 py-2 whitespace-nowrap min-w-[250px] max-w-[300px] truncate font-medium text-slate-800 dark:text-slate-200 cursor-pointer hover:bg-indigo-50/50 dark:hover:bg-indigo-900/20">
                                    <template x-if="editing.id === row.no && editing.field === 'p_supp'"
                                        ><input type="text" x-model="row.p_supp" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full px-2 py-1 text-[11px] border border-indigo-300 rounded shadow-inner dark:bg-slate-900 dark:text-white dark:border-indigo-500/50 focus:outline-none focus:ring-1 focus:ring-indigo-500" autofocus
                                    /></template>
                                    <template x-if="!(editing.id === row.no && editing.field === 'p_supp')"><span x-text="row.p_supp"></span></template>
                                </td>
                                <td @click="handleCellAction(row, 'p_tin', row.p_tin)" title="Click to copy, Dbl-click to edit" class="px-2 py-2 whitespace-nowrap font-mono text-blue-600 dark:text-blue-400 cursor-pointer hover:bg-indigo-50/50 dark:hover:bg-indigo-900/20">
                                    <template x-if="editing.id === row.no && editing.field === 'p_tin'"
                                        ><input type="text" x-model="row.p_tin" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full px-2 py-1 text-[11px] border border-indigo-300 rounded shadow-inner dark:bg-slate-900 dark:text-white dark:border-indigo-500/50 focus:outline-none focus:ring-1 focus:ring-indigo-500 font-mono" autofocus
                                    /></template>
                                    <template x-if="!(editing.id === row.no && editing.field === 'p_tin')"><span x-text="row.p_tin"></span></template>
                                </td>
                                <td @click="handleCellAction(row, 'p_inv', row.p_inv)" title="Click to copy, Dbl-click to edit" class="px-2 py-2 whitespace-nowrap font-mono text-blue-600 dark:text-blue-400 cursor-pointer hover:bg-indigo-50/50 dark:hover:bg-indigo-900/20">
                                    <template x-if="editing.id === row.no && editing.field === 'p_inv'"
                                        ><input type="text" x-model="row.p_inv" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full px-2 py-1 text-[11px] border border-indigo-300 rounded shadow-inner dark:bg-slate-900 dark:text-white dark:border-indigo-500/50 focus:outline-none focus:ring-1 focus:ring-indigo-500 font-mono" autofocus
                                    /></template>
                                    <template x-if="!(editing.id === row.no && editing.field === 'p_inv')"><span x-text="row.p_inv"></span></template>
                                </td>
                                <td @click="handleCellAction(row, 'p_date', row.p_date)" title="Click to copy, Dbl-click to edit" class="px-2 py-2 whitespace-nowrap font-mono text-slate-500 dark:text-slate-400 cursor-pointer hover:bg-indigo-50/50 dark:hover:bg-indigo-900/20">
                                    <template x-if="editing.id === row.no && editing.field === 'p_date'"
                                        ><input type="text" x-model="row.p_date" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full px-2 py-1 text-[11px] border border-indigo-300 rounded shadow-inner dark:bg-slate-900 dark:text-white dark:border-indigo-500/50 focus:outline-none focus:ring-1 focus:ring-indigo-500 font-mono" autofocus
                                    /></template>
                                    <template x-if="!(editing.id === row.no && editing.field === 'p_date')"><span x-text="row.p_date"></span></template>
                                </td>
                                <td @click="handleCellAction(row, 'p_amt', formatNumber(row.p_amt))" title="Click to copy, Dbl-click to edit" class="px-2 py-2 whitespace-nowrap text-center font-mono font-bold text-slate-700 dark:text-slate-200 cursor-pointer hover:bg-blue-50/80 dark:hover:bg-blue-900/30 bg-blue-50/30 dark:bg-blue-900/10">
                                    <template x-if="editing.id === row.no && editing.field === 'p_amt'"
                                        ><input type="number" step="0.01" x-model="row.p_amt" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full px-2 py-1 text-[11px] border border-indigo-300 rounded shadow-inner font-mono text-center dark:bg-slate-900 dark:text-white dark:border-indigo-500/50 focus:outline-none focus:ring-1 focus:ring-indigo-500" autofocus
                                    /></template>
                                    <template x-if="!(editing.id === row.no && editing.field === 'p_amt')"><span x-text="formatNumber(row.p_amt)"></span></template>
                                </td>
                                <td class="px-2 py-2 text-center min-w-[180px]">
                                    <template x-if="!row.user_status">
                                        <span class="px-3 py-1 rounded-md text-[10px] font-bold border shadow-sm block w-full whitespace-normal leading-tight" :class="getStatusColor(statusText(row.status))" x-text="statusText(row.status)"></span>
                                    </template>
                                    <template x-if="row.user_status"><span class="text-slate-300 dark:text-slate-700 font-black tracking-widest block opacity-50">...</span></template>
                                </td>
                                <td @click="editCell(row, 'user_status')" title="Click to select status" class="px-2 py-2 text-center min-w-[250px] cursor-pointer hover:bg-indigo-50/50 dark:hover:bg-indigo-900/20 bg-indigo-50/20 dark:bg-indigo-900/10 relative group/status transition-colors">
                                    <template x-if="editing.id === row.no && editing.field === 'user_status'">
                                        <select
                                            :value="row.user_status"
                                            @click.stop
                                            @change="row.user_status = $event.target.value; stopEdit(row);"
                                            @click.outside="cancelEdit()"
                                            @keydown.escape="cancelEdit()"
                                            class="w-full py-1.5 px-2 text-[10px] font-bold border border-indigo-300 rounded shadow-lg dark:bg-slate-800 dark:text-white dark:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                            autofocus
                                        >
                                            <option value="" disabled>-- Select Status --</option>
                                            <template x-for="status in availableStatuses" :key="status.name"><option :value="status.name" x-text="status.name"></option></template>
                                        </select>
                                    </template>
                                    <template x-if="!(editing.id === row.no && editing.field === 'user_status')">
                                        <div class="flex items-center justify-between gap-1 w-full h-full">
                                            <template x-if="!row.user_status">
                                                <div
                                                    class="flex-1 px-3 py-1 rounded-md border border-dashed border-slate-300 dark:border-slate-600 text-slate-400 dark:text-slate-500 text-[10px] font-medium tracking-wide flex items-center justify-center gap-1 group-hover/status:border-indigo-400 group-hover/status:text-indigo-500 dark:group-hover/status:border-indigo-500 dark:group-hover/status:text-indigo-400 transition-colors"
                                                >
                                                    <svg class="w-3 h-3 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg> Set
                                                </div>
                                            </template>
                                            <template x-if="row.user_status">
                                                <span x-text="row.user_status" class="px-3 py-1 flex-1 rounded-md text-[10px] font-bold border shadow-sm whitespace-normal leading-tight text-center" :class="getStatusColor(row.user_status)"></span>
                                            </template>
                                            <button x-show="row.user_status" @click.stop="clearUserStatus(row)" class="text-slate-400 hover:text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/30 rounded p-1.5 transition-all flex-shrink-0" title="Clear Status">
                                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path></svg>
                                            </button>
                                            <div x-show="!row.user_status" class="w-6 flex-shrink-0"></div>
                                        </div>
                                    </template>
                                </td>

                                <td @click="handleCellAction(row, 'p_comment', row.p_comment)" title="Click to copy, Dbl-click to edit" class="px-2 py-2 whitespace-nowrap max-w-[200px] truncate text-slate-600 dark:text-slate-300 border-r border-slate-100 dark:border-slate-800 cursor-pointer hover:bg-indigo-50/50 dark:hover:bg-indigo-900/20">
                                    <template x-if="editing.id === row.no && editing.field === 'p_comment'">
                                        <input type="text" x-model="row.p_comment" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" placeholder="Add a note..." class="w-full px-2 py-1 text-[11px] border border-indigo-300 rounded shadow-inner dark:bg-slate-900 dark:text-white dark:border-indigo-500/50 focus:outline-none focus:ring-1 focus:ring-indigo-500" autofocus />
                                    </template>
                                    <template x-if="!(editing.id === row.no && editing.field === 'p_comment')">
                                        <span x-text="row.p_comment || '-'" :class="{'text-slate-400 italic': !row.p_comment}"></span>
                                    </template>
                                </td>

                                <td class="px-2 py-2 text-center whitespace-nowrap font-mono text-slate-400 dark:text-slate-500 bg-orange-50/20 dark:bg-orange-900/5"><span x-text="row.p_inv_clean"></span></td>
                                <td class="px-2 py-2 text-center whitespace-nowrap font-mono text-slate-400 dark:text-slate-500 bg-orange-50/20 dark:bg-orange-900/5"><span x-text="row.d_inv_clean"></span></td>
                                <td class="px-2 py-2 text-center bg-orange-50/20 dark:bg-orange-900/5"><span x-show="row.v_inv" class="text-emerald-500 text-xs">●</span><span x-show="!row.v_inv" class="text-rose-500 text-xs font-bold">✕</span></td>
                                <td class="px-2 py-2 text-center bg-orange-50/20 dark:bg-orange-900/5"><span x-show="row.v_date" class="text-emerald-500 text-xs">●</span><span x-show="!row.v_date" class="text-rose-500 text-xs font-bold">✕</span></td>
                                <td class="px-2 py-2 text-center bg-orange-50/20 dark:bg-orange-900/5"><span x-show="row.v_tin" class="text-emerald-500 text-xs">●</span><span x-show="!row.v_tin" class="text-rose-500 text-xs font-bold">✕</span></td>
                                <td @click="handleCellAction(row, 'v_diff', formatNumber(row.v_diff))" class="px-2 py-2 text-center font-mono border-r border-slate-100 dark:border-slate-800 bg-orange-50/20 dark:bg-orange-900/5 font-bold cursor-pointer" :class="row.v_diff < -0.05 ? 'text-rose-500' : (row.v_diff > 0.05 ? 'text-emerald-500' : 'text-slate-400 dark:text-slate-500')">
                                    <template x-if="editing.id === row.no && editing.field === 'v_diff'"
                                        ><input type="number" step="0.01" x-model="row.v_diff" @click.stop @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full px-2 py-1 text-[11px] border border-indigo-300 rounded font-mono text-center dark:bg-slate-900 dark:text-white dark:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500" autofocus
                                    /></template>
                                    <template x-if="!(editing.id === row.no && editing.field === 'v_diff')"><span x-text="Math.abs(row.v_diff) > 0.05 ? formatNumber(row.v_diff) : '-'"></span></template>
                                </td>
                                <td @click="handleCellAction(row, 'd_data.date', row.d_data.date)" title="Click to copy, Dbl-click to edit" class="px-2 py-2 whitespace-nowrap font-mono text-fuchsia-700 dark:text-fuchsia-400 bg-purple-50/10 dark:bg-purple-900/10 cursor-pointer hover:bg-purple-50/50 dark:hover:bg-purple-900/30">
                                    <template x-if="editing.id === row.no && editing.field === 'd_data.date'"
                                        ><input type="text" x-model="row.d_data.date" @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full px-2 py-1 text-[11px] border border-purple-300 rounded font-mono dark:bg-slate-900 dark:text-white dark:border-purple-500 focus:outline-none focus:ring-1 focus:ring-purple-500" autofocus
                                    /></template>
                                    <template x-if="!(editing.id === row.no && editing.field === 'd_data.date')"><span x-text="row.d_data.date || '-'"></span></template>
                                </td>
                                <td @click="handleCellAction(row, 'd_data.invoice_no', row.d_data.invoice_no)" title="Click to copy, Dbl-click to edit" class="px-2 py-2 whitespace-nowrap font-mono text-purple-600 dark:text-purple-300 bg-purple-50/10 dark:bg-purple-900/10 cursor-pointer hover:bg-purple-50/50 dark:hover:bg-purple-900/30">
                                    <template x-if="editing.id === row.no && editing.field === 'd_data.invoice_no'"
                                        ><input type="text" x-model="row.d_data.invoice_no" @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full px-2 py-1 text-[11px] border border-purple-300 rounded font-mono dark:bg-slate-900 dark:text-white dark:border-purple-500 focus:outline-none focus:ring-1 focus:ring-purple-500" autofocus
                                    /></template>
                                    <template x-if="!(editing.id === row.no && editing.field === 'd_data.invoice_no')"><span x-text="row.d_data.invoice_no || '-'"></span></template>
                                </td>
                                <td @click="handleCellAction(row, 'd_data.credit_no', row.d_data.credit_no)" title="Click to copy, Dbl-click to edit" class="px-2 py-2 whitespace-nowrap font-mono text-slate-500 dark:text-slate-400 bg-purple-50/10 dark:bg-purple-900/10 cursor-pointer hover:bg-purple-50/50 dark:hover:bg-purple-900/30">
                                    <template x-if="editing.id === row.no && editing.field === 'd_data.credit_no'"
                                        ><input type="text" x-model="row.d_data.credit_no" @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full px-2 py-1 text-[11px] border border-purple-300 rounded font-mono dark:bg-slate-900 dark:text-white dark:border-purple-500 focus:outline-none focus:ring-1 focus:ring-purple-500" autofocus
                                    /></template>
                                    <template x-if="!(editing.id === row.no && editing.field === 'd_data.credit_no')"><span x-text="row.d_data.credit_no || '-'"></span></template>
                                </td>
                                <td @click="handleCellAction(row, 'd_data.buyer_type', row.d_data.buyer_type)" title="Click to copy, Dbl-click to edit" class="px-2 py-2 whitespace-nowrap max-w-[120px] truncate text-slate-600 dark:text-slate-300 bg-purple-50/10 dark:bg-purple-900/10 cursor-pointer hover:bg-purple-50/50 dark:hover:bg-purple-900/30">
                                    <template x-if="editing.id === row.no && editing.field === 'd_data.buyer_type'"
                                        ><input type="text" x-model="row.d_data.buyer_type" @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full px-2 py-1 text-[11px] border border-purple-300 rounded dark:bg-slate-900 dark:text-white dark:border-purple-500 focus:outline-none focus:ring-1 focus:ring-purple-500" autofocus
                                    /></template>
                                    <template x-if="!(editing.id === row.no && editing.field === 'd_data.buyer_type')"><span x-text="row.d_data.buyer_type || '-'"></span></template>
                                </td>
                                <td @click="handleCellAction(row, 'd_data.tin', row.d_data.tin)" title="Click to copy, Dbl-click to edit" class="px-2 py-2 whitespace-nowrap font-mono text-blue-500 dark:text-blue-400 bg-purple-50/10 dark:bg-purple-900/10 cursor-pointer hover:bg-purple-50/50 dark:hover:bg-purple-900/30">
                                    <template x-if="editing.id === row.no && editing.field === 'd_data.tin'"
                                        ><input type="text" x-model="row.d_data.tin" @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full px-2 py-1 text-[11px] border border-purple-300 rounded font-mono dark:bg-slate-900 dark:text-white dark:border-purple-500 focus:outline-none focus:ring-1 focus:ring-purple-500" autofocus
                                    /></template>
                                    <template x-if="!(editing.id === row.no && editing.field === 'd_data.tin')"><span x-text="row.d_data.tin || '-'"></span></template>
                                </td>
                                <td @click="handleCellAction(row, 'd_data.name', row.d_data.name)" title="Click to copy, Dbl-click to edit" class="px-2 py-2 whitespace-nowrap max-w-[150px] truncate text-slate-700 dark:text-slate-200 bg-purple-50/10 dark:bg-purple-900/10 cursor-pointer hover:bg-purple-50/50 dark:hover:bg-purple-900/30">
                                    <template x-if="editing.id === row.no && editing.field === 'd_data.name'"
                                        ><input type="text" x-model="row.d_data.name" @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full px-2 py-1 text-[11px] border border-purple-300 rounded dark:bg-slate-900 dark:text-white dark:border-purple-500 focus:outline-none focus:ring-1 focus:ring-purple-500" autofocus
                                    /></template>
                                    <template x-if="!(editing.id === row.no && editing.field === 'd_data.name')"><span x-text="row.d_data.name || '-'"></span></template>
                                </td>
                                <td @click="handleCellAction(row, 'd_data.total_amt', formatNumber(row.d_data.total_amt))" title="Click to copy, Dbl-click to edit" class="px-2 py-2 whitespace-nowrap text-center font-mono font-bold text-slate-700 dark:text-slate-200 bg-purple-50/10 dark:bg-purple-900/10 cursor-pointer hover:bg-purple-50/50 dark:hover:bg-purple-900/30">
                                    <template x-if="editing.id === row.no && editing.field === 'd_data.total_amt'"
                                        ><input type="number" step="0.01" x-model="row.d_data.total_amt" @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full px-2 py-1 text-[11px] border border-purple-300 rounded font-mono text-center dark:bg-slate-900 dark:text-white dark:border-purple-500 focus:outline-none focus:ring-1 focus:ring-purple-500" autofocus
                                    /></template>
                                    <template x-if="!(editing.id === row.no && editing.field === 'd_data.total_amt')"><span x-text="formatNumber(row.d_data.total_amt)"></span></template>
                                </td>
                                <td @click="handleCellAction(row, 'd_data.excl_vat', formatNumber(row.d_data.excl_vat))" title="Click to copy, Dbl-click to edit" class="px-2 py-2 whitespace-nowrap text-center font-mono text-slate-600 dark:text-slate-300 bg-purple-50/10 dark:bg-purple-900/10 cursor-pointer hover:bg-purple-50/50 dark:hover:bg-purple-900/30">
                                    <template x-if="editing.id === row.no && editing.field === 'd_data.excl_vat'"
                                        ><input type="number" step="0.01" x-model="row.d_data.excl_vat" @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full px-2 py-1 text-[11px] border border-purple-300 rounded font-mono text-center dark:bg-slate-900 dark:text-white dark:border-purple-500 focus:outline-none focus:ring-1 focus:ring-purple-500" autofocus
                                    /></template>
                                    <template x-if="!(editing.id === row.no && editing.field === 'd_data.excl_vat')"><span x-text="formatNumber(row.d_data.excl_vat)"></span></template>
                                </td>
                                <td @click="handleCellAction(row, 'd_data.non_vat', formatNumber(row.d_data.non_vat))" title="Click to copy, Dbl-click to edit" class="px-2 py-2 whitespace-nowrap text-center font-mono text-slate-500 dark:text-slate-400 bg-purple-50/10 dark:bg-purple-900/10 cursor-pointer hover:bg-purple-50/50 dark:hover:bg-purple-900/30">
                                    <template x-if="editing.id === row.no && editing.field === 'd_data.non_vat'"
                                        ><input type="number" step="0.01" x-model="row.d_data.non_vat" @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full px-2 py-1 text-[11px] border border-purple-300 rounded font-mono text-center dark:bg-slate-900 dark:text-white dark:border-purple-500 focus:outline-none focus:ring-1 focus:ring-purple-500" autofocus
                                    /></template>
                                    <template x-if="!(editing.id === row.no && editing.field === 'd_data.non_vat')"><span x-text="formatNumber(row.d_data.non_vat)"></span></template>
                                </td>
                                <td @click="handleCellAction(row, 'd_data.vat_0', formatNumber(row.d_data.vat_0))" title="Click to copy, Dbl-click to edit" class="px-2 py-2 whitespace-nowrap text-center font-mono text-slate-500 dark:text-slate-400 bg-purple-50/10 dark:bg-purple-900/10 cursor-pointer hover:bg-purple-50/50 dark:hover:bg-purple-900/30">
                                    <template x-if="editing.id === row.no && editing.field === 'd_data.vat_0'"
                                        ><input type="number" step="0.01" x-model="row.d_data.vat_0" @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full px-2 py-1 text-[11px] border border-purple-300 rounded font-mono text-center dark:bg-slate-900 dark:text-white dark:border-purple-500 focus:outline-none focus:ring-1 focus:ring-purple-500" autofocus
                                    /></template>
                                    <template x-if="!(editing.id === row.no && editing.field === 'd_data.vat_0')"><span x-text="formatNumber(row.d_data.vat_0)"></span></template>
                                </td>
                                <td @click="handleCellAction(row, 'd_data.vat_local', formatNumber(row.d_data.vat_local))" title="Click to copy, Dbl-click to edit" class="px-2 py-2 whitespace-nowrap text-center font-mono font-bold text-purple-700 dark:text-purple-400 bg-purple-50/10 dark:bg-purple-900/10 cursor-pointer hover:bg-purple-50/50 dark:hover:bg-purple-900/30">
                                    <template x-if="editing.id === row.no && editing.field === 'd_data.vat_local'"
                                        ><input type="number" step="0.01" x-model="row.d_data.vat_local" @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full px-2 py-1 text-[11px] border border-purple-300 rounded font-mono text-center dark:bg-slate-900 dark:text-white dark:border-purple-500 focus:outline-none focus:ring-1 focus:ring-purple-500" autofocus
                                    /></template>
                                    <template x-if="!(editing.id === row.no && editing.field === 'd_data.vat_local')"><span x-text="formatNumber(row.d_data.vat_local)"></span></template>
                                </td>
                                <td @click="handleCellAction(row, 'd_data.vat_export', formatNumber(row.d_data.vat_export))" title="Click to copy, Dbl-click to edit" class="px-2 py-2 whitespace-nowrap text-center font-mono font-bold text-indigo-600 dark:text-indigo-400 bg-purple-50/10 dark:bg-purple-900/10 cursor-pointer hover:bg-purple-50/50 dark:hover:bg-purple-900/30">
                                    <template x-if="editing.id === row.no && editing.field === 'd_data.vat_export'"
                                        ><input type="number" step="0.01" x-model="row.d_data.vat_export" @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full px-2 py-1 text-[11px] border border-purple-300 rounded font-mono text-center dark:bg-slate-900 dark:text-white dark:border-purple-500 focus:outline-none focus:ring-1 focus:ring-purple-500" autofocus
                                    /></template>
                                    <template x-if="!(editing.id === row.no && editing.field === 'd_data.vat_export')"><span x-text="formatNumber(row.d_data.vat_export)"></span></template>
                                </td>
                                <td @click="handleCellAction(row, 'd_data.state_burden', formatNumber(row.d_data.state_burden))" title="Click to copy, Dbl-click to edit" class="px-2 py-2 whitespace-nowrap text-center font-mono text-slate-500 dark:text-slate-400 bg-purple-50/10 dark:bg-purple-900/10 cursor-pointer hover:bg-purple-50/50 dark:hover:bg-purple-900/30">
                                    <template x-if="editing.id === row.no && editing.field === 'd_data.state_burden'"
                                        ><input type="number" step="0.01" x-model="row.d_data.state_burden" @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full px-2 py-1 text-[11px] border border-purple-300 rounded font-mono text-center dark:bg-slate-900 dark:text-white dark:border-purple-500 focus:outline-none focus:ring-1 focus:ring-purple-500" autofocus
                                    /></template>
                                    <template x-if="!(editing.id === row.no && editing.field === 'd_data.state_burden')"><span x-text="formatNumber(row.d_data.state_burden)"></span></template>
                                </td>
                                <td @click="handleCellAction(row, 'd_data.withheld', formatNumber(row.d_data.withheld))" title="Click to copy, Dbl-click to edit" class="px-2 py-2 whitespace-nowrap text-center font-mono text-slate-500 dark:text-slate-400 bg-purple-50/10 dark:bg-purple-900/10 cursor-pointer hover:bg-purple-50/50 dark:hover:bg-purple-900/30">
                                    <template x-if="editing.id === row.no && editing.field === 'd_data.withheld'"
                                        ><input type="number" step="0.01" x-model="row.d_data.withheld" @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full px-2 py-1 text-[11px] border border-purple-300 rounded font-mono text-center dark:bg-slate-900 dark:text-white dark:border-purple-500 focus:outline-none focus:ring-1 focus:ring-purple-500" autofocus
                                    /></template>
                                    <template x-if="!(editing.id === row.no && editing.field === 'd_data.withheld')"><span x-text="formatNumber(row.d_data.withheld)"></span></template>
                                </td>
                                <td @click="handleCellAction(row, 'd_data.plt', formatNumber(row.d_data.plt))" title="Click to copy, Dbl-click to edit" class="px-2 py-2 whitespace-nowrap text-center font-mono text-slate-500 dark:text-slate-400 bg-purple-50/10 dark:bg-purple-900/10 cursor-pointer hover:bg-purple-50/50 dark:hover:bg-purple-900/30">
                                    <template x-if="editing.id === row.no && editing.field === 'd_data.plt'"
                                        ><input type="number" step="0.01" x-model="row.d_data.plt" @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full px-2 py-1 text-[11px] border border-purple-300 rounded font-mono text-center dark:bg-slate-900 dark:text-white dark:border-purple-500 focus:outline-none focus:ring-1 focus:ring-purple-500" autofocus
                                    /></template>
                                    <template x-if="!(editing.id === row.no && editing.field === 'd_data.plt')"><span x-text="formatNumber(row.d_data.plt)"></span></template>
                                </td>
                                <td @click="handleCellAction(row, 'd_data.spec_goods', formatNumber(row.d_data.spec_goods))" title="Click to copy, Dbl-click to edit" class="px-2 py-2 whitespace-nowrap text-center font-mono text-slate-500 dark:text-slate-400 bg-purple-50/10 dark:bg-purple-900/10 cursor-pointer hover:bg-purple-50/50 dark:hover:bg-purple-900/30">
                                    <template x-if="editing.id === row.no && editing.field === 'd_data.spec_goods'"
                                        ><input type="number" step="0.01" x-model="row.d_data.spec_goods" @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full px-2 py-1 text-[11px] border border-purple-300 rounded font-mono text-center dark:bg-slate-900 dark:text-white dark:border-purple-500 focus:outline-none focus:ring-1 focus:ring-purple-500" autofocus
                                    /></template>
                                    <template x-if="!(editing.id === row.no && editing.field === 'd_data.spec_goods')"><span x-text="formatNumber(row.d_data.spec_goods)"></span></template>
                                </td>
                                <td @click="handleCellAction(row, 'd_data.spec_serv', formatNumber(row.d_data.spec_serv))" title="Click to copy, Dbl-click to edit" class="px-2 py-2 whitespace-nowrap text-center font-mono text-slate-500 dark:text-slate-400 bg-purple-50/10 dark:bg-purple-900/10 cursor-pointer hover:bg-purple-50/50 dark:hover:bg-purple-900/30">
                                    <template x-if="editing.id === row.no && editing.field === 'd_data.spec_serv'"
                                        ><input type="number" step="0.01" x-model="row.d_data.spec_serv" @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full px-2 py-1 text-[11px] border border-purple-300 rounded font-mono text-center dark:bg-slate-900 dark:text-white dark:border-purple-500 focus:outline-none focus:ring-1 focus:ring-purple-500" autofocus
                                    /></template>
                                    <template x-if="!(editing.id === row.no && editing.field === 'd_data.spec_serv')"><span x-text="formatNumber(row.d_data.spec_serv)"></span></template>
                                </td>
                                <td @click="handleCellAction(row, 'd_data.accom', formatNumber(row.d_data.accom))" title="Click to copy, Dbl-click to edit" class="px-2 py-2 whitespace-nowrap text-center font-mono text-slate-500 dark:text-slate-400 bg-purple-50/10 dark:bg-purple-900/10 cursor-pointer hover:bg-purple-50/50 dark:hover:bg-purple-900/30">
                                    <template x-if="editing.id === row.no && editing.field === 'd_data.accom'"
                                        ><input type="number" step="0.01" x-model="row.d_data.accom" @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full px-2 py-1 text-[11px] border border-purple-300 rounded font-mono text-center dark:bg-slate-900 dark:text-white dark:border-purple-500 focus:outline-none focus:ring-1 focus:ring-purple-500" autofocus
                                    /></template>
                                    <template x-if="!(editing.id === row.no && editing.field === 'd_data.accom')"><span x-text="formatNumber(row.d_data.accom)"></span></template>
                                </td>
                                <td @click="handleCellAction(row, 'd_data.redemption', formatNumber(row.d_data.redemption))" title="Click to copy, Dbl-click to edit" class="px-2 py-2 whitespace-nowrap text-center font-mono text-slate-500 dark:text-slate-400 bg-purple-50/10 dark:bg-purple-900/10 cursor-pointer hover:bg-purple-50/50 dark:hover:bg-purple-900/30">
                                    <template x-if="editing.id === row.no && editing.field === 'd_data.redemption'"
                                        ><input type="number" step="0.01" x-model="row.d_data.redemption" @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full px-2 py-1 text-[11px] border border-purple-300 rounded font-mono text-center dark:bg-slate-900 dark:text-white dark:border-purple-500 focus:outline-none focus:ring-1 focus:ring-purple-500" autofocus
                                    /></template>
                                    <template x-if="!(editing.id === row.no && editing.field === 'd_data.redemption')"><span x-text="formatNumber(row.d_data.redemption)"></span></template>
                                </td>
                                <td @click="handleCellAction(row, 'd_data.notes', row.d_data.notes)" title="Click to copy, Dbl-click to edit" class="px-2 py-2 max-w-[120px] truncate text-slate-500 dark:text-slate-400 bg-purple-50/10 dark:bg-purple-900/10 cursor-pointer hover:bg-purple-50/50 dark:hover:bg-purple-900/30">
                                    <template x-if="editing.id === row.no && editing.field === 'd_data.notes'"
                                        ><input type="text" x-model="row.d_data.notes" @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full px-2 py-1 text-[11px] border border-purple-300 rounded dark:bg-slate-900 dark:text-white dark:border-purple-500 focus:outline-none focus:ring-1 focus:ring-purple-500" autofocus
                                    /></template>
                                    <template x-if="!(editing.id === row.no && editing.field === 'd_data.notes')"><span x-text="row.d_data.notes || '-'"></span></template>
                                </td>
                                <td @click="handleCellAction(row, 'd_data.desc', row.d_data.desc)" title="Click to copy, Dbl-click to edit" class="px-2 py-2 max-w-[120px] truncate text-slate-500 dark:text-slate-400 bg-purple-50/10 dark:bg-purple-900/10 cursor-pointer hover:bg-purple-50/50 dark:hover:bg-purple-900/30">
                                    <template x-if="editing.id === row.no && editing.field === 'd_data.desc'"
                                        ><input type="text" x-model="row.d_data.desc" @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full px-2 py-1 text-[11px] border border-purple-300 rounded dark:bg-slate-900 dark:text-white dark:border-purple-500 focus:outline-none focus:ring-1 focus:ring-purple-500" autofocus
                                    /></template>
                                    <template x-if="!(editing.id === row.no && editing.field === 'd_data.desc')"><span x-text="row.d_data.desc || '-'"></span></template>
                                </td>
                                <td @click="handleCellAction(row, 'd_data.dec_status', row.d_data.dec_status)" title="Click to copy, Dbl-click to edit" class="px-2 py-2 whitespace-nowrap bg-purple-50/10 dark:bg-purple-900/10 cursor-pointer hover:bg-purple-50/50 dark:hover:bg-purple-900/30">
                                    <template x-if="editing.id === row.no && editing.field === 'd_data.dec_status'"
                                        ><input type="text" x-model="row.d_data.dec_status" @blur="stopEdit(row)" @keydown.enter="stopEdit(row)" class="w-full px-2 py-1 text-[11px] border border-purple-300 rounded dark:bg-slate-900 dark:text-white dark:border-purple-500 focus:outline-none focus:ring-1 focus:ring-purple-500" autofocus
                                    /></template>
                                    <template x-if="!(editing.id === row.no && editing.field === 'd_data.dec_status')">
                                        <span
                                            ><span x-show="row.d_data.dec_status" class="px-2 py-1 rounded-md text-[9px] font-bold bg-fuchsia-100 text-fuchsia-700 dark:bg-fuchsia-900/30 dark:text-fuchsia-400 border border-fuchsia-200 dark:border-fuchsia-800" x-text="row.d_data.dec_status"></span
                                            ><span x-show="!row.d_data.dec_status" class="text-slate-300 dark:text-slate-600 font-bold">-</span></span
                                        >
                                    </template>
                                </td>
                            </tr>
                        </template>
                        <tr x-show="rows.length === 0 && !loading" class="h-64">
                            <td colspan="38" class="text-center text-slate-400 dark:text-slate-500">
                                <div class="flex flex-col items-center justify-center gap-3">
                                    <svg class="w-10 h-10 text-slate-300 dark:text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                    <span class="text-sm font-medium">No records found for this view.</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div x-show="loading" class="absolute inset-0 bg-white/60 dark:bg-slate-900/60 backdrop-blur-md flex items-center justify-center z-30 transition-all pointer-events-none">
                <div class="flex items-center gap-4 bg-white dark:bg-slate-800 px-8 py-5 rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-700 ring-1 ring-inset ring-white/10 pointer-events-auto">
                    <svg class="animate-spin -ml-1 mr-3 h-6 w-6 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-slate-700 dark:text-slate-200 font-bold tracking-wide">Syncing Data...</span>
                </div>
            </div>
        </div>

        <button x-show="showScrollTop" x-transition @click="scrollToTop()" class="absolute bottom-16 right-8 z-40 p-3.5 rounded-full bg-gradient-to-r from-indigo-500 to-blue-500 text-white shadow-xl hover:shadow-indigo-500/30 transition-all transform hover:-translate-y-1 focus:outline-none">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
        </button>

        <div x-show="rows.length > 0" class="px-5 py-3 border-t border-slate-200 dark:border-slate-800 bg-slate-50/80 dark:bg-slate-900/80 backdrop-blur-md flex flex-col sm:flex-row justify-between items-center text-[11px] text-slate-600 dark:text-slate-400 flex-shrink-0 z-10 gap-3">
            <div class="truncate font-medium">Showing <span class="font-bold text-slate-900 dark:text-white" x-text="startRecord"></span> to <span class="font-bold text-slate-900 dark:text-white" x-text="endRecord"></span> of <span class="font-bold text-indigo-600 dark:text-indigo-400" x-text="formatNumber(totalRows)"></span> results</div>
            <div class="flex items-center gap-5">
                <div class="flex items-center gap-2">
                    <span class="text-slate-500 hidden sm:inline uppercase tracking-wider text-[9px] font-bold">Rows/Page:</span>
                    <select x-model="pageSizePreset" @change="handlePageSizeChange()" class="text-[11px] font-bold border border-slate-300 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 py-1.5 pl-3 pr-7 focus:ring-2 focus:ring-indigo-500/40 focus:border-indigo-500 shadow-sm">
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="500">500</option>
                        <option value="1000">1000</option>
                        <option value="custom">Custom</option>
                    </select>
                    <div x-show="pageSizePreset === 'custom'" x-transition class="w-16">
                        <input x-model.number="pageSize" @keydown.enter="changePageSize()" @blur="changePageSize()" type="number" min="1" class="w-full text-[11px] font-bold border border-slate-300 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 py-1.5 px-3 focus:ring-2 focus:ring-indigo-500/40 focus:border-indigo-500 shadow-sm" placeholder="#" />
                    </div>
                </div>
                <div class="flex items-center gap-3 border-l border-slate-300 dark:border-slate-700 pl-5">
                    <button @click="changePage(page - 1)" :disabled="page <= 1" class="px-2.5 py-1.5 rounded-lg border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-700 disabled:opacity-30 disabled:cursor-not-allowed bg-white dark:bg-slate-800 transition shadow-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <span class="px-2 min-w-[70px] text-center font-bold text-slate-700 dark:text-slate-300">Page <span x-text="page"></span> of <span x-text="totalPages"></span></span>
                    <button @click="changePage(page + 1)" :disabled="page >= totalPages" class="px-2.5 py-1.5 rounded-lg border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-700 disabled:opacity-30 disabled:cursor-not-allowed bg-white dark:bg-slate-800 transition shadow-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="fixed bottom-8 left-0 right-0 z-50 flex justify-center pointer-events-none">
        <div x-show="toastMsg" x-transition.opacity.duration.300ms class="bg-slate-900 dark:bg-white text-white dark:text-slate-900 px-6 py-3.5 rounded-full shadow-2xl text-sm font-bold flex items-center gap-3 pointer-events-auto border border-slate-700 dark:border-slate-200" style="display: none">
            <div class="bg-emerald-500/20 text-emerald-400 dark:text-emerald-600 rounded-full p-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
            </div>
            <span x-text="toastMsg" class="tracking-wide"></span>
        </div>
    </div>
</div>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('resultsDashboard', () => ({
            ovatrCode: '{{ ovatr_code }}',
            rows: [],
            stats: {total: 0, matched: 0, not_found: 0, mismatch: 0, local_count: 0, import_count: 0, eff_counts: {}},
            effCounts: {},
            search: '',
            filter: 'ALL',
            tableType: 'local',
            loading: true,
            isCached: false,
            isSaving: false,
            autoSavePending: 0,
            page: 1,
            pageSize: 50,
            pageSizePreset: '50',
            totalPages: 1,
            totalRows: 0,
            showHistoryModal: false,
            historyRowId: null,
            historyLogs: [],
            historyLoading: false,
            historyFilter: '',
            editing: {id: null, field: null},
            history: [],
            historyIndex: -1,
            unsavedChanges: new Set(),
            toastMsg: '',

            showStatusModal: false,
            availableStatuses: [],
            newStatus: {name: '', summary: '', action: '', color: 'green'},

            clicks: 0,
            clickTimer: null,
            clickDelay: 250,

            getStatusColor(statusName) {
                if (!statusName) return 'bg-slate-100/50 text-slate-400 border-slate-200 border-dashed dark:bg-slate-800/50 dark:border-slate-700';
                const st = this.availableStatuses.find((s) => s.name === statusName);
                const color = st ? st.color : 'gray';

                if (color === 'green') return 'bg-gradient-to-br from-emerald-50 to-green-100 dark:from-emerald-900/30 dark:to-green-900/10 text-green-700 dark:text-emerald-400 border-green-200 dark:border-emerald-500/30 ring-1 ring-inset ring-green-500/10';
                if (color === 'orange') return 'bg-gradient-to-br from-orange-50 to-amber-100 dark:from-orange-900/30 dark:to-amber-900/10 text-orange-700 dark:text-orange-400 border-orange-200 dark:border-orange-500/30 ring-1 ring-inset ring-orange-500/10';
                if (color === 'red') return 'bg-gradient-to-br from-rose-50 to-red-100 dark:from-rose-900/30 dark:to-red-900/10 text-red-700 dark:text-rose-400 border-red-200 dark:border-rose-500/30 ring-1 ring-inset ring-red-500/10';
                if (color === 'blue') return 'bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-blue-900/30 dark:to-indigo-900/10 text-blue-700 dark:text-blue-400 border-blue-200 dark:border-blue-500/30 ring-1 ring-inset ring-blue-500/10';
                return 'bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-800 dark:to-slate-900 text-slate-700 dark:text-slate-300 border-slate-300 dark:border-slate-700 ring-1 ring-inset ring-slate-500/10';
            },

            getStatusBoxColor(statusName) {
                const st = this.availableStatuses.find((s) => s.name === statusName);
                const color = st ? st.color : 'gray';

                if (color === 'green') return 'bg-gradient-to-br from-emerald-50/50 to-green-100/50 dark:from-[#064e3b] dark:to-[#065f46] text-green-900 dark:text-emerald-50 border-green-200 dark:border-emerald-500/40 shadow-[0_4px_20px_-4px_rgba(16,185,129,0.15)] ring-1 ring-inset ring-emerald-500/20';
                if (color === 'orange') return 'bg-gradient-to-br from-orange-50/50 to-amber-100/50 dark:from-[#7c2d12] dark:to-[#9a3412] text-orange-900 dark:text-orange-50 border-orange-200 dark:border-orange-500/40 shadow-[0_4px_20px_-4px_rgba(249,115,22,0.15)] ring-1 ring-inset ring-orange-500/20';
                if (color === 'red') return 'bg-gradient-to-br from-rose-50/50 to-red-100/50 dark:from-[#881337] dark:to-[#9f1239] text-red-900 dark:text-rose-50 border-red-200 dark:border-rose-500/40 shadow-[0_4px_20px_-4px_rgba(225,29,72,0.15)] ring-1 ring-inset ring-rose-500/20';
                if (color === 'blue') return 'bg-gradient-to-br from-blue-50/50 to-indigo-100/50 dark:from-[#1e3a8a] dark:to-[#1e40af] text-blue-900 dark:text-blue-50 border-blue-200 dark:border-blue-500/40 shadow-[0_4px_20px_-4px_rgba(59,130,246,0.15)] ring-1 ring-inset ring-blue-500/20';
                return 'bg-white dark:bg-gradient-to-br dark:from-slate-800 dark:to-slate-900 text-slate-900 dark:text-white border-slate-200 dark:border-slate-700 shadow-sm ring-1 ring-inset ring-slate-500/10';
            },

            getAmbientGlow(statusName) {
                const st = this.availableStatuses.find((s) => s.name === statusName);
                const color = st ? st.color : 'gray';

                if (color === 'green') return 'bg-emerald-500/20';
                if (color === 'orange') return 'bg-orange-500/20';
                if (color === 'red') return 'bg-rose-500/20';
                if (color === 'blue') return 'bg-blue-500/20';
                return 'bg-slate-500/10';
            },

            handleCellAction(row, field, textToCopy) {
                if (this.editing.id === row.no && this.editing.field === field) return;
                this.clicks++;
                if (this.clicks === 1) {
                    this.clickTimer = setTimeout(() => {
                        this.clicks = 0;
                        this.copyToClipboard(textToCopy);
                    }, this.clickDelay);
                } else if (this.clicks === 2) {
                    clearTimeout(this.clickTimer);
                    this.clicks = 0;
                    this.editCell(row, field);
                }
            },

            updateLocalStats() {},

            incrementStat(oldStatus, newStatus) {
                if (oldStatus === newStatus) return;
                if (this.effCounts[oldStatus] && this.effCounts[oldStatus] > 0) {
                    this.effCounts[oldStatus]--;
                    if (this.effCounts[oldStatus] === 0) {
                        const isDefault = this.availableStatuses.find((s) => s.name === oldStatus);
                        if (!isDefault) delete this.effCounts[oldStatus];
                    }
                }
                this.effCounts[newStatus] = (this.effCounts[newStatus] || 0) + 1;
            },

            clearUserStatus(row) {
                if (!row.user_status) return;
                const oldValue = row.user_status;
                row.user_status = '';

                this.pushHistoryAction(row.no, 'user_status', oldValue, '');
                this.recalculate(row);

                const finalSysStatus = this.statusText(row.status);
                this.incrementStat(oldValue, finalSysStatus);

                this.autoSaveRow(row);
                this.toastMsg = 'User Status cleared.';
                setTimeout(() => {
                    this.toastMsg = '';
                }, 2000);
            },

            copyToClipboard(text) {
                if (!text) return;
                navigator.clipboard.writeText(String(text)).then(() => {
                    this.toastMsg = 'Copied to clipboard';
                    setTimeout(() => {
                        this.toastMsg = '';
                    }, 2000);
                });
            },

            formatDateStr(val) {
                if (!val) return '';
                let s = String(val).trim().split(' ')[0];
                if (s.includes('-')) {
                    let p = s.split('-');
                    if (p.length === 3 && p[0].length === 4) return `${p[2]}-${p[1]}-${p[0]}`;
                    return s;
                }
                if (s.includes('/')) {
                    let p = s.split('/');
                    if (p.length === 3 && p[0].length === 4) return `${p[2]}-${p[1]}-${p[0]}`;
                    if (p.length === 3) return `${p[0]}-${p[1]}-${p[2]}`;
                    return s.replace(/\//g, '-');
                }
                return s;
            },

            formatNumber(num) {
                if (num === null || num === undefined || num === '') return '-';
                const parsed = parseFloat(num);
                if (isNaN(parsed)) return '-';
                if (parsed === 0) return '0';
                return new Intl.NumberFormat('en-US').format(parsed);
            },

            async init() {
                // 1. If URL has an ID, save it to the browser's memory
                if (this.ovatrCode) {
                    localStorage.setItem('active_ovatr_session', this.ovatrCode);
                }
                // 2. If URL is blank (user clicked sidebar), revive ID from memory
                else {
                    const activeSession = localStorage.getItem('active_ovatr_session');
                    if (activeSession) {
                        this.ovatrCode = activeSession;
                        // Silently put the ID back into the address bar
                        const url = new URL(window.location);
                        url.searchParams.set('ovatr_code', activeSession);
                        window.history.replaceState({}, '', url);
                    }
                }

                // 3. Proceed with loading data if we have an active session
                if (this.ovatrCode) {
                    await this.loadStatuses();
                    this.loadStats();
                    await this.fetchData();
                } else {
                    this.loading = false; // Stop spinner if no session exists
                }
            },

            async loadStatuses() {
                try {
                    const res = await fetch('{% url "crosscheck:api_user_statuses" %}');
                    const data = await res.json();
                    if (data.status === 'success') {
                        this.availableStatuses = data.data;
                    }
                } catch (e) {
                    console.error('Failed to load statuses from DB', e);
                }
            },

            async saveNewStatus() {
                if (!this.newStatus.name || !this.newStatus.summary) return;
                try {
                    const payload = {type: 'add', ...this.newStatus};
                    await fetch('{% url "crosscheck:api_user_statuses" %}', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')},
                        body: JSON.stringify(payload),
                    });
                    this.availableStatuses.push({...this.newStatus});

                    if (this.effCounts[this.newStatus.name] === undefined) {
                        this.effCounts[this.newStatus.name] = 0;
                    }

                    this.newStatus = {name: '', summary: '', action: '', color: 'green'};
                    this.toastMsg = 'Status added to Database';
                    setTimeout(() => {
                        this.toastMsg = '';
                    }, 2000);
                } catch (e) {
                    console.error(e);
                }
            },

            async deleteStatus(index) {
                if (confirm('Are you sure you want to completely remove this status from the Database?')) {
                    const stat = this.availableStatuses[index];
                    try {
                        await fetch('{% url "crosscheck:api_user_statuses" %}', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')},
                            body: JSON.stringify({type: 'delete', name: stat.name}),
                        });
                        this.availableStatuses.splice(index, 1);
                    } catch (e) {
                        console.error(e);
                    }
                }
            },

            openDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('AutoCrosscheck_DB', 1);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('resultsCache')) db.createObjectStore('resultsCache', {keyPath: 'id'});
                    };
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            async getLocalCache(key) {
                const db = await this.openDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('resultsCache', 'readonly');
                    const req = tx.objectStore('resultsCache').get(key);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            },
            async setLocalCache(key, dataPayload) {
                const db = await this.openDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('resultsCache', 'readwrite');
                    tx.objectStore('resultsCache').put({id: key, timestamp: Date.now(), data: dataPayload});
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            },
            async clearLocalCache() {
                const db = await this.openDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction('resultsCache', 'readwrite');
                    const req = tx.objectStore('resultsCache').clear();
                    req.onsuccess = () => resolve();
                    req.onerror = () => reject(req.error);
                });
            },

            get startRecord() {
                return (this.page - 1) * this.pageSize + 1;
            },
            get endRecord() {
                return Math.min(this.page * this.pageSize, this.totalRows);
            },
            get uniqueHistoryFields() {
                return Array.from(new Set(this.historyLogs.map((l) => l.field))).sort();
            },
            get filteredHistoryLogs() {
                return !this.historyFilter ? this.historyLogs : this.historyLogs.filter((l) => l.field === this.historyFilter);
            },
            get hasUnsavedChanges() {
                return this.unsavedChanges.size > 0;
            },

            get filteredRows() {
                if (!this.search && this.filter === 'ALL') return this.rows;
                const term = this.search.toLowerCase();
                return this.rows.filter((row) => {
                    const matchesSearch = !term || (row.p_desc || '').toLowerCase().includes(term) || (row.p_inv || '').toLowerCase().includes(term) || (row.p_tin || '').toLowerCase().includes(term) || (row.d_data?.invoice_no || '').toLowerCase().includes(term) || (row.d_data?.tin || '').toLowerCase().includes(term);

                    let matchesFilter = false;
                    let effStatus = row.user_status ? row.user_status : this.statusText(row.status);

                    if (this.filter === 'ALL') {
                        matchesFilter = true;
                    } else {
                        matchesFilter = effStatus === this.filter;
                    }

                    return matchesSearch && matchesFilter;
                });
            },

            get orderedStats() {
                let stats = [];
                let added = new Set();

                this.availableStatuses.forEach((s) => {
                    stats.push({name: s.name, count: this.effCounts[s.name] || 0});
                    added.add(s.name);
                });

                for (let key in this.effCounts) {
                    if (!added.has(key)) {
                        stats.push({name: key, count: this.effCounts[key]});
                    }
                }
                return stats;
            },

            async loadStats() {
                if (!this.ovatrCode) return;
                try {
                    const res = await fetch(`{% url "crosscheck:get_stats" %}?ovatr_code=${this.ovatrCode}`);
                    const data = await res.json();
                    if (data.status === 'success') {
                        this.stats.local_count = data.local_count;
                        this.stats.import_count = data.import_count;
                    }
                } catch (e) {
                    console.error(e);
                }
            },

            applyData(data) {
                this.extractCompanyVatin(data.data);
                this.rows = data.data.map((r) => {
                    const d = r.d_data || {};
                    const newRow = {
                        ...r,
                        user_status: r.user_status || '',
                        p_comment: r.p_comment || '',
                        d_data: {
                            id: d.id || '',
                            date: this.formatDateStr(d.date || ''),
                            invoice_no: d.invoice_no || '',
                            credit_no: d.credit_no || '',
                            buyer_type: d.buyer_type || '',
                            tin: d.tin || '',
                            name: d.name || '',
                            total_amt: d.total_amt || 0,
                            excl_vat: d.excl_vat || 0,
                            non_vat: d.non_vat || 0,
                            vat_0: d.vat_0 || 0,
                            vat_local: d.vat_local || 0,
                            vat_export: d.vat_export || 0,
                            state_burden: d.state_burden || 0,
                            withheld: d.withheld || 0,
                            plt: d.plt || 0,
                            spec_goods: d.spec_goods || 0,
                            spec_serv: d.spec_serv || 0,
                            accom: d.accom || 0,
                            redemption: d.redemption || 0,
                            notes: d.notes || '',
                            desc: d.desc || '',
                            dec_status: d.dec_status || '',
                        },
                        _orig_d_inv: r.d_inv,
                        _orig_d_tin: r.d_tin,
                        _orig_d_date: r.d_date,
                        _session_history: {},
                    };
                    this.recalculate(newRow);
                    return newRow;
                });

                if (data.stats) {
                    this.stats.total = data.stats.total || 0;
                    const newEffCounts = data.stats.eff_counts || {};
                    this.availableStatuses.forEach((s) => {
                        if (newEffCounts[s.name] === undefined) newEffCounts[s.name] = 0;
                    });
                    this.effCounts = newEffCounts;
                }

                if (data.pagination) {
                    this.totalPages = data.pagination.total_pages;
                    this.totalRows = data.pagination.total_rows;
                    this.page = data.pagination.current_page;
                }
            },

            async fetchData() {
                if (!this.ovatrCode) return;
                this.loading = true;

                try {
                    const url = `{% url "crosscheck:get_results_data" %}?ovatr_code=${this.ovatrCode}&page=${this.page}&page_size=${this.pageSize}&table_type=${this.tableType}`;
                    const res = await fetch(url);
                    const data = await res.json();

                    if (data.status === 'success') {
                        this.extractCompanyVatin(data.data);
                        this.rows = data.data.map((r) => {
                            const d = r.d_data || {};
                            return {
                                ...r,
                                user_status: r.user_status || '',
                                p_comment: r.p_comment || '',
                                d_data: {
                                    id: d.id || '',
                                    date: this.formatDateStr(d.date || ''),
                                    invoice_no: d.invoice_no || '',
                                    credit_no: d.credit_no || '',
                                    buyer_type: d.buyer_type || '',
                                    tin: d.tin || '',
                                    name: d.name || '',
                                    total_amt: d.total_amt || 0,
                                    excl_vat: d.excl_vat || 0,
                                    non_vat: d.non_vat || 0,
                                    vat_0: d.vat_0 || 0,
                                    vat_local: d.vat_local || 0,
                                    vat_export: d.vat_export || 0,
                                    state_burden: d.state_burden || 0,
                                    withheld: d.withheld || 0,
                                    plt: d.plt || 0,
                                    spec_goods: d.spec_goods || 0,
                                    spec_serv: d.spec_serv || 0,
                                    accom: d.accom || 0,
                                    redemption: d.redemption || 0,
                                    notes: d.notes || '',
                                    desc: d.desc || '',
                                    dec_status: d.dec_status || '',
                                },
                                _orig_d_inv: r.d_inv,
                                _orig_d_tin: r.d_tin,
                                _orig_d_date: r.d_date,
                                _session_history: {},
                            };
                        });

                        this.stats.total = data.stats.total;
                        this.stats.matched = data.stats.matched;
                        this.stats.not_found = data.stats.not_found;
                        this.stats.mismatch = data.stats.mismatch;

                        this.stats.eff_counts = data.stats.eff_counts || {};

                        const newEffCounts = data.stats.eff_counts || {};
                        this.availableStatuses.forEach((s) => {
                            if (newEffCounts[s.name] === undefined) newEffCounts[s.name] = 0;
                        });
                        this.effCounts = newEffCounts;

                        if (data.pagination) {
                            this.totalPages = data.pagination.total_pages;
                            this.totalRows = data.pagination.total_rows;
                            this.page = data.pagination.current_page;
                        }
                    }
                } catch (e) {
                    console.error('Fetch Data Error:', e);
                } finally {
                    this.loading = false;
                    this.scrollToTop();
                }
            },

            handleScroll(el) {
                this.showScrollTop = el.scrollTop > 200;
            },
            scrollToTop() {
                const el = document.getElementById('tableContainer');
                if (el) el.scrollTo({top: 0, behavior: 'smooth'});
            },
            changePage(newPage) {
                if (newPage < 1 || newPage > this.totalPages) return;
                this.page = newPage;
                this.fetchData();
            },
            handlePageSizeChange() {
                if (this.pageSizePreset !== 'custom') {
                    this.pageSize = parseInt(this.pageSizePreset);
                    this.page = 1;
                    this.fetchData();
                }
            },
            changePageSize() {
                if (this.pageSize > 0) {
                    this.page = 1;
                    this.fetchData();
                }
            },

            pushHistoryAction(rowId, field, oldValue, newValue) {
                if (this.historyIndex < this.history.length - 1) this.history = this.history.slice(0, this.historyIndex + 1);
                this.history.push({rowId, field, oldValue, newValue});
                this.historyIndex++;
                const row = this.rows.find((r) => r.no === rowId);
                if (row) {
                    if (!row._session_history[field]) row._session_history[field] = {old: oldValue, new: newValue};
                    else row._session_history[field].new = newValue;
                }
                row.has_history = true;
            },
            setFieldValue(row, field, value) {
                if (field.includes('.')) {
                    const [obj, key] = field.split('.');
                    row[obj][key] = value;
                } else {
                    row[field] = value;
                }
            },
            undo() {
                if (this.historyIndex < 0) return;
                const action = this.history[this.historyIndex];
                const row = this.rows.find((r) => r.no === action.rowId);
                if (row) {
                    this.setFieldValue(row, action.field, action.oldValue);
                    this.recalculate(row);
                    this.autoSaveRow(row);
                }
                this.historyIndex--;
            },
            redo() {
                if (this.historyIndex >= this.history.length - 1) return;
                this.historyIndex++;
                const action = this.history[this.historyIndex];
                const row = this.rows.find((r) => r.no === action.rowId);
                if (row) {
                    this.setFieldValue(row, action.field, action.newValue);
                    this.recalculate(row);
                    this.autoSaveRow(row);
                }
            },
            restoreHistoryValue(log) {
                const row = this.rows.find((r) => r.no === String(this.historyRowId));
                if (!row) return;

                const field = log.field;
                let currentValue = field.includes('.') ? row[field.split('.')[0]][field.split('.')[1]] : row[field];
                const restoredValue = log.old_value;

                if (String(currentValue) === String(restoredValue)) return;

                let oldEffStatus = row.user_status ? row.user_status : this.statusText(row.status);

                this.setFieldValue(row, field, restoredValue);
                this.pushHistoryAction(row.no, field, currentValue, restoredValue);
                this.recalculate(row);

                let newEffStatus = row.user_status ? row.user_status : this.statusText(row.status);
                this.incrementStat(oldEffStatus, newEffStatus);

                this.autoSaveRow(row).then(() => {
                    if (this.showHistoryModal && String(this.historyRowId) === String(row.no)) {
                        this.viewHistory(row.no, true);
                    }
                });
            },

            editCell(row, field) {
                this.editing = {id: row.no, field};
                row._originalValue = field.includes('.') ? row[field.split('.')[0]][field.split('.')[1]] : row[field];
                this.$nextTick(() => {
                    const input = this.$el.querySelector('input, select');
                    if (input) input.focus();
                });
            },

            cancelEdit() {
                this.editing = {id: null, field: null};
            },

            stopEdit(row) {
                if (this.editing.id === null) return;

                try {
                    const field = this.editing.field;
                    let newValue = field.includes('.') ? row[field.split('.')[0]][field.split('.')[1]] : row[field];
                    const oldValue = row._originalValue;

                    this.editing = {id: null, field: null};

                    if (String(newValue) !== String(oldValue)) {
                        let oldEffStatus = row.user_status ? row.user_status : this.statusText(row.status);
                        if (field === 'user_status') oldEffStatus = oldValue ? oldValue : this.statusText(row.status);

                        this.pushHistoryAction(row.no, field, oldValue, newValue);
                        this.recalculate(row);

                        let newEffStatus = row.user_status ? row.user_status : this.statusText(row.status);
                        this.incrementStat(oldEffStatus, newEffStatus);

                        this.autoSaveRow(row);
                    }
                } catch (e) {
                    console.error('Save Crash Prevented:', e);
                    this.toastMsg = 'Error during save calculation: ' + e.message;
                    setTimeout(() => (this.toastMsg = ''), 4000);
                }
            },

            cleanInvoice(val) {
                return !val ? '' : String(val).replace(/[^a-zA-Z0-9]/g, '');
            },

            checkDateMatch(d1, d2) {
                if (!d1 || !d2) return false;
                const parse = (d) => {
                    let p = String(d)
                        .trim()
                        .split(/[-\/\sT]/);
                    if (p.length >= 3) {
                        if (p[0].length === 4) return {m: parseInt(p[1]), y: parseInt(p[0])};
                        if (p[2].length === 4) return {m: parseInt(p[1]), y: parseInt(p[2])};
                    }
                    return null;
                };
                let p1 = parse(d1);
                let p2 = parse(d2);
                if (p1 && p2) return p1.m === p2.m && p1.y === p2.y;
                return false;
            },

            recalculate(row) {
                if (this.editing.field !== 'p_inv_clean') row.p_inv_clean = this.cleanInvoice(row.p_inv);
                if (this.editing.field !== 'd_inv_clean') row.d_inv_clean = this.cleanInvoice(row.d_inv);

                const p_amt = parseFloat(row.p_amt) || 0;
                const d_amt = parseFloat(row.d_amt) || 0;

                const diff = d_amt - p_amt;
                row.v_diff = diff;

                row.v_inv = !!(row.p_inv_clean && row.d_inv_clean && row.p_inv_clean === row.d_inv_clean);

                if (this.companyVatin) {
                    let d_tin_clean = this.cleanInvoice(row.d_data?.tin || row.d_tin);
                    row.v_tin = !!(d_tin_clean && d_tin_clean === this.companyVatin);
                }

                row.v_date = this.checkDateMatch(row.p_date, row.d_date);

                const hasP = row.p_inv_clean !== '' || p_amt !== 0;
                const hasD = row.d_inv_clean !== '' || d_amt !== 0;

                if (hasP && !hasD) {
                    row.status = this.statusText('NOT FOUND');
                } else if (hasP && hasD && row.v_inv && row.v_date && row.v_tin) {
                    row.status = diff < -0.05 ? this.statusText('SHORTAGE') : this.statusText('MATCHED');
                } else if (hasP && hasD) {
                    row.status = this.statusText('MISMATCH');
                } else {
                    row.status = 'UNKNOWN';
                }
            },

            companyVatin: '',

            extractCompanyVatin(dataArray) {
                if (!this.companyVatin && dataArray && dataArray.length > 0) {
                    const validRow = dataArray.find((r) => r.v_tin && (r.d_tin || (r.d_data && r.d_data.tin)));
                    if (validRow) {
                        this.companyVatin = this.cleanInvoice(validRow.d_tin || validRow.d_data.tin);
                    }
                }
            },

            statusText(st) {
                const systemMap = {
                    MATCHED: 'បានប្រកាស (អនុញ្ញាត)',
                    SHORTAGE: 'អនុញ្ញាត (អ្នកផ្គត់ផ្គង់ប្រកាសខ្វះ)',
                    'NOT FOUND': 'ព្យួរទុក (មិនមានទិន្នន័យ)',
                    MISMATCH: 'ប្រកាសខុស (ព្យួរទុក)',
                };

                let targetName = systemMap[st] || st;

                let dbConfig = this.availableStatuses.find((s) => s.name === targetName);

                return dbConfig ? dbConfig.name : targetName;
            },

            async autoSaveRow(row) {
                this.autoSavePending++;
                this.isSaving = true;

                try {
                    const payload = {
                        ovatr: this.ovatrCode,
                        type: this.tableType,
                        no: String(row.no),
                        updates: {
                            p_desc: row.p_desc,
                            p_supp: row.p_supp,
                            p_inv: row.p_inv,
                            p_date: row.p_date,
                            p_amt: row.p_amt,
                            p_tin: row.p_tin,
                            p_comment: row.p_comment,
                            user_status: row.user_status,
                            d_inv: row.d_data.invoice_no,
                            d_tin: row.d_data.tin,
                            d_name: row.d_data.name,
                            d_date: row.d_data.date,
                            d_amt: row.d_data.total_amt,
                            d_data: row.d_data,
                            original_d_inv: row._orig_d_inv,
                            original_d_tin: row._orig_d_tin,
                            original_d_date: row._orig_d_date,
                        },
                        history: row._session_history,
                    };

                    const response = await fetch('{% url "crosscheck:update_result_row" %}', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')},
                        body: JSON.stringify(payload),
                    });

                    if (!response.ok) throw new Error(await response.text());
                    const resJson = await response.json();
                    if (resJson.status !== 'success') throw new Error(resJson.message);

                    row._session_history = {};
                    row._orig_d_inv = row.d_data.invoice_no;
                    row._orig_d_tin = row.d_data.tin;
                    row._orig_d_date = row.d_data.date;

                    await this.clearLocalCache();
                } catch (e) {
                    console.error('Auto-save failed', e);
                    this.toastMsg = 'Save failed! Reverting value...';
                    setTimeout(() => {
                        this.toastMsg = '';
                    }, 4000);

                    this.undo();
                } finally {
                    this.autoSavePending--;
                    if (this.autoSavePending <= 0) {
                        this.autoSavePending = 0;
                        this.isSaving = false;
                        this.unsavedChanges.clear();
                    }
                }
            },

            async viewHistory(rowId, silent = false) {
                this.historyRowId = rowId;
                if (!silent) {
                    this.historyLogs = [];
                    this.historyFilter = '';
                    this.showHistoryModal = true;
                }
                this.historyLoading = true;
                try {
                    const res = await fetch(`{% url "crosscheck:get_row_history" %}?ovatr=${this.ovatrCode}&no=${rowId}`);
                    const data = await res.json();
                    if (data.status === 'success') this.historyLogs = data.data;
                } catch (e) {
                    console.error(e);
                } finally {
                    this.historyLoading = false;
                }
            },

            switchTable(type) {
                if (this.tableType === type) return;
                this.tableType = type;
                this.page = 1;
                this.rows = [];
                this.history = [];
                this.historyIndex = -1;
                this.unsavedChanges.clear();
                this.fetchData();
            },

            forceCommitActiveEdit() {
                if (this.editing.id !== null) {
                    const row = this.rows.find((r) => r.no === this.editing.id);
                    if (row) this.stopEdit(row);
                }
            },

            async waitForPendingSaves() {
                if (this.autoSavePending > 0) {
                    this.toastMsg = 'Syncing changes to database... Please wait.';
                    while (this.autoSavePending > 0) {
                        await new Promise((resolve) => setTimeout(resolve, 200));
                    }
                }
            },

            async downloadFile() {
                this.forceCommitActiveEdit();
                await this.waitForPendingSaves();

                this.toastMsg = 'Exporting file...';
                setTimeout(() => (this.toastMsg = ''), 2000);
                window.location.href = "{% url 'crosscheck:download_report' %}?ovatr_code=" + this.ovatrCode;
            },

            async goToReport() {
                this.forceCommitActiveEdit();
                await this.waitForPendingSaves();
                window.location.href = "{% url 'crosscheck:report' %}?ovatr_code=" + this.ovatrCode;
            },

            async refreshData() {
                this.forceCommitActiveEdit();
                await this.waitForPendingSaves();
                this.fetchData();
            },
        }));
    });
</script>
{% endblock %}
