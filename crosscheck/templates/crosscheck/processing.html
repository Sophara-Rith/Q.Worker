{% extends 'base.html' %} {% load static %} {% block title %}Processing Report{% endblock %} {% block content %}
<div x-data="processingInterface()" x-init="initialize()" class="min-h-screen bg-gray-50 dark:bg-gray-900 flex flex-col items-center">
    <div class="w-full max-w-6xl bg-white dark:bg-gray-800 rounded-2xl shadow-xl overflow-hidden border border-gray-100 dark:border-gray-700">
        <div class="bg-white dark:bg-gray-800 px-8 py-6 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white flex items-center gap-3">
                    <span x-show="status === 'success'" class="text-green-500">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </span>
                    <span x-show="status === 'processing'" class="text-brand-600 animate-spin">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    </span>
                    <span x-show="status === 'paused'" class="text-orange-500">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </span>
                    <span x-show="status === 'error' || status === 'stopped'" class="text-red-500">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </span>
                    <span x-text="title"></span>
                </h1>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1 ml-11" x-text="subtitle"></p>
            </div>
            <div class="text-right">
                <div class="text-xs font-bold text-gray-400 uppercase tracking-wider">Session ID</div>
                <div class="font-mono text-lg text-brand-600 dark:text-brand-400 font-bold">{{ ovatr_code }}</div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 px-8 pt-8">
            <div class="bg-blue-50 dark:bg-blue-900/20 p-6 rounded-2xl border border-blue-100 dark:border-blue-800 relative overflow-hidden group hover:shadow-md transition-all">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <svg class="w-16 h-16 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                </div>
                <div class="text-xs font-bold text-blue-500 uppercase tracking-wider mb-2">Processed Records</div>
                <div class="flex items-baseline gap-1">
                    <span class="text-4xl font-bold text-blue-700 dark:text-blue-300" x-text="formatNumber(processedRows)">0</span>
                    <span class="text-sm text-blue-400 font-medium">/ <span x-text="formatNumber(totalRows)"></span></span>
                </div>
            </div>
            <div class="bg-green-50 dark:bg-green-900/20 p-6 rounded-2xl border border-green-100 dark:border-green-800 relative overflow-hidden group hover:shadow-md transition-all">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <svg class="w-16 h-16 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                </div>
                <div class="text-xs font-bold text-green-500 uppercase tracking-wider mb-2">Processing Speed</div>
                <div class="flex items-baseline gap-1">
                    <span class="text-4xl font-bold text-green-700 dark:text-green-300" x-text="speed">0</span>
                    <span class="text-sm text-green-500 font-medium">rows/s</span>
                </div>
            </div>
            <div class="bg-orange-50 dark:bg-orange-900/20 p-6 rounded-2xl border border-orange-100 dark:border-orange-800 relative overflow-hidden group hover:shadow-md transition-all">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <svg class="w-16 h-16 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <div class="text-xs font-bold text-orange-500 uppercase tracking-wider mb-2">Est. Remaining</div>
                <div class="text-4xl font-bold text-orange-700 dark:text-orange-300" x-text="eta">--:--</div>
            </div>
            <div class="bg-gray-50 dark:bg-gray-700/50 p-6 rounded-2xl border border-gray-200 dark:border-gray-600 relative overflow-hidden group hover:shadow-md transition-all">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <svg class="w-16 h-16 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path></svg>
                </div>
                <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Memory Usage</div>
                <div class="flex items-baseline gap-1">
                    <span class="text-4xl font-bold text-gray-700 dark:text-gray-300" x-text="memoryUsage">0</span>
                    <span class="text-sm text-gray-400 font-medium">MB</span>
                </div>
            </div>
        </div>

        <div class="px-8 pt-8 pb-4">
            <div class="flex justify-between text-sm font-bold text-gray-600 dark:text-gray-300 mb-2">
                <span x-text="progressText" class="uppercase tracking-wide text-xs">Initializing...</span>
                <span x-text="progress + '%'">0%</span>
            </div>
            <div class="h-6 bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden shadow-inner relative">
                <div
                    class="h-full bg-brand-600 transition-all duration-300 ease-out flex items-center justify-center"
                    :class="{
                        'bg-orange-500': status === 'paused', 
                        'bg-red-500': status === 'stopped', 
                        'bg-green-500': status === 'success',
                        'bg-brand-600': status === 'processing'
                    }"
                    :style="`width: ${progress}%`"
                >
                    <div
                        x-show="status === 'processing'"
                        class="w-full h-full opacity-30 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PHBhdHRlcm4gaWQ9InAiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+PHBhdGggZD0iTTAgNDBMODAgMEg0MEwwIDQwWiIgZmlsbD0id2hpdGUiLz48L3BhdHRlcm4+PC9kZWZzPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjcCkiLz48L3N2Zz4=')] animate-[slide_1s_linear_infinite]"
                    ></div>
                </div>
            </div>
        </div>

        <div class="px-8 pb-8 flex flex-col-reverse lg:flex-row gap-6">
            <div class="flex-1 bg-gray-900 text-green-400 font-mono text-xs p-4 rounded-xl shadow-inner h-64 overflow-y-auto border border-gray-700 scroll-smooth" id="terminal">
                <template x-for="(log, index) in logs" :key="index">
                    <div class="mb-1 opacity-90 border-l-2 border-transparent hover:border-green-500 pl-2 transition-all break-words">
                        <span class="text-gray-500 select-none" x-text="log.time"></span>
                        <span x-text="log.message"></span>
                    </div>
                </template>
                <div x-show="status === 'processing'" class="animate-pulse mt-2">_</div>
            </div>

            <div class="w-full lg:w-64 flex flex-col gap-4 justify-end pb-1">
                <div x-show="status === 'processing' || status === 'paused'" x-transition class="flex flex-col gap-3">
                    <button @click="togglePause()" class="w-full py-4 px-6 rounded-xl font-bold text-white shadow-lg shadow-orange-500/30 transform hover:-translate-y-1 transition-all flex items-center justify-center gap-3" :class="status === 'paused' ? 'bg-blue-600 hover:bg-blue-700 shadow-blue-500/30' : 'bg-orange-500 hover:bg-orange-600'">
                        <svg x-show="status !== 'paused'" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6"></path></svg>
                        <svg x-show="status === 'paused'" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span x-text="status === 'paused' ? 'RESUME PROCESS' : 'PAUSE PROCESS'"></span>
                    </button>
                    <button @click="stopProcessing()" class="w-full py-4 px-6 rounded-xl font-bold text-white bg-red-600 hover:bg-red-700 shadow-lg shadow-red-500/30 transform hover:-translate-y-1 transition-all flex items-center justify-center gap-3">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path>
                        </svg>
                        <span>STOP OPERATION</span>
                    </button>
                </div>

                <div x-show="status === 'success'" x-transition class="flex flex-col gap-3">
                    <div class="bg-green-50 border border-green-200 rounded-xl p-3 text-center mb-1">
                        <p class="text-green-700 font-bold text-sm">Process Complete</p>
                    </div>

                    <a :href="'{% url 'crosscheck:results' %}?ovatr_code=' + ovatrCode" class="w-full py-4 px-6 bg-brand-600 hover:bg-brand-700 text-white font-bold rounded-xl shadow-lg shadow-brand-500/30 transform hover:-translate-y-1 transition-all flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        View Results
                    </a>

                    <button @click="downloadFile()" class="w-full py-3 px-6 bg-white border border-gray-200 text-gray-600 hover:text-gray-900 hover:bg-gray-50 font-bold rounded-xl shadow-sm flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Download File
                    </button>
                </div>

                <div x-show="status === 'error' || status === 'stopped'" x-transition class="flex flex-col gap-3">
                    <button @click="retry()" class="w-full py-4 px-6 bg-brand-600 hover:bg-brand-700 text-white font-bold rounded-xl shadow-lg flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        Restart Operation
                    </button>
                    <a href="{% url 'crosscheck:new' %}" class="block text-center text-sm text-gray-500 hover:text-gray-700 py-2">Return to Dashboard</a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    @keyframes slide {
        from {
            background-position: 0 0;
        }
        to {
            background-position: 40px 0;
        }
    }
</style>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('processingInterface', () => ({
            status: 'idle',
            title: 'Initializing System...',
            subtitle: 'Preparing data consolidation engine',
            progress: 0,
            progressText: 'Waiting...',
            totalRows: 0,
            processedRows: 0,
            speed: 0,
            eta: '--:--',
            memoryUsage: 0,
            logs: [],
            ovatrCode: '{{ ovatr_code }}',
            abortController: null,
            isPaused: false,
            isServerDone: false,
            milestones: {},
            redirectUrl: null,

            formatNumber(num) {
                return new Intl.NumberFormat('en-US').format(num);
            },

            addLog(msg) {
                const time = new Date().toLocaleTimeString('en-US', {hour12: false, hour: 'numeric', minute: 'numeric', second: 'numeric'});
                this.logs.push({time: `[${time}]`, message: msg});
                this.$nextTick(() => {
                    const term = document.getElementById('terminal');
                    if (term) term.scrollTop = term.scrollHeight;
                });
            },

            async initialize() {
                if (!this.ovatrCode) {
                    this.fail('Session ID (OVATR) is missing. Please start a New Crosscheck.');
                    return;
                }
                try {
                    this.addLog('Initializing secure session...');
                    const res = await fetch(`{% url "crosscheck:get_stats" %}?ovatr_code=${this.ovatrCode}`);
                    const data = await res.json();

                    if (data.status === 'success') {
                        this.totalRows = data.total_rows || 1000;
                        // FIXED: Now accessing purchase_count safely
                        const pCount = data.purchase_count || data.local_count + data.import_count;
                        this.addLog(`Data Inventory: ${pCount} Purchases / ${data.declaration_count} Declarations`);

                        if (data.is_ready) {
                            this.processedRows = this.totalRows;
                            this.progress = 100;
                            this.status = 'success';
                            this.title = 'Process Completed';
                            this.subtitle = 'Report is ready';
                            this.addLog('Existing report found. Ready to view.');
                            this.finishSuccess(false);
                        } else {
                            this.startProcessing();
                        }
                    } else {
                        this.fail(data.message);
                    }
                } catch (e) {
                    this.fail('Failed to fetch statistics: ' + e.message);
                }
            },

            async startProcessing() {
                this.status = 'processing';
                this.processedRows = 0;
                this.progress = 0;
                this.isServerDone = false;
                this.milestones = {};
                this.abortController = new AbortController();

                this.title = 'Processing Data';
                this.subtitle = 'Analyzing and generating report';

                await this.simulateProgress(0, 5, 200);
                if (this.checkStopped()) return;

                this.progressText = 'Cross-referencing Data...';
                this.addLog(`Submitting Query: SELECT * FROM purchase WHERE ovatr='${this.ovatrCode}'`);

                const fetchPromise = fetch(`{% url "crosscheck:generate_annex3" %}?ovatr_code=${this.ovatrCode}`, {
                    signal: this.abortController.signal,
                })
                    .then(async (response) => {
                        if (!response.ok) throw new Error('HTTP Error: ' + response.status);
                        const contentType = response.headers.get('content-type');

                        if (contentType && contentType.includes('application/json')) {
                            const json = await response.json();
                            if (json.status === 'success') {
                                this.redirectUrl = json.redirect_url;
                                this.isServerDone = true;
                                return;
                            } else {
                                throw new Error(json.message || 'Server Error');
                            }
                        }
                        const blob = await response.blob();
                        this.isServerDone = true;
                        return blob;
                    })
                    .catch((error) => {
                        if (error.name !== 'AbortError') this.fail(error.message);
                        this.isServerDone = true;
                    });

                const simulatedSpeed = 1500;
                const estimatedDuration = Math.max(3000, (this.totalRows / simulatedSpeed) * 1000);

                await this.simulateMetrics(estimatedDuration);

                if (this.status === 'processing') {
                    this.finishSuccess(true);
                }
            },

            finishSuccess(shouldRedirect = true) {
                this.processedRows = this.totalRows;
                this.progress = 100;
                this.speed = 0;
                this.eta = '00:00';
                this.status = 'success';
                this.title = 'Process Completed';
                this.subtitle = 'Redirecting to results analysis...';

                this.addLog('File generated successfully.');

                if (shouldRedirect) {
                    this.addLog('Redirecting to Results Dashboard...');
                    setTimeout(() => {
                        if (this.redirectUrl) {
                            window.location.href = this.redirectUrl;
                        } else {
                            window.location.href = "{% url 'crosscheck:results' %}?ovatr_code=" + this.ovatrCode;
                        }
                    }, 2000);
                }
            },

            simulateMetrics(duration) {
                return new Promise((resolve) => {
                    const startTime = Date.now();
                    let lastUpdate = startTime;
                    let pausedDuration = 0;
                    let pauseStartTime = 0;

                    const step = () => {
                        if (this.checkStopped()) {
                            resolve();
                            return;
                        }
                        if (this.isServerDone) {
                            this.progress = 100;
                            this.processedRows = this.totalRows;
                            resolve();
                            return;
                        }
                        if (this.isPaused) {
                            if (!pauseStartTime) pauseStartTime = Date.now();
                            requestAnimationFrame(step);
                            return;
                        }
                        if (pauseStartTime) {
                            pausedDuration += Date.now() - pauseStartTime;
                            pauseStartTime = 0;
                        }

                        const now = Date.now();
                        const elapsed = now - startTime - pausedDuration;
                        const pct = Math.min(elapsed / duration, 0.99);

                        this.processedRows = Math.floor(this.totalRows * pct);
                        this.progress = Math.floor(pct * 100);

                        if (pct > 0.15 && !this.milestones['15']) {
                            this.addLog('Loading Purchase Ledger...');
                            this.milestones['15'] = true;
                        }
                        if (pct > 0.55 && !this.milestones['55']) {
                            this.addLog('Verifying Invoice Dates...');
                            this.milestones['55'] = true;
                        }
                        if (pct > 0.9 && !this.milestones['90']) {
                            this.addLog('Finalizing styles...');
                            this.milestones['90'] = true;
                        }

                        if (now - lastUpdate > 500) {
                            const seconds = elapsed / 1000;
                            this.speed = seconds > 0 ? Math.floor(this.processedRows / seconds) : 0;
                            const remainingRows = this.totalRows - this.processedRows;
                            const remainingSeconds = this.speed > 0 ? Math.floor(remainingRows / this.speed) : 0;
                            this.eta = new Date(remainingSeconds * 1000).toISOString().substr(14, 5);
                            this.memoryUsage = 40 + Math.floor(Math.random() * 20);
                            lastUpdate = now;
                        }
                        requestAnimationFrame(step);
                    };
                    requestAnimationFrame(step);
                });
            },

            simulateProgress(start, end, duration) {
                return new Promise((resolve) => {
                    const startTime = Date.now();
                    const step = () => {
                        if (this.checkStopped()) {
                            resolve();
                            return;
                        }
                        const elapsed = Date.now() - startTime;
                        const pct = Math.min(elapsed / duration, 1);
                        this.progress = Math.floor(start + (end - start) * pct);
                        if (pct < 1) requestAnimationFrame(step);
                        else resolve();
                    };
                    requestAnimationFrame(step);
                });
            },

            togglePause() {
                this.isPaused = !this.isPaused;
                this.status = this.isPaused ? 'paused' : 'processing';
                this.addLog(this.isPaused ? 'âš ï¸ Process paused.' : 'â–¶ï¸ Process resumed.');
            },

            stopProcessing() {
                if (confirm('Stop processing?')) {
                    this.status = 'stopped';
                    this.progressText = 'Stopped';
                    if (this.abortController) this.abortController.abort();
                    this.addLog('ðŸ›‘ STOP Signal received.');
                }
            },

            checkStopped() {
                return this.status === 'stopped' || this.status === 'error';
            },
            downloadFile() {
                window.location.href = "{% url 'crosscheck:download_report' %}?ovatr_code=" + this.ovatrCode;
            },
            fail(msg) {
                this.status = 'error';
                this.addLog('CRITICAL ERROR: ' + msg);
            },
            retry() {
                this.initialize();
            },
        }));
    });
</script>
{% endblock %} }
