{% extends 'base.html' %} {% load static %} {% block title %}Processing Report{% endblock %} {% block content %}

<style>
    /* Custom Scrollbar for Terminal */
    .terminal-scrollbar::-webkit-scrollbar {
        width: 6px;
    }
    .terminal-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }
    .terminal-scrollbar::-webkit-scrollbar-thumb {
        background: #334155;
        border-radius: 10px;
    }
    .terminal-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #475569;
    }

    /* Progress Bar Shine Animation */
    @keyframes shimmer {
        0% {
            transform: translateX(-100%);
        }
        100% {
            transform: translateX(100%);
        }
    }
    .animate-shimmer {
        animation: shimmer 2s infinite linear;
    }

    /* Terminal Log Slide-In Animation */
    @keyframes log-slide-up {
        from {
            opacity: 0;
            transform: translateY(6px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<div class="min-h-[calc(100vh-4rem)] flex items-center justify-center p-6 bg-slate-50 dark:bg-[#0f172a]" x-data="processingInterface()" x-init="initialize()">
    <div class="w-full max-w-5xl bg-white dark:bg-slate-800/80 backdrop-blur-xl rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-700/80 p-8 relative overflow-hidden">
        <div
            class="absolute top-0 left-1/2 -translate-x-1/2 w-[600px] h-[200px] blur-[100px] rounded-full pointer-events-none transition-colors duration-1000"
            :class="{
                 'bg-indigo-500/10': status === 'processing' || status === 'idle',
                 'bg-emerald-500/10': status === 'success',
                 'bg-rose-500/10': status === 'error' || status === 'stopped',
                 'bg-amber-500/10': status === 'paused'
             }"
        ></div>

        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 relative z-10">
            <div class="flex items-center gap-5">
                <div class="relative">
                    <div
                        class="absolute inset-0 rounded-full blur-md opacity-60 animate-pulse transition-colors duration-500"
                        :class="{
                             'bg-indigo-500': status === 'processing' || status === 'idle',
                             'bg-emerald-500': status === 'success',
                             'bg-rose-500': status === 'error' || status === 'stopped',
                             'bg-amber-500': status === 'paused'
                         }"
                    ></div>
                    <div
                        class="w-14 h-14 rounded-full flex items-center justify-center relative z-10 shadow-lg ring-1 ring-inset ring-white/20 transition-all duration-500"
                        :class="{
                             'bg-gradient-to-br from-indigo-400 to-violet-600': status === 'processing' || status === 'idle',
                             'bg-gradient-to-br from-emerald-400 to-green-600': status === 'success',
                             'bg-gradient-to-br from-rose-400 to-red-600': status === 'error' || status === 'stopped',
                             'bg-gradient-to-br from-amber-400 to-orange-600': status === 'paused'
                         }"
                    >
                        <svg x-show="status === 'success'" class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"></path>
                        </svg>

                        <svg x-show="status === 'processing' || status === 'idle'" class="w-7 h-7 text-white animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>

                        <svg x-show="status === 'paused'" class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M10 9v6m4-6v6"></path>
                        </svg>

                        <svg x-show="status === 'error' || status === 'stopped'" class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </div>
                </div>

                <div>
                    <h2
                        class="text-2xl font-extrabold text-slate-900 dark:text-white tracking-tight transition-colors duration-300"
                        x-text="title"
                        :class="{
                            'text-emerald-500': status === 'success',
                            'text-rose-500': status === 'error' || status === 'stopped',
                            'text-amber-500': status === 'paused'
                        }"
                    ></h2>
                    <p class="text-slate-500 dark:text-slate-400 text-sm mt-1 font-medium" x-text="subtitle"></p>
                </div>
            </div>

            <div class="mt-4 md:mt-0 flex items-center">
                <div x-show="ovatrCode" x-transition class="flex items-center gap-2.5 bg-indigo-500/10 border border-indigo-500/20 px-3.5 py-2 rounded-lg shadow-inner ring-1 ring-inset ring-indigo-500/20">
                    <span class="text-[10px] font-bold text-indigo-600 dark:text-indigo-400 uppercase tracking-widest opacity-80">Session ID</span>
                    <span class="text-xs font-mono font-bold text-indigo-700 dark:text-indigo-300 leading-none" x-text="ovatrCode"></span>
                    <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse shadow-[0_0_8px_rgba(16,185,129,0.8)]"></div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10 relative z-10">
            <div class="relative overflow-hidden rounded-xl border border-blue-200 dark:border-blue-500/30 bg-white dark:bg-gradient-to-br dark:from-blue-900/40 dark:to-[#0b1121] p-5 shadow-[0_4px_15px_-3px_rgba(59,130,246,0.1)] dark:shadow-[0_4px_20px_-4px_rgba(59,130,246,0.15)] ring-1 ring-inset ring-blue-500/10 dark:ring-blue-500/20 group">
                <div class="absolute -right-6 -top-6 w-24 h-24 bg-blue-500/10 dark:bg-blue-500/20 rounded-full blur-2xl group-hover:bg-blue-500/20 dark:group-hover:bg-blue-500/30 transition-all duration-500"></div>
                <div class="flex justify-between items-start relative z-10">
                    <div>
                        <p class="text-[10px] font-bold text-blue-600 dark:text-blue-400 uppercase tracking-widest mb-1.5">Processed Records</p>
                        <h3 class="text-3xl font-black text-slate-800 dark:text-white tracking-tight">
                            <span x-text="formatNumber(processedRows)">0</span>
                            <span class="text-sm font-medium text-slate-400 dark:text-slate-500">/<span x-text="formatNumber(totalRows)"></span></span>
                        </h3>
                    </div>
                    <div class="p-2 bg-blue-50 dark:bg-blue-500/10 rounded-lg">
                        <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                    </div>
                </div>
            </div>

            <div class="relative overflow-hidden rounded-xl border border-emerald-200 dark:border-emerald-500/30 bg-white dark:bg-gradient-to-br dark:from-emerald-900/40 dark:to-[#0b1121] p-5 shadow-[0_4px_15px_-3px_rgba(16,185,129,0.1)] dark:shadow-[0_4px_20px_-4px_rgba(16,185,129,0.15)] ring-1 ring-inset ring-emerald-500/10 dark:ring-emerald-500/20 group">
                <div class="absolute -right-6 -top-6 w-24 h-24 bg-emerald-500/10 dark:bg-emerald-500/20 rounded-full blur-2xl group-hover:bg-emerald-500/20 dark:group-hover:bg-emerald-500/30 transition-all duration-500"></div>
                <div class="flex justify-between items-start relative z-10">
                    <div>
                        <p class="text-[10px] font-bold text-emerald-600 dark:text-emerald-400 uppercase tracking-widest mb-1.5">Processing Speed</p>
                        <h3 class="text-3xl font-black text-slate-800 dark:text-white tracking-tight">
                            <span x-text="speed">0</span>
                            <span class="text-sm font-medium text-slate-400 dark:text-slate-500">rows/s</span>
                        </h3>
                    </div>
                    <div class="p-2 bg-emerald-50 dark:bg-emerald-500/10 rounded-lg">
                        <svg class="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    </div>
                </div>
            </div>

            <div class="relative overflow-hidden rounded-xl border border-orange-200 dark:border-orange-500/30 bg-white dark:bg-gradient-to-br dark:from-orange-900/40 dark:to-[#0b1121] p-5 shadow-[0_4px_15px_-3px_rgba(249,115,22,0.1)] dark:shadow-[0_4px_20px_-4px_rgba(249,115,22,0.15)] ring-1 ring-inset ring-orange-500/10 dark:ring-orange-500/20 group">
                <div class="absolute -right-6 -top-6 w-24 h-24 bg-orange-500/10 dark:bg-orange-500/20 rounded-full blur-2xl group-hover:bg-orange-500/20 dark:group-hover:bg-orange-500/30 transition-all duration-500"></div>
                <div class="flex justify-between items-start relative z-10">
                    <div>
                        <p class="text-[10px] font-bold text-orange-600 dark:text-orange-400 uppercase tracking-widest mb-1.5">Est. Remaining</p>
                        <h3 class="text-3xl font-black text-slate-800 dark:text-white tracking-tight" x-text="eta">00:00</h3>
                    </div>
                    <div class="p-2 bg-orange-50 dark:bg-orange-500/10 rounded-lg">
                        <svg class="w-5 h-5 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                </div>
            </div>

            <div class="relative overflow-hidden rounded-xl border border-fuchsia-200 dark:border-fuchsia-500/30 bg-white dark:bg-gradient-to-br dark:from-fuchsia-900/40 dark:to-[#0b1121] p-5 shadow-[0_4px_15px_-3px_rgba(217,70,239,0.1)] dark:shadow-[0_4px_20px_-4px_rgba(217,70,239,0.15)] ring-1 ring-inset ring-fuchsia-500/10 dark:ring-fuchsia-500/20 group">
                <div class="absolute -right-6 -top-6 w-24 h-24 bg-fuchsia-500/10 dark:bg-fuchsia-500/20 rounded-full blur-2xl group-hover:bg-fuchsia-500/20 dark:group-hover:bg-fuchsia-500/30 transition-all duration-500"></div>
                <div class="flex justify-between items-start relative z-10">
                    <div>
                        <p class="text-[10px] font-bold text-fuchsia-600 dark:text-fuchsia-400 uppercase tracking-widest mb-1.5">Memory Usage</p>
                        <h3 class="text-3xl font-black text-slate-800 dark:text-white tracking-tight">
                            <span x-text="memoryUsage">0</span>
                            <span class="text-sm font-medium text-slate-400 dark:text-slate-500">MB</span>
                        </h3>
                    </div>
                    <div class="p-2 bg-fuchsia-50 dark:bg-fuchsia-500/10 rounded-lg">
                        <svg class="w-5 h-5 text-fuchsia-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path></svg>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-10 relative z-10">
            <div class="flex justify-between text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-2.5">
                <span
                    x-text="progressText"
                    :class="{
                    'text-emerald-500': status === 'success',
                    'text-rose-500': status === 'error' || status === 'stopped',
                    'text-amber-500': status === 'paused'
                }"
                    >Processing Phase...</span
                >
                <span
                    class="font-black"
                    :class="{
                          'text-emerald-600 dark:text-emerald-400': status === 'success',
                          'text-indigo-600 dark:text-indigo-400': status === 'processing' || status === 'idle',
                          'text-rose-600 dark:text-rose-400': status === 'error' || status === 'stopped',
                          'text-amber-600 dark:text-amber-400': status === 'paused'
                      }"
                    x-text="progress + '%'"
                    >0%</span
                >
            </div>

            <div class="h-4 w-full bg-slate-100 dark:bg-slate-900 rounded-full overflow-hidden shadow-inner ring-1 ring-inset ring-black/5 dark:ring-white/5">
                <div
                    class="h-full rounded-full transition-all duration-300 ease-out relative overflow-hidden flex items-center"
                    :class="{
                         'bg-gradient-to-r from-emerald-500 to-green-400 shadow-[0_0_15px_rgba(16,185,129,0.5)]': status === 'success',
                         'bg-gradient-to-r from-indigo-500 to-violet-500 shadow-[0_0_15px_rgba(99,102,241,0.5)]': status === 'processing' || status === 'idle',
                         'bg-gradient-to-r from-rose-500 to-red-500 shadow-[0_0_15px_rgba(225,29,72,0.5)]': status === 'error' || status === 'stopped',
                         'bg-gradient-to-r from-amber-500 to-orange-400 shadow-[0_0_15px_rgba(245,158,11,0.5)]': status === 'paused'
                     }"
                    :style="`width: ${progress}%`"
                >
                    <div
                        x-show="status === 'processing'"
                        class="w-full h-full opacity-30 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PHBhdHRlcm4gaWQ9InAiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+PHBhdGggZD0iTTAgNDBMODAgMEg0MEwwIDQwWiIgZmlsbD0id2hpdGUiLz48L3BhdHRlcm4+PC9kZWZzPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjcCkiLz48L3N2Zz4=')] animate-[slide_1s_linear_infinite]"
                    ></div>
                    <div x-show="status === 'processing'" class="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent w-[200%] animate-shimmer"></div>
                </div>
            </div>
        </div>

        <div class="flex flex-col lg:flex-row gap-6 relative z-10 h-64">
            <div class="flex-1 bg-[#090e17] rounded-xl border border-slate-700/80 shadow-2xl flex flex-col overflow-hidden ring-1 ring-inset ring-white/5 relative">
                <div class="bg-slate-800/90 px-4 py-3 border-b border-slate-700/80 flex items-center gap-2 relative z-10 shadow-sm">
                    <div class="flex gap-1.5">
                        <div class="w-3 h-3 rounded-full bg-rose-500/90 shadow-[0_0_5px_rgba(244,63,94,0.5)]"></div>
                        <div class="w-3 h-3 rounded-full bg-amber-500/90 shadow-[0_0_5px_rgba(245,158,11,0.5)]"></div>
                        <div class="w-3 h-3 rounded-full bg-emerald-500/90 shadow-[0_0_5px_rgba(16,185,129,0.5)]"></div>
                    </div>
                    <div class="absolute left-0 right-0 text-center pointer-events-none">
                        <span class="text-[10px] font-mono text-slate-400 font-bold uppercase tracking-widest flex items-center justify-center gap-1.5">
                            <svg class="w-3 h-3 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M4 17h16a2 2 0 002-2V9a2 2 0 00-2-2H4a2 2 0 00-2 2v6a2 2 0 002 2z"></path></svg>
                            system.log
                        </span>
                    </div>
                </div>

                <div class="p-4 font-mono text-[11.5px] h-full overflow-y-auto terminal-scrollbar leading-relaxed flex flex-col relative z-0" id="terminal" style="scroll-behavior: smooth">
                    <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4wNCkiLz48L3N2Zz4=')] opacity-50 pointer-events-none"></div>

                    <div class="relative z-10 flex flex-col gap-0.5">
                        <template x-for="(log, i) in logs" :key="i">
                            <div class="flex items-start gap-3 hover:bg-white/[0.04] px-2 py-1 rounded transition-colors group animate-[log-slide-up_0.2s_ease-out]">
                                <span class="text-slate-500 shrink-0 select-none font-medium" x-text="log.time"></span>

                                <span
                                    class="shrink-0 select-none font-bold tracking-wide"
                                    :class="{
                                          'text-emerald-500': log.type === 'success',
                                          'text-rose-500': log.type === 'error',
                                          'text-amber-500': log.type === 'warning',
                                          'text-indigo-400': log.type === 'info' || !log.type
                                      }"
                                    x-text="log.type === 'success' ? '[OK] ' : (log.type === 'error' ? '[ERR]' : (log.type === 'warning' ? '[WRN]' : '[SYS]'))"
                                >
                                </span>

                                <span
                                    class="break-words"
                                    :class="{
                                          'text-emerald-300 font-medium': log.type === 'success',
                                          'text-rose-300 font-medium': log.type === 'error',
                                          'text-amber-300': log.type === 'warning',
                                          'text-slate-300': log.type === 'info' || !log.type
                                      }"
                                    x-text="log.message"
                                ></span>
                            </div>
                        </template>

                        <div x-show="status === 'processing'" class="flex items-center gap-3 px-2 py-1 mt-1">
                            <span class="text-indigo-500 font-bold select-none tracking-wide">[SYS]</span>
                            <span class="w-2 h-3.5 bg-slate-400 animate-[pulse_1s_cubic-bezier(0.4,0,0.6,1)_infinite]"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="w-full lg:w-64 flex flex-col gap-3 justify-end">
                <div x-show="status === 'processing' || status === 'paused'" x-transition class="flex flex-col gap-3">
                    <button
                        @click="togglePause()"
                        class="w-full py-3.5 px-4 rounded-xl font-bold text-sm text-white shadow-lg transition-all flex items-center justify-center gap-2 ring-1 ring-inset ring-white/20"
                        :class="status === 'paused' ? 'bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 shadow-blue-500/30' : 'bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-400 hover:to-orange-500 shadow-orange-500/30'"
                    >
                        <svg x-show="status !== 'paused'" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M10 9v6m4-6v6"></path></svg>
                        <svg x-show="status === 'paused'" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span x-text="status === 'paused' ? 'Resume Process' : 'Pause Process'"></span>
                    </button>

                    <button @click="stopProcessing()" class="w-full py-3.5 px-4 rounded-xl font-bold text-sm text-white bg-gradient-to-r from-rose-600 to-red-600 hover:from-rose-500 hover:to-red-500 shadow-lg shadow-rose-500/30 transition-all flex items-center justify-center gap-2 ring-1 ring-inset ring-white/20">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path>
                        </svg>
                        <span>Stop Operation</span>
                    </button>
                </div>

                <div x-show="status === 'success'" x-transition class="flex flex-col gap-3">
                    <div class="bg-emerald-50 dark:bg-emerald-500/10 border border-emerald-200 dark:border-emerald-500/30 rounded-xl p-3 text-center mb-1 ring-1 ring-inset ring-emerald-500/20">
                        <p class="text-emerald-700 dark:text-emerald-400 font-bold text-sm tracking-wide">Process Complete</p>
                    </div>

                    <a :href="'{% url 'crosscheck:results' %}?ovatr_code=' + ovatrCode" class="w-full py-3.5 px-4 bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 text-white font-bold text-sm rounded-xl shadow-lg shadow-indigo-500/30 transition-all flex items-center justify-center gap-2 ring-1 ring-inset ring-white/20">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                        View Results
                    </a>

                    <button @click="downloadFile()" class="w-full py-3 px-4 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 hover:text-slate-900 dark:hover:text-white hover:bg-slate-50 dark:hover:bg-slate-700 font-bold text-sm rounded-xl shadow-sm flex items-center justify-center gap-2 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Download File
                    </button>
                </div>

                <div x-show="status === 'error' || status === 'stopped'" x-transition class="flex flex-col gap-3">
                    <button @click="retry()" class="w-full py-4 px-6 bg-gradient-to-r from-indigo-600 to-blue-600 hover:from-indigo-500 hover:to-blue-500 text-white font-bold rounded-xl shadow-lg shadow-indigo-500/30 flex items-center justify-center gap-2 ring-1 ring-inset ring-white/20 transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        Restart Operation
                    </button>
                    <a href="{% url 'crosscheck:new' %}" class="block text-center text-sm font-bold text-slate-500 hover:text-indigo-500 dark:hover:text-indigo-400 py-2 transition-colors">Return to Dashboard</a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    @keyframes slide {
        from {
            background-position: 0 0;
        }
        to {
            background-position: 40px 0;
        }
    }
</style>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('processingInterface', () => ({
            status: 'idle',
            title: 'Initializing System...',
            subtitle: 'Preparing data consolidation engine',
            progress: 0,
            progressText: 'Waiting...',
            totalRows: 0,
            processedRows: 0,
            speed: 0,
            eta: '--:--',
            memoryUsage: 0,
            logs: [],
            ovatrCode: '{{ ovatr_code }}',
            abortController: null,
            isPaused: false,
            isServerDone: false,
            milestones: {},

            get isComplete() {
                return this.status === 'success';
            },

            formatNumber(num) {
                return new Intl.NumberFormat('en-US').format(num);
            },

            addLog(msg, type = 'info') {
                const time = new Date().toLocaleTimeString('en-US', {hour12: false, hour: 'numeric', minute: 'numeric', second: 'numeric'});
                this.logs.push({time: `[${time}]`, message: msg, type: type});
                this.$nextTick(() => {
                    const term = document.getElementById('terminal');
                    if (term) term.scrollTop = term.scrollHeight;
                });
            },

            async initialize() {
                if (!this.ovatrCode) {
                    this.fail('Session ID (OVATR) is missing. Please start a New Crosscheck.');
                    return;
                }
                try {
                    this.addLog('Initializing secure session...', 'info');
                    // Check if already processed using stats API
                    const res = await fetch(`{% url "crosscheck:get_stats" %}?ovatr_code=${this.ovatrCode}`);
                    const data = await res.json();

                    if (data.status === 'success') {
                        this.totalRows = data.total_rows || 1000;
                        const pCount = data.purchase_count || data.local_count + data.import_count;
                        this.addLog(`Data Inventory: ${pCount} Purchases / ${data.declaration_count} Declarations`, 'info');

                        // Check if the results are already calculated and stored in DB
                        // If match_rate > 0 or status is Completed, we skip reprocessing
                        if (data.status === 'Completed' || data.is_ready) {
                            this.processedRows = this.totalRows;
                            this.progress = 100;
                            this.status = 'success';
                            this.title = 'Process Completed';
                            this.subtitle = 'Report is ready';
                            this.addLog('Existing calculations found. Ready to view.', 'success');
                            this.finishSuccess(false);
                        } else {
                            this.startProcessing();
                        }
                    } else {
                        this.fail(data.message);
                    }
                } catch (e) {
                    this.fail('Failed to fetch statistics: ' + e.message);
                }
            },

            async startProcessing() {
                this.status = 'processing';
                this.processedRows = 0;
                this.progress = 0;
                this.isServerDone = false;
                this.milestones = {};
                this.abortController = new AbortController();

                this.title = 'Processing Data';
                this.subtitle = 'Running exact match and bulk database update';

                await this.simulateProgress(0, 5, 200);
                if (this.checkStopped()) return;

                this.progressText = 'Cross-referencing Data...';
                this.addLog(`Initiating Write-Time Engine for Session: ${this.ovatrCode}`, 'info');

                // NEW API: Calling the Pre-Calculation Engine via POST
                const fetchPromise = fetch(`{% url "crosscheck:run_processing_engine" %}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ovatr_code: this.ovatrCode}),
                    signal: this.abortController.signal,
                })
                    .then(async (response) => {
                        if (!response.ok) throw new Error('HTTP Error: ' + response.status);
                        const json = await response.json();

                        if (json.status === 'success') {
                            this.isServerDone = true;
                            this.addLog(json.message, 'success');
                            return;
                        } else {
                            throw new Error(json.message || 'Server Error');
                        }
                    })
                    .catch((error) => {
                        if (error.name !== 'AbortError') this.fail(error.message);
                        this.isServerDone = true;
                    });

                const simulatedSpeed = 1500;
                const estimatedDuration = Math.max(3000, (this.totalRows / simulatedSpeed) * 1000);

                await this.simulateMetrics(estimatedDuration);

                if (this.status === 'processing') {
                    this.finishSuccess(true);
                }
            },

            finishSuccess(shouldRedirect = true) {
                this.processedRows = this.totalRows;
                this.progress = 100;
                this.speed = 0;
                this.eta = '00:00';
                this.status = 'success';
                this.title = 'Process Completed';
                this.subtitle = 'Data written and verified in Data Warehouse.';

                this.addLog('Database updated successfully. OLAP ready.', 'success');

                if (shouldRedirect) {
                    this.addLog('Redirecting to Results Dashboard...', 'success');
                    setTimeout(() => {
                        window.location.href = "{% url 'crosscheck:results' %}?ovatr_code=" + this.ovatrCode;
                    }, 2000);
                }
            },

            simulateMetrics(duration) {
                return new Promise((resolve) => {
                    const startTime = Date.now();
                    let lastUpdate = startTime;
                    let lastProcessedRows = 0; // NEW: Track rows processed in the last tick
                    let pausedDuration = 0;
                    let pauseStartTime = 0;

                    const step = () => {
                        if (this.checkStopped()) {
                            resolve();
                            return;
                        }
                        if (this.isServerDone) {
                            this.progress = 100;
                            this.processedRows = this.totalRows;
                            resolve();
                            return;
                        }
                        if (this.isPaused) {
                            if (!pauseStartTime) pauseStartTime = Date.now();
                            requestAnimationFrame(step);
                            return;
                        }
                        if (pauseStartTime) {
                            pausedDuration += Date.now() - pauseStartTime;
                            pauseStartTime = 0;
                        }

                        const now = Date.now();
                        const elapsed = now - startTime - pausedDuration;
                        const pct = Math.min(elapsed / duration, 0.99);

                        this.processedRows = Math.floor(this.totalRows * pct);
                        this.progress = Math.floor(pct * 100);

                        // Trigger Log Milestones
                        if (pct > 0.15 && !this.milestones['15']) {
                            this.addLog('Extracting and mapping dictionary memory...', 'info');
                            this.milestones['15'] = true;
                        }
                        if (pct > 0.55 && !this.milestones['55']) {
                            this.addLog('Executing Bulk UPDATE across all tables...', 'info');
                            this.milestones['55'] = true;
                        }
                        if (pct > 0.9 && !this.milestones['90']) {
                            this.addLog('Finalizing commits...', 'info');
                            this.milestones['90'] = true;
                        }

                        // UPDATE UI EVERY 500ms
                        if (now - lastUpdate > 500) {
                            const deltaSeconds = (now - lastUpdate) / 1000;
                            const deltaRows = this.processedRows - lastProcessedRows;

                            // Calculate REAL-TIME speed with a slight Â±10% CPU jitter for realism
                            if (deltaSeconds > 0) {
                                const rawSpeed = deltaRows / deltaSeconds;
                                const jitter = 0.9 + Math.random() * 0.2;
                                this.speed = Math.floor(rawSpeed * jitter);
                            } else {
                                this.speed = 0;
                            }

                            // Calculate ETA based on current real-time speed
                            const remainingRows = this.totalRows - this.processedRows;
                            const remainingSeconds = this.speed > 0 ? Math.ceil(remainingRows / this.speed) : 0;

                            // Format ETA cleanly as MM:SS
                            const m = Math.floor(remainingSeconds / 60)
                                .toString()
                                .padStart(2, '0');
                            const s = (remainingSeconds % 60).toString().padStart(2, '0');
                            this.eta = `${m}:${s}`;

                            // Fluctuate memory usage slightly
                            this.memoryUsage = 45 + Math.floor(Math.random() * 15);

                            lastUpdate = now;
                            lastProcessedRows = this.processedRows;
                        }
                        requestAnimationFrame(step);
                    };
                    requestAnimationFrame(step);
                });
            },

            simulateProgress(start, end, duration) {
                return new Promise((resolve) => {
                    const startTime = Date.now();
                    const step = () => {
                        if (this.checkStopped()) {
                            resolve();
                            return;
                        }
                        const elapsed = Date.now() - startTime;
                        const pct = Math.min(elapsed / duration, 1);
                        this.progress = Math.floor(start + (end - start) * pct);
                        if (pct < 1) requestAnimationFrame(step);
                        else resolve();
                    };
                    requestAnimationFrame(step);
                });
            },

            togglePause() {
                this.isPaused = !this.isPaused;
                this.status = this.isPaused ? 'paused' : 'processing';
                this.title = this.isPaused ? 'Process Paused' : 'Processing Data';
                this.progressText = this.isPaused ? 'Paused' : 'Cross-referencing Data...';
                this.addLog(this.isPaused ? 'âš ï¸ Process paused by user.' : 'â–¶ï¸ Process resumed.', 'warning');
            },

            stopProcessing() {
                if (confirm('Stop processing?')) {
                    this.status = 'stopped';
                    this.title = 'Process Terminated';
                    this.subtitle = 'Data processing was cancelled manually.';
                    this.progressText = 'Stopped';
                    if (this.abortController) this.abortController.abort();
                    this.addLog('ðŸ›‘ STOP Signal received. Operation aborted.', 'error');
                }
            },

            checkStopped() {
                return this.status === 'stopped' || this.status === 'error';
            },

            downloadFile() {
                window.location.href = "{% url 'crosscheck:download_report' %}?ovatr_code=" + this.ovatrCode;
            },

            fail(msg) {
                this.status = 'error';
                this.title = 'Operation Failed';
                this.subtitle = 'An error occurred during processing';
                this.progressText = 'Error';
                this.addLog('CRITICAL ERROR: ' + msg, 'error');
            },

            retry() {
                this.initialize();
            },
        }));
    });
</script>
{% endblock %}
