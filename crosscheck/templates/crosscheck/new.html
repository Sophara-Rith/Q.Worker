{% extends 'base.html' %} {% load static %} {% block title %}New Crosscheck{% endblock %} {% block content %}
<div x-data="crosscheckWorkflow()" x-on:scroll.window="showScrollButton = window.pageYOffset > 300" class="max-w-[1600px] mx-auto pb-20 relative">
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white tracking-tight">New Crosscheck</h1>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Initiate audit process & verify company master data.</p>
        </div>
        <div class="flex items-center gap-4">
            <div x-show="ovatrCode" x-transition class="hidden md:flex items-center gap-2 bg-indigo-50 dark:bg-indigo-900/30 border border-indigo-100 dark:border-indigo-800 px-3 py-1.5 rounded-lg shadow-sm">
                <span class="text-[10px] font-bold text-indigo-400 dark:text-indigo-300 uppercase tracking-wider">Session Key</span>
                <span class="text-sm font-mono font-bold text-indigo-700 dark:text-indigo-400" x-text="ovatrCode"></span>
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse ml-1"></div>
                <div class="w-px h-4 bg-indigo-200 dark:bg-indigo-700 mx-1"></div>
                <button @click="clearSession()" class="text-red-400 hover:text-red-600 transition-colors" title="Clear Session & Restart">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </button>
            </div>
            <div class="flex items-center gap-2 text-sm font-medium text-gray-400 bg-white dark:bg-gray-800 px-4 py-2 rounded-lg border border-gray-100 dark:border-gray-700 shadow-sm">
                <span :class="state === 'locked' ? 'text-brand-600 dark:text-brand-400' : ''">1. Auth</span>
                <span class="text-gray-300 dark:text-gray-600">/</span>
                <span :class="state === 'upload' ? 'text-brand-600 dark:text-brand-400' : ''">2. Upload</span>
                <span class="text-gray-300 dark:text-gray-600">/</span>
                <span :class="state === 'preview' ? 'text-brand-600 dark:text-brand-400' : ''">3. Verify</span>
            </div>
        </div>
    </div>

    <div x-show="state === 'locked'" x-transition class="max-w-md mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-100 dark:border-gray-700 p-8 text-center mt-12">
        <div class="w-14 h-14 bg-gray-50 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-5">
            <svg class="w-6 h-6 text-gray-400 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
        </div>
        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-1">Security Check</h3>
        <p class="text-xs text-gray-500 dark:text-gray-400 mb-6">Enter 18-digit OVATR code (OVATR...)</p>
        <div class="relative">
            <input type="text" x-model="inputCode" @keyup="validateCode()" class="block w-full text-center text-lg font-mono tracking-widest border border-gray-400 dark:border-gray-600 dark:bg-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 uppercase py-2 shadow-md transition-shadow leading-relaxed" placeholder="OVATR..." maxlength="18" autofocus />
            <div class="text-xs text-red-500 font-bold mt-2 h-4" x-text="codeError"></div>
        </div>
    </div>

    <div x-show="state === 'upload'" x-cloak class="max-w-2xl mx-auto mt-10 relative">
        <div
            class="relative border-2 border-dashed rounded-xl p-12 text-center transition-all bg-white dark:bg-gray-800 cursor-pointer group shadow-sm hover:shadow-md overflow-hidden"
            :class="isDragging ? 'border-brand-500 bg-brand-50 dark:bg-brand-900/20' : 'border-gray-300 dark:border-gray-600 hover:border-brand-400 dark:hover:border-brand-500 hover:bg-gray-50 dark:hover:bg-gray-700'"
            @dragover.prevent="isDragging = true"
            @dragleave.prevent="isDragging = false"
            @drop.prevent="handleDrop($event)"
            @click="$refs.fileInput.click()"
        >
            <input type="file" x-ref="fileInput" class="hidden" accept=".xlsx,.xls" @change="handleFileSelect($event)" />
            <div class="w-16 h-16 bg-blue-50 dark:bg-blue-900/30 text-blue-500 dark:text-blue-400 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
            </div>
            <h3 class="text-lg font-bold text-gray-900 dark:text-white">Upload Core Excel Workbook</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Drag & drop or click to browse</p>

            <div x-show="isProcessing" class="absolute inset-0 bg-white/95 dark:bg-gray-900/95 backdrop-blur z-10 flex flex-col items-center justify-center p-8">
                <div class="animate-spin rounded-full h-10 w-10 border-b-4 border-brand-600 mb-4"></div>
                <h4 class="text-sm font-bold text-gray-800 dark:text-gray-200 mb-1" x-text="progressMessage">Extracting Data...</h4>
            </div>
        </div>
    </div>

    <div x-show="state === 'preview'" x-cloak x-transition.opacity>
        <div class="flex items-center justify-end gap-3 mb-6 sticky top-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur py-4 z-40 border-b border-gray-200 dark:border-gray-800">
            <span x-text="saveMessage" class="text-sm font-bold text-green-600 dark:text-green-400" x-transition></span>
            <button @click="resetUpload()" :disabled="isSaving" class="px-5 py-2.5 text-xs font-bold text-gray-600 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors disabled:opacity-50">Cancel</button>
            <button @click="saveComputedData()" :disabled="isSaving" :class="isSaving ? 'opacity-75 cursor-wait' : 'hover:bg-brand-700'" class="px-6 py-2.5 text-xs font-bold text-white bg-brand-600 rounded-lg shadow-md transition-colors flex items-center gap-2">
                <svg x-show="isSaving" class="animate-spin -ml-1 mr-1 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span x-text="isSaving ? 'Saving Data...' : 'Confirm & Generate'"></span>
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-12 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-brand-200 dark:border-brand-900/50 bg-brand-50/30 dark:bg-brand-900/10">
                <div class="mb-5 border-b border-brand-100 dark:border-brand-900/50 pb-2">
                    <h4 class="text-sm font-bold text-brand-700 dark:text-brand-400 uppercase tracking-wider flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        I. ព័ត៌មានសម្រាប់របាយការណ៍ (Report Configuration)
                    </h4>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                        <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-3">Auditor Names (សវនករ)</label>
                        <template x-for="(auditor, idx) in uiState.auditors" :key="idx">
                            <div class="flex gap-2 mb-2">
                                <select x-model="auditor.title" class="w-1/3 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-2 py-2 focus:ring-2 focus:ring-brand-500 font-khmer">
                                    <option value="លោក">លោក</option>
                                    <option value="លោកស្រី">លោកស្រី</option>
                                    <option value="កញ្ញា">កញ្ញា</option>
                                </select>
                                <input type="text" x-model="auditor.name" class="w-full text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2 font-khmer focus:ring-2 focus:ring-brand-500" placeholder="ឈ្មោះសវនករ..." />
                                <button @click="uiState.auditors.splice(idx, 1)" class="text-red-400 hover:text-red-600 font-bold px-2" x-show="uiState.auditors.length > 1">✕</button>
                            </div>
                        </template>
                        <button @click="uiState.auditors.push({title:'លោក', name:''})" class="text-xs text-brand-600 dark:text-brand-400 font-bold mt-1 hover:underline">+ បន្ថែមសវនករ</button>
                    </div>

                    <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                        <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-3">Contact Person (អ្នកតំណាង)</label>
                        <div class="flex gap-2 mb-3">
                            <select x-model="uiState.contact_title" class="w-1/3 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-2 py-2 focus:ring-2 focus:ring-brand-500 font-khmer">
                                <option value="លោក">លោក</option>
                                <option value="លោកស្រី">លោកស្រី</option>
                            </select>
                            <input type="text" x-model="uiState.contact_name" class="w-full text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2 font-khmer focus:ring-2 focus:ring-brand-500" placeholder="ឈ្មោះតំណាងក្រុមហ៊ុន..." />
                        </div>
                        <input type="text" x-model="formData.i_contact_position" class="w-full text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2 font-khmer focus:ring-2 focus:ring-brand-500" placeholder="តួនាទី (ឧ. ប្រធានគណនេយ្យ)" />
                    </div>

                    <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                        <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-3">Requested Period (រយៈពេលស្នើសុំ)</label>
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-xs font-bold text-gray-500 w-12 text-right">ចាប់ពី៖</span>
                            <select x-model="uiState.req_from_month" class="w-full text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-2 py-2 font-khmer">
                                <option value="">ជ្រើសរើសខែ...</option>
                                <template x-for="m in khmerMonths" :key="m">
                                    <option :value="m" x-text="m"></option>
                                </template>
                            </select>
                            <input type="text" x-model="uiState.req_from_year" class="w-24 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2 text-center" placeholder="ឆ្នាំ (YYYY)" maxlength="4" />
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold text-gray-500 w-12 text-right">ដល់៖</span>
                            <select x-model="uiState.req_to_month" class="w-full text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-2 py-2 font-khmer">
                                <option value="">ជ្រើសរើសខែ...</option>
                                <template x-for="m in khmerMonths" :key="m">
                                    <option :value="m" x-text="m"></option>
                                </template>
                            </select>
                            <input type="text" x-model="uiState.req_to_year" class="w-24 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2 text-center" placeholder="ឆ្នាំ (YYYY)" maxlength="4" />
                        </div>
                    </div>

                    <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                        <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-3">Audit Timeline (កាលបរិច្ឆេទចុះសវនកម្ម)</label>
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-xs font-bold text-gray-500 w-12 text-right">ថ្ងៃចុះ៖</span>
                            <input type="date" x-model="uiState.audit_start" class="w-full text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500" />
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold text-gray-500 w-12 text-right">បញ្ច​ប់៖</span>
                            <input type="date" x-model="uiState.audit_end" class="w-full text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500" />
                        </div>
                    </div>

                    <div class="lg:col-span-4 grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 mt-2">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">MOC Number</label>
                            <input type="text" x-model="formData.i_moc_number" class="w-full text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 shadow-sm" placeholder="No..." />
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">MOC Date</label>
                            <input type="date" x-model="formData.i_moc_date" class="w-full text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 shadow-sm" />
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">Patent Date</label>
                            <input type="date" x-model="formData.i_patent_date" class="w-full text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 shadow-sm" />
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">Patent Amount</label>
                            <input type="text" x-model="formData.i_patent_amount" class="w-full text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 shadow-sm" placeholder="Ex: 1,140,000" />
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">VAT Cert Date</label>
                            <input type="date" x-model="formData.i_vat_cert_date" class="w-full text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 shadow-sm" />
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">Request Date</label>
                            <input type="date" x-model="uiState.request_submission_date" class="w-full text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 shadow-sm" />
                        </div>
                    </div>

                    <div class="lg:col-span-4 mt-2">
                        <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">Amount Requested (ទឹកប្រាក់ស្នើសុំបង្វិលសង)</label>
                        <input type="text" x-model="formData.i_amount_requested" class="w-full text-lg border border-gray-400 dark:border-gray-600 rounded-lg px-4 py-3 font-bold text-gray-900 bg-yellow-50 dark:bg-yellow-900/30 dark:text-yellow-100 focus:ring-2 focus:ring-brand-500 shadow-md transition-shadow" placeholder="Ex: 931,937,106" />
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 mt-4">
                <h4 class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-5 border-b dark:border-gray-700 pb-2">A. Core Identity</h4>
                <div class="grid grid-cols-2 gap-5">
                    <div class="col-span-1">
                        <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">Company Name (English)</label>
                        <input type="text" x-model="formData.company_name_en" class="w-full text-sm border border-gray-400 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-3.5 leading-relaxed font-bold text-gray-800 focus:ring-2 focus:ring-brand-500 shadow-md transition-shadow" />
                    </div>
                    <div class="col-span-1">
                        <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">Company Name (Khmer)</label>
                        <input type="text" x-model="formData.company_name_kh" class="w-full text-sm border border-gray-400 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-3.5 leading-relaxed font-khmer text-gray-800 focus:ring-2 focus:ring-brand-500 shadow-md transition-shadow" />
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">VATIN (New)</label>
                        <input type="text" x-model="formData.vatin" class="w-full text-sm font-mono border border-gray-400 dark:border-gray-600 rounded-lg px-3 py-3.5 leading-relaxed bg-yellow-50 dark:bg-yellow-900/30 text-gray-900 dark:text-yellow-100 font-bold focus:ring-2 focus:ring-brand-500 shadow-md transition-shadow" />
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">VATIN (Old)</label>
                        <input type="text" x-model="formData.old_vatin" class="w-full text-sm font-mono border border-gray-400 dark:border-gray-600 dark:bg-gray-700 rounded-lg px-3 py-3.5 leading-relaxed text-gray-600 dark:text-gray-300 bg-gray-50 focus:ring-2 focus:ring-brand-500 shadow-md transition-shadow" />
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">Enterprise ID</label>
                        <input type="text" x-model="formData.enterprise_id" class="w-full text-sm border border-gray-400 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-3.5 leading-relaxed text-gray-800 focus:ring-2 focus:ring-brand-500 shadow-md transition-shadow" />
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">File Barcode</label>
                        <input type="text" x-model="formData.file_barcode" class="w-full text-sm border border-gray-400 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-3.5 leading-relaxed text-gray-500 bg-gray-50 focus:ring-2 focus:ring-brand-500 shadow-md transition-shadow" />
                    </div>
                </div>
            </div>

            <div class="lg:col-span-4 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 mt-4">
                <h4 class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-5 border-b dark:border-gray-700 pb-2">B. Registration</h4>
                <div class="space-y-4">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">Status</label>
                        <input type="text" x-model="formData.status" class="w-full text-sm border border-gray-400 dark:border-gray-600 rounded-lg px-3 py-3.5 leading-relaxed text-green-700 dark:text-green-400 font-bold bg-green-50 dark:bg-green-900/20 focus:ring-2 focus:ring-brand-500 shadow-md transition-shadow" />
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">Reg. Date</label>
                            <input type="text" x-model="formData.reg_date" class="w-full text-sm border border-gray-400 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-3.5 leading-relaxed text-gray-800 focus:ring-2 focus:ring-brand-500 shadow-md transition-shadow" />
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">Success Date</label>
                            <input type="text" x-model="formData.success_date" class="w-full text-sm border border-gray-400 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-3.5 leading-relaxed text-gray-800 focus:ring-2 focus:ring-brand-500 shadow-md transition-shadow" />
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="col-span-1">
                            <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">Taxpayer Type</label>
                            <input type="text" x-model="formData.taxpayer_type" class="w-full text-sm border border-gray-400 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-3.5 leading-relaxed text-gray-800 focus:ring-2 focus:ring-brand-500 shadow-md transition-shadow" />
                        </div>
                        <div class="col-span-1">
                            <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">Tax Year</label>
                            <input type="text" x-model="formData.tax_year" class="w-full text-sm border border-gray-400 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg px-3 py-3.5 leading-relaxed text-gray-900 dark:text-white font-normal focus:ring-2 focus:ring-brand-500 shadow-md transition-shadow" />
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">Registered Entity</label>
                        <input type="text" x-model="formData.registered_entity" class="w-full text-xs border border-gray-400 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-3.5 leading-relaxed text-gray-800 focus:ring-2 focus:ring-brand-500 shadow-md transition-shadow" />
                    </div>
                </div>
            </div>

            <div class="lg:col-span-6 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
                <h4 class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-5 border-b dark:border-gray-700 pb-2">C. Contact Info</h4>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div><label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">Phone</label><input type="text" x-model="formData.phone" class="w-full text-sm border border-gray-400 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-3.5 leading-relaxed text-gray-800 focus:ring-2 focus:ring-brand-500 shadow-md transition-shadow" /></div>
                    <div><label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">Email</label><input type="text" x-model="formData.email" class="w-full text-sm border border-gray-400 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-3.5 leading-relaxed text-gray-800 focus:ring-2 focus:ring-brand-500 shadow-md transition-shadow" /></div>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">Main Address</label>
                        <textarea x-model="formData.address_main" rows="5" class="w-full text-sm border border-gray-400 dark:border-gray-600 rounded-lg p-3.5 leading-relaxed text-gray-900 dark:text-white bg-white dark:bg-gray-700 focus:ring-2 focus:ring-brand-500 shadow-md transition-shadow"></textarea>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">Office Address</label>
                        <textarea x-model="formData.address_office" rows="5" class="w-full text-sm border border-gray-400 dark:border-gray-600 rounded-lg p-3.5 leading-relaxed text-gray-900 dark:text-white bg-white dark:bg-gray-700 focus:ring-2 focus:ring-brand-500 shadow-md transition-shadow"></textarea>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-6 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
                <h4 class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-5 border-b dark:border-gray-700 pb-2">D. Metrics</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">Employees</label>
                        <input type="text" x-model="formData.employee_count" class="w-full text-sm border border-gray-400 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-3.5 leading-relaxed text-right text-gray-800 focus:ring-2 focus:ring-brand-500 shadow-md transition-shadow" />
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">Total Salary (KHR)</label>
                        <input type="text" x-model="formData.total_salary" class="w-full text-sm border border-gray-400 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-3.5 leading-relaxed text-right text-gray-800 focus:ring-2 focus:ring-brand-500 shadow-md transition-shadow" />
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">Property Type</label>
                        <input type="text" x-model="formData.property_type" class="w-full text-sm border border-gray-400 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-3.5 leading-relaxed text-gray-800 focus:ring-2 focus:ring-brand-500 shadow-md transition-shadow" />
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">Rent (KHR)</label>
                        <input type="text" x-model="formData.rent_per_month" class="w-full text-sm border border-gray-400 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-3.5 leading-relaxed text-right text-gray-800 focus:ring-2 focus:ring-brand-500 shadow-md transition-shadow" />
                    </div>
                    <div class="col-span-2">
                        <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">Form</label>
                        <input type="text" x-model="formData.enterprise_form" class="w-full text-sm border border-gray-400 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-3.5 leading-relaxed mb-2 text-gray-800 focus:ring-2 focus:ring-brand-500 shadow-md transition-shadow" />
                        <input type="text" x-model="formData.add_ent_form" class="w-full text-sm border border-gray-400 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-3.5 leading-relaxed text-gray-600 bg-gray-50 focus:ring-2 focus:ring-brand-500 shadow-md transition-shadow" placeholder="Additional" />
                    </div>
                    <div class="col-span-2">
                        <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">Signage</label>
                        <input type="text" x-model="formData.signage" class="w-full text-sm border border-gray-400 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-3.5 leading-relaxed text-gray-800 focus:ring-2 focus:ring-brand-500 shadow-md transition-shadow" />
                    </div>
                </div>
            </div>

            <div class="lg:col-span-12 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center mb-5 border-b dark:border-gray-700 pb-2">
                    <h4 class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider">E. សកម្មភាពអាជីវកម្ម (Business Activities)</h4>
                    <button @click="formData.business_activities.push({no:'', code:'', name:'', desc:'', type:''})" class="text-xs bg-brand-50 dark:bg-brand-900/30 text-brand-600 dark:text-brand-400 px-3 py-1 rounded-full font-bold hover:bg-brand-100">+ Add Row</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full min-w-[600px]">
                        <thead>
                            <tr class="text-left text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase bg-gray-50 dark:bg-gray-700">
                                <th class="p-2 rounded-l-lg w-12 text-center">No</th>
                                <th class="p-2 w-24">Code</th>
                                <th class="p-2">Activity Name (Khmer)</th>
                                <th class="p-2">Description (Khmer)</th>
                                <th class="p-2">Type</th>
                                <th class="p-2 rounded-r-lg w-10"></th>
                            </tr>
                        </thead>
                        <tbody class="space-y-2">
                            <template x-for="(item, index) in formData.business_activities" :key="index">
                                <tr>
                                    <td class="p-1"><input type="text" x-model="item.no" class="w-full text-xs text-center border-gray-300 dark:border-gray-600 dark:bg-gray-900 dark:text-white rounded px-2 py-2 shadow-sm font-mono" /></td>
                                    <td class="p-1"><input type="text" x-model="item.code" class="w-full text-xs border-gray-300 dark:border-gray-600 dark:bg-gray-900 dark:text-white rounded px-2 py-2 shadow-sm font-mono" /></td>
                                    <td class="p-1"><input type="text" x-model="item.name" class="w-full text-xs border-gray-300 dark:border-gray-600 dark:bg-gray-900 dark:text-white rounded px-2 py-2 shadow-sm font-khmer" /></td>
                                    <td class="p-1"><input type="text" x-model="item.desc" class="w-full text-xs border-gray-300 dark:border-gray-600 dark:bg-gray-900 dark:text-white rounded px-2 py-2 shadow-sm font-khmer" /></td>
                                    <td class="p-1"><input type="text" x-model="item.type" class="w-full text-xs border-gray-300 dark:border-gray-600 dark:bg-gray-900 dark:text-white rounded px-2 py-2 shadow-sm" /></td>
                                    <td class="p-1 text-center"><button @click="formData.business_activities.splice(index, 1)" class="text-red-400 hover:text-red-600">x</button></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="lg:col-span-12 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center mb-5 border-b dark:border-gray-700 pb-2">
                    <h4 class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider">F. គណនីសហគ្រាស (Accounts)</h4>
                    <button @click="formData.enterprise_accounts.push({no:'', bank:'', account_name:'', number:'', currency:'', type:''})" class="text-xs bg-brand-50 dark:bg-brand-900/30 text-brand-600 dark:text-brand-400 px-3 py-1 rounded-full font-bold hover:bg-brand-100">+ Add</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full min-w-[700px]">
                        <thead>
                            <tr class="text-left text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase bg-gray-50 dark:bg-gray-700">
                                <th class="p-2 rounded-l-lg w-12 text-center">No</th>
                                <th class="p-2">Bank Name</th>
                                <th class="p-2">Account Number</th>
                                <th class="p-2">Account Name</th>
                                <th class="p-2 w-24">Currency</th>
                                <th class="p-2">Account Type</th>
                                <th class="p-2 rounded-r-lg w-10"></th>
                            </tr>
                        </thead>
                        <tbody class="space-y-2">
                            <template x-for="(item, index) in formData.enterprise_accounts" :key="index">
                                <tr>
                                    <td class="p-1"><input type="text" x-model="item.no" class="w-full text-xs text-center border-gray-300 dark:border-gray-600 dark:bg-gray-900 dark:text-white rounded px-2 py-2 shadow-sm font-mono" /></td>
                                    <td class="p-1"><input type="text" x-model="item.bank" class="w-full text-xs border-gray-300 dark:border-gray-600 dark:bg-gray-900 dark:text-white rounded px-2 py-2 shadow-sm font-khmer" /></td>
                                    <td class="p-1"><input type="text" x-model="item.number" class="w-full text-xs border-gray-300 dark:border-gray-600 dark:bg-gray-900 dark:text-white rounded px-2 py-2 shadow-sm font-mono font-bold text-gray-700 dark:text-gray-300" /></td>
                                    <td class="p-1"><input type="text" x-model="item.account_name" class="w-full text-xs border-gray-300 dark:border-gray-600 dark:bg-gray-900 dark:text-white rounded px-2 py-2 shadow-sm font-khmer" /></td>
                                    <td class="p-1"><input type="text" x-model="item.currency" class="w-full text-xs border-gray-300 dark:border-gray-600 dark:bg-gray-900 dark:text-white rounded px-2 py-2 shadow-sm text-center" /></td>
                                    <td class="p-1"><input type="text" x-model="item.type" class="w-full text-xs border-gray-300 dark:border-gray-600 dark:bg-gray-900 dark:text-white rounded px-2 py-2 shadow-sm" /></td>
                                    <td class="p-1 text-center"><button @click="formData.enterprise_accounts.splice(index, 1)" class="text-red-400 hover:text-red-600">x</button></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="lg:col-span-6 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center mb-5 border-b dark:border-gray-700 pb-2">
                    <h4 class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider">G. ស្ថាប័នពាក់ព័ន្ធ (Institutions)</h4>
                    <button @click="formData.related_institutions.push({no: '', name:'', ref:'', date:''})" class="text-xs bg-brand-50 dark:bg-brand-900/30 text-brand-600 dark:text-brand-400 px-3 py-1 rounded-full font-bold hover:bg-brand-100">+ Add</button>
                </div>
                <table class="w-full">
                    <thead>
                        <tr class="text-left text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase bg-gray-50 dark:bg-gray-700">
                            <th class="p-2 rounded-l-lg w-12 text-center">No</th>
                            <th class="p-2 w-1/2">Name</th>
                            <th class="p-2">Reference</th>
                            <th class="p-2 w-40">Date</th>
                            <th class="p-2 rounded-r-lg w-8"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="(item, index) in formData.related_institutions" :key="index">
                            <tr>
                                <td class="p-1"><input type="text" x-model="item.no" class="w-full text-xs text-center border-gray-300 dark:border-gray-600 dark:bg-gray-900 dark:text-white rounded px-2 py-2 shadow-sm font-mono" /></td>
                                <td class="p-1"><input type="text" x-model="item.name" class="w-full text-xs border-gray-300 dark:border-gray-600 dark:bg-gray-900 dark:text-white rounded px-2 py-2 shadow-sm font-khmer" /></td>
                                <td class="p-1"><input type="text" x-model="item.ref" class="w-full text-xs border-gray-300 dark:border-gray-600 dark:bg-gray-900 dark:text-white rounded px-2 py-2 shadow-sm" /></td>
                                <td class="p-1"><input type="text" x-model="item.date" class="w-full text-xs border-gray-300 dark:border-gray-600 dark:bg-gray-900 dark:text-white rounded px-2 py-2 shadow-sm" /></td>
                                <td class="p-1"><button @click="formData.related_institutions.splice(index, 1)" class="text-red-400 hover:text-red-600">x</button></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <div class="lg:col-span-6 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
                <div class="mb-5 border-b dark:border-gray-700 pb-2">
                    <h4 class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider">H. ការប៉ាន់ស្មានផលរបរ (Estimates)</h4>
                </div>

                <div class="flex items-center gap-4 mb-6">
                    <label class="text-xs font-bold text-gray-700 dark:text-gray-300 font-khmer whitespace-nowrap">កាលបរិច្ឆេទផ្គត់ផ្គង់</label>
                    <input type="text" x-model="formData.h_date" class="w-full text-sm border-gray-400 dark:border-gray-600 rounded-lg px-3 py-2 bg-yellow-50 dark:bg-yellow-900/30 dark:text-yellow-100 focus:bg-yellow-100 dark:focus:bg-yellow-900/50 focus:ring-2 focus:ring-brand-500 shadow-md font-bold text-gray-800" />
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr>
                                <th class="w-1/3"></th>
                                <th class="p-3 text-xs font-bold text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-center font-khmer">១២ ខែកន្លងមក</th>
                                <th class="p-3 text-xs font-bold text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-center font-khmer">៣ ខែខាងមុខ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="p-3 text-xs font-bold text-gray-700 dark:text-gray-300 font-khmer border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-800">ផលរបរផ្គត់ផ្គង់រយ:ពេល</td>
                                <td class="p-2 border border-gray-200 dark:border-gray-600">
                                    <div class="relative"><input type="text" x-model="formData.h_real_12m" class="w-full text-sm text-right border-gray-300 dark:border-gray-600 rounded px-2 py-2 bg-yellow-50 dark:bg-yellow-900/30 dark:text-yellow-100 focus:bg-yellow-100 focus:ring-1 focus:ring-brand-500" /></div>
                                </td>
                                <td class="p-2 border border-gray-200 dark:border-gray-600">
                                    <div class="relative"><input type="text" x-model="formData.h_real_3m" class="w-full text-sm text-right border-gray-300 dark:border-gray-600 rounded px-2 py-2 bg-yellow-50 dark:bg-yellow-900/30 dark:text-yellow-100 focus:bg-yellow-100 focus:ring-1 focus:ring-brand-500" /></div>
                                </td>
                            </tr>
                            <tr>
                                <td class="p-3 text-xs font-bold text-gray-700 dark:text-gray-300 font-khmer border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-800">ការប៉ាន់ស្មានផលរបររយ:ពេល</td>
                                <td class="p-2 border border-gray-200 dark:border-gray-600">
                                    <div class="relative"><input type="text" x-model="formData.h_est_12m" class="w-full text-sm text-right border-gray-300 dark:border-gray-600 rounded px-2 py-2 bg-yellow-50 dark:bg-yellow-900/30 dark:text-yellow-100 focus:bg-yellow-100 focus:ring-1 focus:ring-brand-500" /></div>
                                </td>
                                <td class="p-2 border border-gray-200 dark:border-gray-600">
                                    <div class="relative"><input type="text" x-model="formData.h_est_3m" class="w-full text-sm text-right border-gray-300 dark:border-gray-600 rounded px-2 py-2 bg-yellow-50 dark:bg-yellow-900/30 dark:text-yellow-100 focus:bg-yellow-100 focus:ring-1 focus:ring-brand-500" /></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <button
        x-show="showScrollButton"
        @click="window.scrollTo({top: 0, behavior: 'smooth'})"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 translate-y-8"
        x-transition:enter-end="opacity-100 translate-y-0"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 translate-y-0"
        x-transition:leave-end="opacity-0 translate-y-8"
        class="fixed bottom-8 right-8 bg-brand-600 hover:bg-brand-700 text-white p-3.5 rounded-full shadow-2xl hover:shadow-brand-500/50 transition-all focus:outline-none z-50 flex items-center justify-center transform hover:-translate-y-1"
        title="Scroll to Top"
        x-cloak
    >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 15l7-7 7 7"></path></svg>
    </button>
</div>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('crosscheckWorkflow', () => ({
            state: 'locked', // locked | upload | preview
            inputCode: '',
            ovatrCode: '',
            codeError: '',
            isDragging: false,
            isProcessing: false,
            isSaving: false,
            saveMessage: '',
            tempFilePath: '',
            showScrollButton: false,

            // Reusable array for the dropdowns
            khmerMonths: ['មករា', 'កុម្ភៈ', 'មីនា', 'មេសា', 'ឧសភា', 'មិថុនា', 'កក្កដា', 'សីហា', 'កញ្ញា', 'តុលា', 'វិច្ឆិកា', 'ធ្នូ'],

            // Smart UI State for user-friendly inputs
            uiState: {
                auditors: [{title: 'លោក', name: ''}],
                req_from_month: '',
                req_from_year: '',
                req_to_month: '',
                req_to_year: '',
                audit_start: '',
                audit_end: '',
                contact_title: 'លោក',
                contact_name: '',
                request_submission_date: '',
            },

            // Data Structure matching the backend database
            formData: {
                company_name_en: '',
                company_name_kh: '',
                vatin: '',
                old_vatin: '',
                enterprise_id: '',
                file_barcode: '',
                status: '',
                reg_date: '',
                success_date: '',
                taxpayer_type: '',
                tax_year: '',
                registered_entity: '',
                phone: '',
                email: '',
                address_main: '',
                address_office: '',
                employee_count: '',
                total_salary: '',
                property_type: '',
                rent_per_month: '',
                enterprise_form: '',
                add_ent_form: '',
                signage: '',
                h_date: '',
                h_real_12m: '',
                h_real_3m: '',
                h_est_12m: '',
                h_est_3m: '',

                // Block I string variables sent to DB
                i_auditor_names: '',
                i_request_date: '',
                i_contact_person: '',
                i_contact_position: '',
                i_audit_timeline: '',
                i_amount_requested: '',
                i_moc_number: '',
                i_moc_date: '',
                i_patent_date: '',
                i_patent_amount: '',
                i_vat_cert_date: '',
                i_request_submission_date: '',

                business_activities: [],
                enterprise_accounts: [],
                related_institutions: [],
            },

            init() {
                window.addEventListener('scroll', () => {
                    this.showScrollButton = window.pageYOffset > 300;
                });

                // 1. Load from localStorage if a previous draft exists
                const savedDraft = localStorage.getItem('crosscheck_draft');
                if (savedDraft) {
                    try {
                        const parsed = JSON.parse(savedDraft);
                        if (parsed.state) this.state = parsed.state;
                        if (parsed.ovatrCode) this.ovatrCode = parsed.ovatrCode;
                        if (parsed.tempFilePath) this.tempFilePath = parsed.tempFilePath;
                        if (parsed.formData) this.formData = {...this.formData, ...parsed.formData};
                        if (parsed.uiState) this.uiState = {...this.uiState, ...parsed.uiState};
                    } catch (e) {
                        console.error('Failed to parse saved state from local storage', e);
                    }
                }

                // 2. Set up watchers to automatically persist state on every change
                this.$watch('state', () => this.persistState());
                this.$watch('ovatrCode', () => this.persistState());
                this.$watch('tempFilePath', () => this.persistState());
                this.$watch('formData', () => this.persistState(), {deep: true});
                this.$watch('uiState', () => this.persistState(), {deep: true});
            },

            // Helper to save state locally
            persistState() {
                const draft = {
                    state: this.state,
                    ovatrCode: this.ovatrCode,
                    tempFilePath: this.tempFilePath,
                    formData: this.formData,
                    uiState: this.uiState,
                };
                localStorage.setItem('crosscheck_draft', JSON.stringify(draft));
            },

            // Clear session fully
            clearSession() {
                if (confirm('Warning: This will clear all your progress and current data. Continue?')) {
                    localStorage.removeItem('crosscheck_draft');
                    window.location.reload();
                }
            },

            // --- Date Formatting Helper ---
            formatKhmerDate(dateStr) {
                if (!dateStr) return '';
                const parts = dateStr.split('-');
                if (parts.length !== 3) return '';
                const year = parts[0];
                const monthIndex = parseInt(parts[1], 10) - 1;
                const day = parseInt(parts[2], 10);
                return `ថ្ងៃទី${day} ខែ${this.khmerMonths[monthIndex]} ឆ្នាំ${year}`;
            },

            validateCode() {
                const code = this.inputCode.toUpperCase();
                if (code.length === 0) {
                    this.codeError = '';
                    return;
                }
                if (!code.startsWith('OVATR')) {
                    this.codeError = 'Must start with "OVATR"';
                    return;
                }
                if (code.length === 18) {
                    this.codeError = '';
                    this.isProcessing = true;
                    setTimeout(() => {
                        this.ovatrCode = code;
                        this.state = 'upload';
                        this.inputCode = '';
                        this.isProcessing = false;
                    }, 500);
                } else if (code.length > 5) {
                    this.codeError = `Verifying... (${code.length}/18)`;
                } else {
                    this.codeError = '';
                }
            },

            handleDrop(e) {
                this.isDragging = false;
                if (e.dataTransfer.files.length > 0) this.uploadFile(e.dataTransfer.files[0]);
            },
            handleFileSelect(e) {
                if (e.target.files.length > 0) this.uploadFile(e.target.files[0]);
            },

            uploadFile(file) {
                if (!file.name.match(/\.(xlsx|xls)$/i)) {
                    alert('Invalid file format. Please upload .xlsx');
                    return;
                }
                this.isProcessing = true;
                const fd = new FormData();
                fd.append('file', file);

                fetch('{% url "crosscheck:upload_init" %}', {method: 'POST', body: fd})
                    .then((r) => r.json())
                    .then((res) => {
                        this.isProcessing = false;
                        if (res.status === 'success') {
                            this.formData = {...this.formData, ...res.data};
                            this.tempFilePath = res.temp_path;
                            this.state = 'preview';
                        } else {
                            alert('Upload Error: ' + res.message);
                        }
                    })
                    .catch((e) => {
                        this.isProcessing = false;
                        console.error(e);
                        alert('System Error: Upload failed.');
                    });
            },

            resetUpload() {
                if (confirm('Discard current data and upload new file?')) {
                    this.state = 'upload';
                    this.tempFilePath = '';
                }
            },

            // --- STEP 3: Compile UI State & Chain Save ---
            saveComputedData() {
                if (!this.tempFilePath) {
                    alert('Error: Source file lost. Please upload again.');
                    return;
                }

                this.isSaving = true;
                this.saveMessage = 'Saving Company Info...';
                this.formData.OVATR = this.ovatrCode;

                // --- 1. COMPILE UI STATE INTO FORMDATA ---
                this.formData.i_auditor_names = this.uiState.auditors
                    .filter((a) => a.name.trim() !== '')
                    .map((a) => `${a.title} ${a.name}`)
                    .join(', ');

                let reqDate = '';
                if (this.uiState.req_from_month && this.uiState.req_from_year) {
                    reqDate = `ខែ${this.uiState.req_from_month} ឆ្នាំ${this.uiState.req_from_year}`;
                    if (this.uiState.req_to_month && this.uiState.req_to_year) {
                        reqDate += ` ដល់ខែ${this.uiState.req_to_month} ឆ្នាំ${this.uiState.req_to_year}`;
                    }
                }
                this.formData.i_request_date = reqDate;

                let auditTimeline = '';
                if (this.uiState.audit_start) {
                    auditTimeline = `ពី${this.formatKhmerDate(this.uiState.audit_start)}`;
                    if (this.uiState.audit_end) {
                        auditTimeline += ` ដល់${this.formatKhmerDate(this.uiState.audit_end)}`;
                    }
                }
                this.formData.i_audit_timeline = auditTimeline;

                if (this.uiState.contact_name.trim() !== '') {
                    this.formData.i_contact_person = `${this.uiState.contact_title} ${this.uiState.contact_name}`;
                } else {
                    this.formData.i_contact_person = '';
                }

                if (this.uiState.request_submission_date) {
                    this.formData.i_request_submission_date = `ស្នើសុំបង្វិលសងអាករលើតម្លៃបន្ថែមតាមអនឡាញចុះ${this.formatKhmerDate(this.uiState.request_submission_date)}`;
                } else {
                    this.formData.i_request_submission_date = '';
                }

                // --- 2. START SAVING PROCESS ---
                fetch('{% url "crosscheck:save_company_info" %}', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
                    body: JSON.stringify(this.formData),
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.status !== 'success') throw new Error(data.message);

                        this.saveMessage = '⏳ Processing Tax Paid...';
                        return fetch('{% url "crosscheck:save_taxpaid" %}', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
                            body: JSON.stringify({ovatr: this.ovatrCode, temp_path: this.tempFilePath}),
                        });
                    })
                    .then((response) => response.json())
                    .then((taxData) => {
                        if (taxData.status !== 'success' && taxData.status !== 'warning') {
                            throw new Error('TaxPaid Error: ' + taxData.message);
                        }

                        this.saveMessage = '⏳ Processing Purchase Invoices...';
                        return fetch('{% url "crosscheck:save_purchase" %}', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
                            body: JSON.stringify({ovatr: this.ovatrCode, temp_path: this.tempFilePath}),
                        });
                    })
                    .then((response) => response.json())
                    .then((purchData) => {
                        if (purchData.status !== 'success') throw new Error('Purchase Error: ' + purchData.message);

                        this.saveMessage = '⏳ Processing Sale Invoices...';
                        return fetch('{% url "crosscheck:save_sale" %}', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
                            body: JSON.stringify({ovatr: this.ovatrCode, temp_path: this.tempFilePath}),
                        });
                    })
                    .then((response) => response.json())
                    .then((saleData) => {
                        if (saleData.status !== 'success') console.warn('Sale Error: ' + saleData.message);

                        this.saveMessage = '⏳ Processing Reverse Charge...';
                        return fetch('{% url "crosscheck:save_reverse_charge" %}', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
                            body: JSON.stringify({ovatr: this.ovatrCode, temp_path: this.tempFilePath}),
                        });
                    })
                    .then((response) => response.json())
                    .then((rcData) => {
                        if (rcData.status === 'success') {
                            this.saveMessage = '✅ All Data Saved! Redirecting...';
                            this.downloadAnnex3();
                        } else {
                            this.isSaving = false;
                            alert('Warning during Reverse Charge save: ' + rcData.message);
                        }
                    })
                    .catch((err) => {
                        this.isSaving = false;
                        console.error(err);
                        this.saveMessage = '❌ Error';
                        alert('Process Failed: ' + err.message);
                    });
            },

            downloadAnnex3() {
                localStorage.removeItem('crosscheck_draft'); // Clear cache on successful generation
                const url = "{% url 'crosscheck:processing' %}?ovatr_code=" + this.ovatrCode;
                window.location.href = url;
            },
        }));
    });
</script>
{% endblock %}
