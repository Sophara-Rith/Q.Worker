{% extends 'base.html' %} {% load static %} {% block title %}New Crosscheck{% endblock %} {% block content %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
<link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/dark.css" />
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<style>
    /* --- Flatpickr Compact UI Overrides --- */
    .flatpickr-calendar {
        font-family: inherit !important; /* Match your dashboard font */
        width: 260px !important; /* Shrink width from 315px */
        padding: 5px !important;
        border-radius: 12px !important;
    }
    .flatpickr-innerContainer,
    .flatpickr-rContainer,
    .dayContainer,
    .flatpickr-days {
        width: 250px !important;
        min-width: 250px !important;
        max-width: 250px !important;
    }
    .flatpickr-day {
        max-width: 35px !important;
        height: 35px !important;
        line-height: 35px !important;
        font-size: 12px !important; /* Smaller dates */
    }
    .flatpickr-month {
        height: 40px !important;
    }
    .flatpickr-current-month {
        font-size: 13px !important; /* Smaller month/year header */
        padding-top: 4px !important;
    }
    .flatpickr-current-month .flatpickr-monthDropdown-months,
    .flatpickr-current-month input.cur-year {
        font-size: 13px !important; /* Fix the massive dropdown text */
        font-weight: 700 !important;
        padding: 0 !important;
    }
    span.flatpickr-weekday {
        font-size: 10px !important; /* Smaller Mon-Sun headers */
        font-weight: 800 !important;
        letter-spacing: 0.05em;
    }
    /* Custom Scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #334155;
        border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #475569;
    }

    /* Hide default date picker calendar icon in webkit */
    input[type='date']::-webkit-calendar-picker-indicator {
        opacity: 0;
        position: absolute;
        right: 0;
        top: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
    }
</style>

<div x-data="crosscheckWorkflow()" x-on:scroll.window="showScrollButton = window.pageYOffset > 300" class="min-h-[calc(100vh-4rem)] p-4 md:p-8 bg-slate-50 dark:bg-[#0f172a] text-slate-800 dark:text-slate-200 relative overflow-hidden">
    <div class="absolute top-0 left-1/2 -translate-x-1/2 w-[800px] h-[300px] bg-indigo-500/10 blur-[120px] rounded-full pointer-events-none z-0"></div>

    <div class="max-w-[1400px] mx-auto relative z-10 pb-20">
        <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-slate-900 dark:text-white tracking-tight flex items-center gap-3">New Crosscheck</h1>
                <p class="text-sm text-slate-500 dark:text-slate-400 font-medium mt-1">Initiate audit process & verify company master data.</p>
            </div>

            <div class="flex items-center gap-4">
                <div x-show="ovatrCode" x-transition class="hidden md:flex items-center gap-2 bg-indigo-500/10 border border-indigo-500/20 px-3.5 py-2 rounded-lg shadow-inner ring-1 ring-inset ring-indigo-500/20">
                    <span class="text-[10px] font-bold text-indigo-600 dark:text-indigo-400 uppercase tracking-widest opacity-80">Session ID</span>
                    <span class="text-xs font-mono font-bold text-indigo-700 dark:text-indigo-300 leading-none" x-text="ovatrCode"></span>
                    <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse ml-1 shadow-[0_0_8px_rgba(16,185,129,0.8)]"></div>
                    <div class="w-px h-4 bg-indigo-500/30 mx-1.5"></div>
                    <button @click="clearSession()" class="text-rose-400 hover:text-rose-500 transition-colors" title="Clear Session & Restart">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </button>
                </div>

                <div class="flex flex-col items-end gap-2">
                    <div class="flex items-center gap-2.5 text-xs font-bold text-slate-500 dark:text-slate-400 bg-white dark:bg-slate-800/80 backdrop-blur px-5 py-2.5 rounded-xl border border-slate-200 dark:border-slate-700/80 shadow-sm ring-1 ring-inset ring-white/5">
                        <span :class="state === 'locked' ? 'text-indigo-600 dark:text-indigo-400 drop-shadow-[0_0_8px_rgba(99,102,241,0.5)]' : ''" class="transition-all duration-300 uppercase tracking-wider">1. Auth</span>
                        <span class="text-slate-300 dark:text-slate-600">/</span>
                        <span :class="state === 'upload' ? 'text-indigo-600 dark:text-indigo-400 drop-shadow-[0_0_8px_rgba(99,102,241,0.5)]' : ''" class="transition-all duration-300 uppercase tracking-wider">2. Upload</span>
                        <span class="text-slate-300 dark:text-slate-600">/</span>
                        <span :class="state === 'preview' ? 'text-indigo-600 dark:text-indigo-400 drop-shadow-[0_0_8px_rgba(99,102,241,0.5)]' : ''" class="transition-all duration-300 uppercase tracking-wider">3. Verify</span>
                    </div>

                    <!-- Download Excel Template Button -->

                    <a
                        href="{% url 'core:download_template' %}"
                        class="flex items-center gap-2 px-4 py-2 text-[11px] font-bold text-emerald-700 dark:text-emerald-400 bg-emerald-50 dark:bg-emerald-500/10 border border-emerald-300 dark:border-emerald-500/30 rounded-xl hover:bg-emerald-100 dark:hover:bg-emerald-500/20 hover:-translate-y-0.5 transition-all shadow-sm ring-1 ring-inset ring-emerald-500/10 group"
                        title="Download Excel Input Template"
                    >
                        <svg class="w-3.5 h-3.5 group-hover:animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        <span class="uppercase tracking-widest">Download Template</span>
                        <span class="text-emerald-500/60 dark:text-emerald-600 font-mono font-normal normal-case tracking-normal">.xlsx</span>
                    </a>
                </div>
            </div>
        </div>

        <div x-show="state === 'locked'" x-transition class="max-w-md mx-auto bg-white dark:bg-slate-800/80 backdrop-blur-xl rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-700/80 p-10 text-center mt-20 relative overflow-hidden ring-1 ring-inset ring-white/5">
            <div class="absolute -right-10 -top-10 w-32 h-32 bg-indigo-500/10 rounded-full blur-2xl"></div>

            <div class="w-16 h-16 bg-slate-100 dark:bg-slate-900 rounded-full flex items-center justify-center mx-auto mb-6 ring-1 ring-inset ring-slate-500/20 shadow-inner">
                <svg class="w-7 h-7 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
            </div>
            <h3 class="text-xl font-extrabold text-slate-900 dark:text-white mb-2 tracking-tight">Security Check</h3>
            <p class="text-xs text-slate-500 dark:text-slate-400 mb-8 font-medium">Enter 18-digit Session ID (OVATR...)</p>

            <div class="relative">
                <input
                    type="text"
                    x-model="inputCode"
                    @keyup="validateCode()"
                    class="block w-full text-center text-lg font-mono tracking-widest border border-slate-300 dark:border-slate-600 dark:bg-[#0b1121] dark:text-white rounded-xl focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500 uppercase py-3 shadow-inner transition-all leading-relaxed"
                    placeholder="OVATR..."
                    maxlength="18"
                    autofocus
                />
                <div class="text-[10px] font-bold tracking-widest uppercase mt-3 h-4 transition-colors duration-300" :class="codeError.includes('Verifying') ? 'text-indigo-500 animate-pulse' : 'text-rose-500'" x-text="codeError"></div>
            </div>
        </div>

        <div x-show="state === 'upload'" x-cloak class="max-w-2xl mx-auto mt-16 relative">
            <div
                class="relative border-2 border-dashed rounded-2xl p-16 text-center transition-all bg-white dark:bg-slate-800/50 backdrop-blur-md cursor-pointer group shadow-xl overflow-hidden"
                :class="isDragging ? 'border-indigo-500 bg-indigo-50 dark:bg-indigo-900/20 ring-4 ring-indigo-500/10' : 'border-slate-300 dark:border-slate-600 hover:border-indigo-400 dark:hover:border-indigo-500 hover:bg-slate-50 dark:hover:bg-slate-800/80'"
                @dragover.prevent="isDragging = true"
                @dragleave.prevent="isDragging = false"
                @drop.prevent="handleDrop($event)"
                @click="$refs.fileInput.click()"
            >
                <input type="file" x-ref="fileInput" class="hidden" accept=".xlsx,.xls" @change="handleFileSelect($event)" />

                <div class="w-20 h-20 bg-indigo-50 dark:bg-indigo-500/10 text-indigo-500 dark:text-indigo-400 rounded-full flex items-center justify-center mx-auto mb-6 group-hover:scale-110 group-hover:bg-indigo-100 dark:group-hover:bg-indigo-500/20 transition-all duration-300 shadow-inner ring-1 ring-inset ring-indigo-500/20">
                    <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                </div>
                <h3 class="text-xl font-extrabold text-slate-900 dark:text-white tracking-tight">Upload Core Excel Workbook</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400 mt-2 font-medium">Drag & drop or click to browse files (.xlsx)</p>

                <div x-show="isProcessing" x-transition.opacity class="absolute inset-0 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md z-10 flex flex-col items-center justify-center p-8">
                    <svg class="animate-spin h-10 w-10 text-indigo-500 mb-4" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <h4 class="text-sm font-bold text-slate-800 dark:text-white tracking-widest uppercase" x-text="progressMessage">Extracting Data...</h4>
                </div>
            </div>
        </div>

        <div x-show="state === 'preview'" x-cloak x-transition.opacity>
            <div class="flex items-center justify-between gap-4 mb-6 sticky top-0 bg-slate-50/90 dark:bg-[#0f172a]/90 backdrop-blur-xl py-4 z-40 border-b border-slate-200 dark:border-slate-800 shadow-sm px-2">
                <div class="flex items-center gap-3">
                    <span x-show="isSaving" class="flex items-center gap-2 px-3 py-1.5 bg-amber-500/10 border border-amber-500/20 text-amber-600 dark:text-amber-400 text-xs font-bold rounded-lg uppercase tracking-wider shadow-inner">
                        <svg class="animate-spin h-3.5 w-3.5" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span x-text="saveMessage"></span>
                    </span>
                </div>

                <div class="flex items-center gap-3">
                    <button @click="resetUpload()" :disabled="isSaving" class="px-5 py-2.5 text-xs font-bold text-slate-600 dark:text-slate-300 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-xl shadow-sm hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors disabled:opacity-50">Cancel</button>
                    <button @click="saveComputedData()" :disabled="isSaving" :class="isSaving ? 'opacity-75 cursor-wait' : 'hover:shadow-indigo-500/30 hover:-translate-y-0.5'" class="px-6 py-2.5 text-xs font-bold text-white bg-gradient-to-r from-indigo-600 to-violet-600 rounded-xl shadow-lg transition-all flex items-center gap-2 ring-1 ring-inset ring-white/20">
                        <svg x-show="isSaving" class="animate-spin -ml-1 mr-1 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span x-text="isSaving ? 'Processing...' : 'Confirm & Generate'"></span>
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-12 gap-6">
                <div class="lg:col-span-12 bg-white dark:bg-slate-800/80 backdrop-blur-sm p-6 lg:p-8 rounded-2xl shadow-xl border border-indigo-200 dark:border-indigo-500/30 bg-indigo-50/30 dark:bg-indigo-900/10 ring-1 ring-inset ring-indigo-500/10 relative overflow-hidden">
                    <div class="absolute -right-20 -top-20 w-64 h-64 bg-indigo-500/10 rounded-full blur-3xl pointer-events-none"></div>

                    <div class="mb-6 border-b border-indigo-200 dark:border-indigo-500/30 pb-3 relative z-10">
                        <h4 class="text-sm font-extrabold text-indigo-700 dark:text-indigo-400 uppercase tracking-widest flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            I. ព័ត៌មានសម្រាប់របាយការណ៍ (Report Configuration)
                        </h4>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 relative z-10">
                        <div class="lg:col-span-2 bg-white/50 dark:bg-[#0b1121]/50 p-5 rounded-xl border border-slate-200 dark:border-slate-700 shadow-inner">
                            <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-3">Auditor Names (សវនករ)</label>
                            <template x-for="(auditor, idx) in uiState.auditors" :key="idx">
                                <div class="flex gap-2 mb-2.5">
                                    <select x-model="auditor.title" class="w-1/3 text-xs font-bold border border-slate-300 dark:border-slate-600 dark:bg-slate-800 dark:text-white rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-indigo-500/50 shadow-sm font-khmer transition-all cursor-pointer">
                                        <option value="លោក">លោក</option>
                                        <option value="លោកស្រី">លោកស្រី</option>
                                        <option value="កញ្ញា">កញ្ញា</option>
                                    </select>
                                    <input type="text" x-model="auditor.name" class="w-full text-xs font-medium border border-slate-300 dark:border-slate-600 dark:bg-slate-800 dark:text-white rounded-lg px-4 py-2.5 font-khmer focus:ring-2 focus:ring-indigo-500/50 shadow-sm transition-all" placeholder="ឈ្មោះសវនករ..." />
                                    <button @click="uiState.auditors.splice(idx, 1)" class="text-rose-400 hover:text-rose-600 hover:bg-rose-50 dark:hover:bg-rose-900/30 font-bold px-3 rounded-lg transition-colors" x-show="uiState.auditors.length > 1">✕</button>
                                </div>
                            </template>
                            <button @click="uiState.auditors.push({title:'លោក', name:''})" class="text-xs text-indigo-600 dark:text-indigo-400 font-bold mt-1 hover:underline flex items-center gap-1">+ បន្ថែមសវនករ</button>
                        </div>

                        <div class="lg:col-span-2 bg-white/50 dark:bg-[#0b1121]/50 p-5 rounded-xl border border-slate-200 dark:border-slate-700 shadow-inner">
                            <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-3">Contact Person (អ្នកតំណាង)</label>
                            <div class="flex gap-2 mb-3">
                                <select x-model="uiState.contact_title" class="w-1/3 text-xs font-bold border border-slate-300 dark:border-slate-600 dark:bg-slate-800 dark:text-white rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-indigo-500/50 shadow-sm font-khmer transition-all cursor-pointer">
                                    <option value="លោក">លោក</option>
                                    <option value="លោកស្រី">លោកស្រី</option>
                                    <option value="កញ្ញា">កញ្ញា</option>
                                </select>
                                <input type="text" x-model="uiState.contact_name" class="w-full text-xs font-medium border border-slate-300 dark:border-slate-600 dark:bg-slate-800 dark:text-white rounded-lg px-4 py-2.5 font-khmer focus:ring-2 focus:ring-indigo-500/50 shadow-sm transition-all" placeholder="ឈ្មោះតំណាងក្រុមហ៊ុន..." />
                            </div>
                            <input type="text" x-model="formData.i_contact_position" class="w-full text-xs font-medium border border-slate-300 dark:border-slate-600 dark:bg-slate-800 dark:text-white rounded-lg px-4 py-2.5 font-khmer focus:ring-2 focus:ring-indigo-500/50 shadow-sm transition-all" placeholder="តួនាទី (ឧ. ប្រធានគណនេយ្យ)" />
                        </div>

                        <div class="lg:col-span-2 bg-white/50 dark:bg-[#0b1121]/50 p-5 rounded-xl border border-slate-200 dark:border-slate-700 shadow-inner" x-data="{ currentYear: new Date().getFullYear() }">
                            <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-3">Requested Period (រយៈពេលស្នើសុំ)</label>
                            <div class="flex items-center gap-3 mb-3">
                                <span class="text-xs font-bold text-slate-500 dark:text-slate-400 w-12 text-right">ចាប់ពី៖</span>
                                <select x-model="uiState.req_from_month" class="w-full text-xs font-medium border border-slate-300 dark:border-slate-600 dark:bg-slate-800 dark:text-white rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-indigo-500/50 shadow-sm font-khmer transition-all cursor-pointer">
                                    <option value="">ជ្រើសរើសខែ...</option>
                                    <template x-for="m in khmerMonths" :key="m"><option :value="m" x-text="m"></option></template>
                                </select>
                                <select x-model="uiState.req_from_year" class="w-24 text-xs font-bold font-mono border border-slate-300 dark:border-slate-600 dark:bg-slate-800 dark:text-white rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-indigo-500/50 shadow-sm transition-all cursor-pointer text-center">
                                    <option value="" disabled selected>YYYY</option>
                                    <template x-for="i in 15"><option :value="currentYear - i + 1" x-text="currentYear - i + 1"></option></template>
                                </select>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-xs font-bold text-slate-500 dark:text-slate-400 w-12 text-right">ដល់៖</span>
                                <select x-model="uiState.req_to_month" class="w-full text-xs font-medium border border-slate-300 dark:border-slate-600 dark:bg-slate-800 dark:text-white rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-indigo-500/50 shadow-sm font-khmer transition-all cursor-pointer">
                                    <option value="">ជ្រើសរើសខែ...</option>
                                    <template x-for="m in khmerMonths" :key="m"><option :value="m" x-text="m"></option></template>
                                </select>
                                <select x-model="uiState.req_to_year" class="w-24 text-xs font-bold font-mono border border-slate-300 dark:border-slate-600 dark:bg-slate-800 dark:text-white rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-indigo-500/50 shadow-sm transition-all cursor-pointer text-center">
                                    <option value="" disabled selected>YYYY</option>
                                    <template x-for="i in 15"><option :value="currentYear - i + 1" x-text="currentYear - i + 1"></option></template>
                                </select>
                            </div>
                        </div>

                        <div class="lg:col-span-2 bg-white/50 dark:bg-[#0b1121]/50 p-5 rounded-xl border border-slate-200 dark:border-slate-700 shadow-inner">
                            <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-3">Audit Timeline (កាលបរិច្ឆេទចុះសវនកម្ម)</label>
                            <div class="flex items-center gap-3 mb-3 relative">
                                <span class="text-xs font-bold text-slate-500 dark:text-slate-400 w-12 text-right">ថ្ងៃចុះ៖</span>
                                <input
                                    type="text"
                                    x-model="uiState.audit_start"
                                    x-init="flatpickr($el, { dateFormat: 'Y-m-d', altInput: true, altFormat: 'd-m-Y' })"
                                    class="w-full text-xs font-mono font-medium border border-slate-300 dark:border-slate-600 dark:bg-slate-800 dark:text-white rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-indigo-500/50 shadow-sm transition-all cursor-pointer bg-white"
                                    placeholder="DD-MM-YYYY"
                                />
                            </div>
                            <div class="flex items-center gap-3 relative">
                                <span class="text-xs font-bold text-slate-500 dark:text-slate-400 w-12 text-right">បញ្ច​ប់៖</span>
                                <input
                                    type="text"
                                    x-model="uiState.audit_end"
                                    x-init="flatpickr($el, { dateFormat: 'Y-m-d', altInput: true, altFormat: 'd-m-Y' })"
                                    class="w-full text-xs font-mono font-medium border border-slate-300 dark:border-slate-600 dark:bg-slate-800 dark:text-white rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-indigo-500/50 shadow-sm transition-all cursor-pointer bg-white"
                                    placeholder="DD-MM-YYYY"
                                />
                            </div>
                        </div>

                        <div class="lg:col-span-4 grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 mt-2">
                            <div>
                                <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-1.5">MOC Num</label>
                                <input type="text" x-model="formData.i_moc_number" class="w-full text-xs font-mono border border-slate-300 dark:border-slate-600 dark:bg-slate-800 dark:text-white rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-indigo-500/50 shadow-sm" placeholder="No..." />
                            </div>
                            <div class="relative">
                                <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-1.5">MOC Date</label>
                                <input
                                    type="text"
                                    x-model="formData.i_moc_date"
                                    x-init="flatpickr($el, { dateFormat: 'Y-m-d', altInput: true, altFormat: 'd-m-Y' })"
                                    class="w-full text-xs font-mono border border-slate-300 dark:border-slate-600 dark:bg-slate-800 dark:text-white rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-indigo-500/50 shadow-sm cursor-pointer bg-white"
                                    placeholder="DD-MM-YYYY"
                                />
                            </div>

                            <div class="relative">
                                <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-1.5">Patent Date</label>
                                <input
                                    type="text"
                                    x-model="formData.i_patent_date"
                                    x-init="flatpickr($el, { dateFormat: 'Y-m-d', altInput: true, altFormat: 'd-m-Y' })"
                                    class="w-full text-xs font-mono border border-slate-300 dark:border-slate-600 dark:bg-slate-800 dark:text-white rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-indigo-500/50 shadow-sm cursor-pointer bg-white"
                                    placeholder="DD-MM-YYYY"
                                />
                            </div>

                            <div
                                x-data="{ 
                                get formattedAmt() { 
                                    let val = this.formData.i_patent_amount ? String(this.formData.i_patent_amount).replace(/[^0-9]/g, '') : '';
                                    return val ? new Intl.NumberFormat('en-US').format(val) : '';
                                },
                                set formattedAmt(val) {
                                    this.formData.i_patent_amount = val ? val.replace(/[^0-9]/g, '') : '';
                                }
                            }"
                            >
                                <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-1.5">Patent Amt</label>
                                <div class="relative flex items-center bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg overflow-hidden focus-within:ring-2 focus-within:ring-indigo-500 focus-within:border-indigo-500 transition-all shadow-sm">
                                    <input type="text" x-model="formattedAmt" class="w-full py-2.5 pl-3 pr-2 text-xs font-mono text-right text-slate-900 dark:text-white bg-transparent border-none focus:ring-0" placeholder="0" />
                                    <div class="px-2.5 py-2.5 bg-slate-50 dark:bg-slate-800/50 border-l border-slate-200 dark:border-slate-700 flex items-center justify-center">
                                        <span class="text-slate-500 font-bold font-khmer text-[11px]">៛</span>
                                    </div>
                                </div>
                            </div>

                            <div class="relative">
                                <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-1.5">VAT Cert Date</label>
                                <input
                                    type="text"
                                    x-model="formData.i_vat_cert_date"
                                    x-init="flatpickr($el, { dateFormat: 'Y-m-d', altInput: true, altFormat: 'd-m-Y' })"
                                    class="w-full text-xs font-mono border border-slate-300 dark:border-slate-600 dark:bg-slate-800 dark:text-white rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-indigo-500/50 shadow-sm cursor-pointer bg-white"
                                    placeholder="DD-MM-YYYY"
                                />
                            </div>

                            <div class="relative">
                                <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-1.5">Request Date</label>
                                <input
                                    type="text"
                                    x-model="uiState.request_submission_date"
                                    x-init="flatpickr($el, { dateFormat: 'Y-m-d', altInput: true, altFormat: 'd-m-Y' })"
                                    class="w-full text-xs font-mono border border-slate-300 dark:border-slate-600 dark:bg-slate-800 dark:text-white rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-indigo-500/50 shadow-sm cursor-pointer bg-white"
                                    placeholder="DD-MM-YYYY"
                                />
                            </div>
                        </div>

                        <div
                            class="lg:col-span-4 mt-2"
                            x-data="{ 
                            get formattedReqAmt() { 
                                let val = this.formData.i_amount_requested ? String(this.formData.i_amount_requested).replace(/[^0-9]/g, '') : '';
                                return val ? new Intl.NumberFormat('en-US').format(val) : '';
                            },
                            set formattedReqAmt(val) {
                                this.formData.i_amount_requested = val ? val.replace(/[^0-9]/g, '') : '';
                            }
                        }"
                        >
                            <label class="block text-[10px] font-extrabold text-amber-600 dark:text-amber-500 uppercase tracking-widest mb-2">Amount Requested (ទឹកប្រាក់ស្នើសុំបង្វិលសង)</label>
                            <div class="relative flex items-center bg-amber-50 dark:bg-amber-500/10 border border-amber-300 dark:border-amber-500/50 rounded-xl overflow-hidden focus-within:ring-2 focus-within:ring-amber-500 transition-shadow shadow-inner">
                                <input type="text" x-model="formattedReqAmt" class="w-full py-4 pl-5 pr-2 text-xl font-mono font-black text-amber-900 dark:text-amber-300 bg-transparent border-none focus:ring-0 text-right" placeholder="0" />
                                <div class="px-5 py-4 bg-amber-100/50 dark:bg-amber-900/30 border-l border-amber-200 dark:border-amber-500/30 flex items-center justify-center">
                                    <span class="text-amber-700 dark:text-amber-400 font-bold font-khmer text-lg">៛</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-8 bg-white dark:bg-slate-800/80 backdrop-blur-sm p-6 lg:p-8 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 mt-2">
                    <h4 class="text-xs font-extrabold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-6 border-b border-slate-100 dark:border-slate-700/50 pb-3 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                        A. Core Identity
                    </h4>
                    <div class="grid grid-cols-2 gap-6">
                        <div class="col-span-1">
                            <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-1.5">Company Name (English)</label>
                            <input type="text" x-model="formData.company_name_en" class="w-full text-sm border border-slate-300 dark:border-slate-600 dark:bg-[#0b1121] dark:text-white rounded-xl px-4 py-3.5 font-bold text-slate-800 focus:ring-2 focus:ring-indigo-500/50 shadow-sm transition-all" />
                        </div>
                        <div class="col-span-1">
                            <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-1.5">Company Name (Khmer)</label>
                            <input type="text" x-model="formData.company_name_kh" class="w-full text-sm border border-slate-300 dark:border-slate-600 dark:bg-[#0b1121] dark:text-white rounded-xl px-4 py-3.5 font-bold font-khmer text-slate-800 focus:ring-2 focus:ring-indigo-500/50 shadow-sm transition-all" />
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-1.5">VATIN (New)</label>
                            <input type="text" x-model="formData.vatin" class="w-full text-sm font-mono border border-indigo-200 dark:border-indigo-500/30 rounded-xl px-4 py-3.5 bg-indigo-50 dark:bg-indigo-500/10 text-indigo-900 dark:text-indigo-300 font-extrabold focus:ring-2 focus:ring-indigo-500 shadow-sm transition-all" />
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-1.5">VATIN (Old)</label>
                            <input type="text" x-model="formData.old_vatin" class="w-full text-sm font-mono border border-slate-200 dark:border-slate-700/50 dark:bg-slate-900/50 rounded-xl px-4 py-3.5 text-slate-500 dark:text-slate-400 bg-slate-50 focus:ring-2 focus:ring-indigo-500/50 shadow-sm transition-all" />
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-1.5">Enterprise ID</label>
                            <input type="text" x-model="formData.enterprise_id" class="w-full text-sm font-mono border border-slate-300 dark:border-slate-600 dark:bg-[#0b1121] dark:text-white rounded-xl px-4 py-3.5 text-slate-800 focus:ring-2 focus:ring-indigo-500/50 shadow-sm transition-all" />
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-1.5">File Barcode</label>
                            <input type="text" x-model="formData.file_barcode" class="w-full text-sm font-mono border border-slate-200 dark:border-slate-700/50 dark:bg-slate-900/50 rounded-xl px-4 py-3.5 text-slate-500 dark:text-slate-400 bg-slate-50 focus:ring-2 focus:ring-indigo-500/50 shadow-sm transition-all" />
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-4 bg-white dark:bg-slate-800/80 backdrop-blur-sm p-6 lg:p-8 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 mt-2">
                    <h4 class="text-xs font-extrabold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-6 border-b border-slate-100 dark:border-slate-700/50 pb-3 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        B. Registration
                    </h4>
                    <div class="space-y-5">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-1.5">Status</label>
                            <input type="text" x-model="formData.status" class="w-full text-sm font-bold border border-emerald-200 dark:border-emerald-500/30 rounded-xl px-4 py-3.5 text-emerald-700 dark:text-emerald-400 bg-emerald-50 dark:bg-emerald-500/10 focus:ring-2 focus:ring-emerald-500 shadow-sm transition-all" />
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-1.5">Reg. Date</label>
                                <input type="text" x-model="formData.reg_date" class="w-full text-sm font-mono border border-slate-300 dark:border-slate-600 dark:bg-[#0b1121] dark:text-white rounded-xl px-4 py-3 text-slate-800 focus:ring-2 focus:ring-indigo-500/50 shadow-sm transition-all" />
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-1.5">Success Date</label>
                                <input type="text" x-model="formData.success_date" class="w-full text-sm font-mono border border-slate-300 dark:border-slate-600 dark:bg-[#0b1121] dark:text-white rounded-xl px-4 py-3 text-slate-800 focus:ring-2 focus:ring-indigo-500/50 shadow-sm transition-all" />
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="col-span-1">
                                <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-1.5">Taxpayer Type</label>
                                <input type="text" x-model="formData.taxpayer_type" class="w-full text-sm border border-slate-300 dark:border-slate-600 dark:bg-[#0b1121] dark:text-white rounded-xl px-4 py-3 text-slate-800 focus:ring-2 focus:ring-indigo-500/50 shadow-sm transition-all" />
                            </div>
                            <div class="col-span-1">
                                <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-1.5">Tax Year</label>
                                <input type="text" x-model="formData.tax_year" class="w-full text-sm font-mono font-bold border border-slate-300 dark:border-slate-600 bg-white dark:bg-[#0b1121] dark:text-white rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500/50 shadow-sm transition-all text-center" />
                            </div>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-1.5">Registered Entity</label>
                            <input type="text" x-model="formData.registered_entity" class="w-full text-sm font-mono border border-slate-300 dark:border-slate-600 dark:bg-[#0b1121] dark:text-white rounded-xl px-4 py-3 text-slate-800 focus:ring-2 focus:ring-indigo-500/50 shadow-sm transition-all" />
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-6 bg-white dark:bg-slate-800/80 backdrop-blur-sm p-6 lg:p-8 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">
                    <h4 class="text-xs font-extrabold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-6 border-b border-slate-100 dark:border-slate-700/50 pb-3 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        C. Contact Info
                    </h4>
                    <div class="grid grid-cols-2 gap-5 mb-5">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-1.5">Phone</label>
                            <input type="text" x-model="formData.phone" class="w-full text-sm font-mono border border-slate-300 dark:border-slate-600 dark:bg-[#0b1121] dark:text-white rounded-xl px-4 py-3 text-slate-800 focus:ring-2 focus:ring-indigo-500/50 shadow-sm transition-all" />
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-1.5">Email</label>
                            <input type="text" x-model="formData.email" class="w-full text-sm border border-slate-300 dark:border-slate-600 dark:bg-[#0b1121] dark:text-white rounded-xl px-4 py-3 text-slate-800 focus:ring-2 focus:ring-indigo-500/50 shadow-sm transition-all" />
                        </div>
                    </div>
                    <div class="space-y-5">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-1.5">Main Address</label>
                            <textarea x-model="formData.address_main" rows="3" class="w-full text-sm font-khmer border border-slate-300 dark:border-slate-600 rounded-xl p-4 leading-relaxed text-slate-900 dark:text-white bg-white dark:bg-[#0b1121] focus:ring-2 focus:ring-indigo-500/50 shadow-sm transition-all"></textarea>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-1.5">Office Address</label>
                            <textarea x-model="formData.address_office" rows="3" class="w-full text-sm font-khmer border border-slate-300 dark:border-slate-600 rounded-xl p-4 leading-relaxed text-slate-900 dark:text-white bg-white dark:bg-[#0b1121] focus:ring-2 focus:ring-indigo-500/50 shadow-sm transition-all"></textarea>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-6 bg-white dark:bg-slate-800/80 backdrop-blur-sm p-6 lg:p-8 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">
                    <h4 class="text-xs font-extrabold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-6 border-b border-slate-100 dark:border-slate-700/50 pb-3 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        D. Operational Metrics
                    </h4>
                    <div class="grid grid-cols-2 gap-5">
                        <div
                            x-data="{ 
                            get formattedEmp() { 
                                let val = this.formData.employee_count ? String(this.formData.employee_count).replace(/[^0-9]/g, '') : '';
                                return val ? new Intl.NumberFormat('en-US').format(val) : '';
                            },
                            set formattedEmp(val) {
                                this.formData.employee_count = val ? val.replace(/[^0-9]/g, '') : '';
                            }
                        }"
                        >
                            <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-1.5">Employees</label>
                            <div class="flex items-center bg-white dark:bg-[#0b1121] border border-slate-300 dark:border-slate-600 rounded-xl overflow-hidden focus-within:ring-2 focus-within:ring-indigo-500 transition-all shadow-sm">
                                <input type="text" x-model="formattedEmp" class="flex-1 w-full py-3.5 pl-4 pr-2 text-sm font-mono text-right text-slate-800 dark:text-white bg-transparent border-none focus:ring-0" placeholder="0" />
                                <div class="px-3 py-3.5 bg-slate-50 dark:bg-slate-800/50 border-l border-slate-200 dark:border-slate-700 flex items-center justify-center">
                                    <span class="text-slate-500 font-bold font-khmer text-xs">នាក់</span>
                                </div>
                            </div>
                        </div>

                        <div
                            x-data="{ 
                            get formattedSal() { 
                                let val = this.formData.total_salary ? String(this.formData.total_salary).replace(/[^0-9]/g, '') : '';
                                return val ? new Intl.NumberFormat('en-US').format(val) : '';
                            },
                            set formattedSal(val) {
                                this.formData.total_salary = val ? val.replace(/[^0-9]/g, '') : '';
                            }
                        }"
                        >
                            <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-1.5">Total Salary (KHR)</label>
                            <div class="flex items-center bg-white dark:bg-[#0b1121] border border-slate-300 dark:border-slate-600 rounded-xl overflow-hidden focus-within:ring-2 focus-within:ring-indigo-500 transition-all shadow-sm">
                                <input type="text" x-model="formattedSal" class="flex-1 w-full py-3.5 pl-4 pr-2 text-sm font-mono font-bold text-right text-slate-800 dark:text-white bg-transparent border-none focus:ring-0" placeholder="0" />
                                <div class="px-3 py-3.5 bg-slate-50 dark:bg-slate-800/50 border-l border-slate-200 dark:border-slate-700 flex items-center justify-center">
                                    <span class="text-slate-500 font-bold font-khmer text-xs">រៀល</span>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-1.5">Property Type</label>
                            <input type="text" x-model="formData.property_type" class="w-full text-sm font-khmer border border-slate-300 dark:border-slate-600 dark:bg-[#0b1121] dark:text-white rounded-xl px-4 py-3.5 text-slate-800 focus:ring-2 focus:ring-indigo-500/50 shadow-sm transition-all" />
                        </div>

                        <div
                            x-data="{ 
                            get formattedRent() { 
                                let val = this.formData.rent_per_month ? String(this.formData.rent_per_month).replace(/[^0-9]/g, '') : '';
                                return val ? new Intl.NumberFormat('en-US').format(val) : '';
                            },
                            set formattedRent(val) {
                                this.formData.rent_per_month = val ? val.replace(/[^0-9]/g, '') : '';
                            }
                        }"
                        >
                            <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-1.5">Rent (KHR)</label>
                            <div class="flex items-center bg-white dark:bg-[#0b1121] border border-slate-300 dark:border-slate-600 rounded-xl overflow-hidden focus-within:ring-2 focus-within:ring-indigo-500 transition-all shadow-sm">
                                <input type="text" x-model="formattedRent" class="flex-1 w-full py-3.5 pl-4 pr-2 text-sm font-mono font-bold text-right text-slate-800 dark:text-white bg-transparent border-none focus:ring-0" placeholder="0" />
                                <div class="px-3 py-3.5 bg-slate-50 dark:bg-slate-800/50 border-l border-slate-200 dark:border-slate-700 flex items-center justify-center">
                                    <span class="text-slate-500 font-bold font-khmer text-xs">រៀល</span>
                                </div>
                            </div>
                        </div>

                        <div class="col-span-2">
                            <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-1.5">Enterprise Form</label>
                            <input type="text" x-model="formData.enterprise_form" class="w-full text-sm font-khmer border border-slate-300 dark:border-slate-600 dark:bg-[#0b1121] dark:text-white rounded-xl px-4 py-3.5 mb-2.5 text-slate-800 focus:ring-2 focus:ring-indigo-500/50 shadow-sm transition-all" />
                            <input type="text" x-model="formData.add_ent_form" class="w-full text-sm font-khmer border border-slate-200 dark:border-slate-700/50 dark:bg-slate-900/50 rounded-xl px-4 py-3.5 text-slate-500 bg-slate-50 focus:ring-2 focus:ring-indigo-500/50 shadow-inner transition-all" placeholder="Additional..." />
                        </div>
                        <div class="col-span-2">
                            <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-1.5">Signage</label>
                            <input type="text" x-model="formData.signage" class="w-full text-sm font-khmer border border-slate-300 dark:border-slate-600 dark:bg-[#0b1121] dark:text-white rounded-xl px-4 py-3.5 text-slate-800 focus:ring-2 focus:ring-indigo-500/50 shadow-sm transition-all" />
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-12 bg-white dark:bg-slate-800/80 backdrop-blur-sm p-6 lg:p-8 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">
                    <div class="flex justify-between items-center mb-6 border-b border-slate-100 dark:border-slate-700/50 pb-3">
                        <h4 class="text-xs font-extrabold text-slate-500 dark:text-slate-400 uppercase tracking-widest flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                            E. សកម្មភាពអាជីវកម្ម (Business Activities)
                        </h4>
                        <button @click="formData.business_activities.push({no:'', code:'', name:'', desc:'', type:''})" class="text-xs bg-indigo-50 dark:bg-indigo-500/10 text-indigo-600 dark:text-indigo-400 px-4 py-1.5 rounded-full font-bold hover:bg-indigo-100 dark:hover:bg-indigo-500/20 transition-colors shadow-sm ring-1 ring-inset ring-indigo-500/20">+ Add Row</button>
                    </div>
                    <div class="overflow-x-auto custom-scrollbar pb-2">
                        <table class="w-full min-w-[700px]">
                            <thead>
                                <tr class="text-left text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest bg-slate-50 dark:bg-slate-900/50">
                                    <th class="p-3 rounded-l-xl w-14 text-center">No</th>
                                    <th class="p-3 w-28">Code</th>
                                    <th class="p-3">Activity Name (Khmer)</th>
                                    <th class="p-3">Description (Khmer)</th>
                                    <th class="p-3 w-32">Type</th>
                                    <th class="p-3 rounded-r-xl w-12 text-center">Act</th>
                                </tr>
                            </thead>
                            <tbody class="space-y-2">
                                <template x-for="(item, index) in formData.business_activities" :key="index">
                                    <tr>
                                        <td class="p-1.5"><input type="text" x-model="item.no" class="w-full text-xs text-center border-slate-300 dark:border-slate-600 dark:bg-[#0b1121] dark:text-white rounded-lg px-2 py-2.5 shadow-sm font-mono focus:ring-1 focus:ring-indigo-500 transition-all" /></td>
                                        <td class="p-1.5"><input type="text" x-model="item.code" class="w-full text-xs font-bold border-slate-300 dark:border-slate-600 dark:bg-[#0b1121] dark:text-white rounded-lg px-3 py-2.5 shadow-sm font-mono focus:ring-1 focus:ring-indigo-500 transition-all" /></td>
                                        <td class="p-1.5"><input type="text" x-model="item.name" class="w-full text-xs border-slate-300 dark:border-slate-600 dark:bg-[#0b1121] dark:text-white rounded-lg px-3 py-2.5 shadow-sm font-khmer focus:ring-1 focus:ring-indigo-500 transition-all" /></td>
                                        <td class="p-1.5"><input type="text" x-model="item.desc" class="w-full text-xs border-slate-300 dark:border-slate-600 dark:bg-[#0b1121] dark:text-white rounded-lg px-3 py-2.5 shadow-sm font-khmer focus:ring-1 focus:ring-indigo-500 transition-all" /></td>
                                        <td class="p-1.5"><input type="text" x-model="item.type" class="w-full text-xs font-mono border-slate-300 dark:border-slate-600 dark:bg-[#0b1121] dark:text-white rounded-lg px-3 py-2.5 shadow-sm focus:ring-1 focus:ring-indigo-500 transition-all text-center" /></td>
                                        <td class="p-1.5 text-center">
                                            <button @click="formData.business_activities.splice(index, 1)" class="w-7 h-7 inline-flex items-center justify-center rounded-full bg-rose-50 text-rose-500 hover:bg-rose-500 hover:text-white dark:bg-rose-500/10 dark:text-rose-400 dark:hover:bg-rose-500/30 transition-colors font-bold shadow-sm ring-1 ring-inset ring-rose-500/20">✕</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="lg:col-span-12 bg-white dark:bg-slate-800/80 backdrop-blur-sm p-6 lg:p-8 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">
                    <div class="flex justify-between items-center mb-6 border-b border-slate-100 dark:border-slate-700/50 pb-3">
                        <h4 class="text-xs font-extrabold text-slate-500 dark:text-slate-400 uppercase tracking-widest flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                            F. គណនីសហគ្រាស (Accounts)
                        </h4>
                        <button @click="formData.enterprise_accounts.push({no:'', bank:'', account_name:'', number:'', currency:'', type:''})" class="text-xs bg-indigo-50 dark:bg-indigo-500/10 text-indigo-600 dark:text-indigo-400 px-4 py-1.5 rounded-full font-bold hover:bg-indigo-100 dark:hover:bg-indigo-500/20 transition-colors shadow-sm ring-1 ring-inset ring-indigo-500/20">+ Add Row</button>
                    </div>
                    <div class="overflow-x-auto custom-scrollbar pb-2">
                        <table class="w-full min-w-[800px]">
                            <thead>
                                <tr class="text-left text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest bg-slate-50 dark:bg-slate-900/50">
                                    <th class="p-3 rounded-l-xl w-14 text-center">No</th>
                                    <th class="p-3">Bank Name</th>
                                    <th class="p-3">Account Number</th>
                                    <th class="p-3">Account Name</th>
                                    <th class="p-3 w-28 text-center">Currency</th>
                                    <th class="p-3 w-32">Type</th>
                                    <th class="p-3 rounded-r-xl w-12 text-center">Act</th>
                                </tr>
                            </thead>
                            <tbody class="space-y-2">
                                <template x-for="(item, index) in formData.enterprise_accounts" :key="index">
                                    <tr>
                                        <td class="p-1.5"><input type="text" x-model="item.no" class="w-full text-xs text-center border-slate-300 dark:border-slate-600 dark:bg-[#0b1121] dark:text-white rounded-lg px-2 py-2.5 shadow-sm font-mono focus:ring-1 focus:ring-indigo-500 transition-all" /></td>
                                        <td class="p-1.5"><input type="text" x-model="item.bank" class="w-full text-xs border-slate-300 dark:border-slate-600 dark:bg-[#0b1121] dark:text-white rounded-lg px-3 py-2.5 shadow-sm font-khmer focus:ring-1 focus:ring-indigo-500 transition-all" /></td>
                                        <td class="p-1.5"><input type="text" x-model="item.number" class="w-full text-xs font-black tracking-wider text-indigo-700 dark:text-indigo-400 border-slate-300 dark:border-slate-600 dark:bg-[#0b1121] rounded-lg px-3 py-2.5 shadow-sm font-mono focus:ring-1 focus:ring-indigo-500 transition-all" /></td>
                                        <td class="p-1.5"><input type="text" x-model="item.account_name" class="w-full text-xs border-slate-300 dark:border-slate-600 dark:bg-[#0b1121] dark:text-white rounded-lg px-3 py-2.5 shadow-sm font-khmer focus:ring-1 focus:ring-indigo-500 transition-all" /></td>
                                        <td class="p-1.5"><input type="text" x-model="item.currency" class="w-full text-xs font-bold border-slate-300 dark:border-slate-600 dark:bg-[#0b1121] dark:text-white rounded-lg px-2 py-2.5 shadow-sm text-center focus:ring-1 focus:ring-indigo-500 transition-all uppercase" /></td>
                                        <td class="p-1.5"><input type="text" x-model="item.type" class="w-full text-xs border-slate-300 dark:border-slate-600 dark:bg-[#0b1121] dark:text-white rounded-lg px-3 py-2.5 shadow-sm focus:ring-1 focus:ring-indigo-500 transition-all" /></td>
                                        <td class="p-1.5 text-center">
                                            <button @click="formData.enterprise_accounts.splice(index, 1)" class="w-7 h-7 inline-flex items-center justify-center rounded-full bg-rose-50 text-rose-500 hover:bg-rose-500 hover:text-white dark:bg-rose-500/10 dark:text-rose-400 dark:hover:bg-rose-500/30 transition-colors font-bold shadow-sm ring-1 ring-inset ring-rose-500/20">✕</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="lg:col-span-6 bg-white dark:bg-slate-800/80 backdrop-blur-sm p-6 lg:p-8 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">
                    <div class="flex justify-between items-center mb-6 border-b border-slate-100 dark:border-slate-700/50 pb-3">
                        <h4 class="text-xs font-extrabold text-slate-500 dark:text-slate-400 uppercase tracking-widest flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                            G. ស្ថាប័នពាក់ព័ន្ធ (Institutions)
                        </h4>
                        <button @click="formData.related_institutions.push({no: '', name:'', ref:'', date:''})" class="text-xs bg-indigo-50 dark:bg-indigo-500/10 text-indigo-600 dark:text-indigo-400 px-4 py-1.5 rounded-full font-bold hover:bg-indigo-100 dark:hover:bg-indigo-500/20 transition-colors shadow-sm ring-1 ring-inset ring-indigo-500/20">+ Add Row</button>
                    </div>
                    <div class="overflow-x-auto custom-scrollbar pb-2">
                        <table class="w-full min-w-[500px]">
                            <thead>
                                <tr class="text-left text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest bg-slate-50 dark:bg-slate-900/50">
                                    <th class="p-3 rounded-l-xl w-14 text-center">No</th>
                                    <th class="p-3 w-1/2">Name</th>
                                    <th class="p-3">Reference</th>
                                    <th class="p-3 w-32">Date</th>
                                    <th class="p-3 rounded-r-xl w-12 text-center">Act</th>
                                </tr>
                            </thead>
                            <tbody class="space-y-2">
                                <template x-for="(item, index) in formData.related_institutions" :key="index">
                                    <tr>
                                        <td class="p-1.5"><input type="text" x-model="item.no" class="w-full text-xs text-center border-slate-300 dark:border-slate-600 dark:bg-[#0b1121] dark:text-white rounded-lg px-2 py-2.5 shadow-sm font-mono focus:ring-1 focus:ring-indigo-500 transition-all" /></td>
                                        <td class="p-1.5"><input type="text" x-model="item.name" class="w-full text-xs border-slate-300 dark:border-slate-600 dark:bg-[#0b1121] dark:text-white rounded-lg px-3 py-2.5 shadow-sm font-khmer focus:ring-1 focus:ring-indigo-500 transition-all" /></td>
                                        <td class="p-1.5"><input type="text" x-model="item.ref" class="w-full text-xs border-slate-300 dark:border-slate-600 dark:bg-[#0b1121] dark:text-white rounded-lg px-3 py-2.5 shadow-sm focus:ring-1 focus:ring-indigo-500 transition-all" /></td>
                                        <td class="p-1.5"><input type="text" x-model="item.date" class="w-full text-xs font-mono border-slate-300 dark:border-slate-600 dark:bg-[#0b1121] dark:text-white rounded-lg px-3 py-2.5 shadow-sm focus:ring-1 focus:ring-indigo-500 transition-all" /></td>
                                        <td class="p-1.5 text-center">
                                            <button @click="formData.related_institutions.splice(index, 1)" class="w-7 h-7 inline-flex items-center justify-center rounded-full bg-rose-50 text-rose-500 hover:bg-rose-500 hover:text-white dark:bg-rose-500/10 dark:text-rose-400 dark:hover:bg-rose-500/30 transition-colors font-bold shadow-sm ring-1 ring-inset ring-rose-500/20">✕</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="lg:col-span-6 bg-white dark:bg-slate-800/80 backdrop-blur-sm p-6 lg:p-8 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">
                    <div class="mb-6 border-b border-slate-100 dark:border-slate-700/50 pb-3">
                        <h4 class="text-xs font-extrabold text-slate-500 dark:text-slate-400 uppercase tracking-widest flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path></svg>
                            H. ការប៉ាន់ស្មានផលរបរ (Estimates)
                        </h4>
                    </div>

                    <div class="flex items-center justify-between gap-4 mb-6 bg-amber-50 dark:bg-amber-900/10 p-4 rounded-xl border border-amber-200 dark:border-amber-500/20 ring-1 ring-inset ring-amber-500/10 relative">
                        <label class="text-[11px] font-bold text-amber-800 dark:text-amber-500 uppercase tracking-widest font-khmer whitespace-nowrap">កាលបរិច្ឆេទផ្គត់ផ្គង់</label>
                        <input type="text" x-model="formData.h_date" class="w-48 text-sm font-mono font-black text-center border border-amber-300 dark:border-amber-500/50 rounded-lg px-3 py-2 bg-white dark:bg-[#0b1121] text-amber-900 dark:text-amber-400 focus:ring-2 focus:ring-amber-500 shadow-inner transition-all" />
                    </div>

                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr>
                                    <th class="w-1/3 border-b border-slate-200 dark:border-slate-700"></th>
                                    <th class="p-3 text-[10px] font-bold text-slate-500 dark:text-slate-400 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 text-center font-khmer rounded-tl-xl">១២ ខែកន្លងមក</th>
                                    <th class="p-3 text-[10px] font-bold text-slate-500 dark:text-slate-400 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 text-center font-khmer rounded-tr-xl">៣ ខែខាងមុខ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="p-3 text-[11px] font-bold text-slate-700 dark:text-slate-300 font-khmer border border-slate-200 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-800/50">ផលរបរផ្គត់ផ្គង់រយ:ពេល</td>

                                    <td
                                        class="p-2 border border-slate-200 dark:border-slate-700 bg-white dark:bg-[#0b1121]"
                                        x-data="{ 
                                        get formattedVal() { let v = this.formData.h_real_12m ? String(this.formData.h_real_12m).replace(/[^0-9]/g, '') : ''; return v ? new Intl.NumberFormat('en-US').format(v) : ''; },
                                        set formattedVal(v) { this.formData.h_real_12m = v ? v.replace(/[^0-9]/g, '') : ''; }
                                    }"
                                    >
                                        <div class="flex items-center w-full group focus-within:ring-1 focus-within:ring-indigo-500 rounded transition-all">
                                            <input type="text" x-model="formattedVal" class="flex-1 w-full text-sm font-mono font-bold text-right border-none bg-transparent focus:ring-0 text-slate-800 dark:text-slate-200 p-1" placeholder="0" />
                                            <span class="text-[11px] font-bold font-khmer text-slate-400 ml-1 mr-2 select-none">រៀល</span>
                                        </div>
                                    </td>

                                    <td
                                        class="p-2 border border-slate-200 dark:border-slate-700 bg-white dark:bg-[#0b1121]"
                                        x-data="{ 
                                        get formattedVal() { let v = this.formData.h_real_3m ? String(this.formData.h_real_3m).replace(/[^0-9]/g, '') : ''; return v ? new Intl.NumberFormat('en-US').format(v) : ''; },
                                        set formattedVal(v) { this.formData.h_real_3m = v ? v.replace(/[^0-9]/g, '') : ''; }
                                    }"
                                    >
                                        <div class="flex items-center w-full group focus-within:ring-1 focus-within:ring-indigo-500 rounded transition-all">
                                            <input type="text" x-model="formattedVal" class="flex-1 w-full text-sm font-mono font-bold text-right border-none bg-transparent focus:ring-0 text-slate-800 dark:text-slate-200 p-1" placeholder="0" />
                                            <span class="text-[11px] font-bold font-khmer text-slate-400 ml-1 mr-2 select-none">រៀល</span>
                                        </div>
                                    </td>
                                </tr>

                                <tr>
                                    <td class="p-3 text-[11px] font-bold text-slate-700 dark:text-slate-300 font-khmer border border-slate-200 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-800/50 rounded-bl-xl">ការប៉ាន់ស្មានផលរបររយ:ពេល</td>

                                    <td
                                        class="p-2 border border-slate-200 dark:border-slate-700 bg-white dark:bg-[#0b1121]"
                                        x-data="{ 
                                        get formattedVal() { let v = this.formData.h_est_12m ? String(this.formData.h_est_12m).replace(/[^0-9]/g, '') : ''; return v ? new Intl.NumberFormat('en-US').format(v) : ''; },
                                        set formattedVal(v) { this.formData.h_est_12m = v ? v.replace(/[^0-9]/g, '') : ''; }
                                    }"
                                    >
                                        <div class="flex items-center w-full group focus-within:ring-1 focus-within:ring-indigo-500 rounded transition-all">
                                            <input type="text" x-model="formattedVal" class="flex-1 w-full text-sm font-mono font-bold text-right border-none bg-transparent focus:ring-0 text-slate-800 dark:text-slate-200 p-1" placeholder="0" />
                                            <span class="text-[11px] font-bold font-khmer text-slate-400 ml-1 mr-2 select-none">រៀល</span>
                                        </div>
                                    </td>

                                    <td
                                        class="p-2 border border-slate-200 dark:border-slate-700 bg-white dark:bg-[#0b1121] rounded-br-xl"
                                        x-data="{ 
                                        get formattedVal() { let v = this.formData.h_est_3m ? String(this.formData.h_est_3m).replace(/[^0-9]/g, '') : ''; return v ? new Intl.NumberFormat('en-US').format(v) : ''; },
                                        set formattedVal(v) { this.formData.h_est_3m = v ? v.replace(/[^0-9]/g, '') : ''; }
                                    }"
                                    >
                                        <div class="flex items-center w-full group focus-within:ring-1 focus-within:ring-indigo-500 rounded transition-all">
                                            <input type="text" x-model="formattedVal" class="flex-1 w-full text-sm font-mono font-bold text-right border-none bg-transparent focus:ring-0 text-slate-800 dark:text-slate-200 p-1" placeholder="0" />
                                            <span class="text-[11px] font-bold font-khmer text-slate-400 ml-1 mr-2 select-none">រៀល</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button
        x-show="showScrollButton"
        @click="window.scrollTo({top: 0, behavior: 'smooth'})"
        x-transition.opacity
        class="fixed bottom-8 right-8 bg-gradient-to-r from-indigo-500 to-violet-600 text-white p-4 rounded-full shadow-[0_10px_25px_rgba(99,102,241,0.4)] hover:shadow-[0_15px_35px_rgba(99,102,241,0.6)] transition-all focus:outline-none z-50 flex items-center justify-center transform hover:-translate-y-1"
        title="Scroll to Top"
        x-cloak
    >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 15l7-7 7 7"></path></svg>
    </button>
</div>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('crosscheckWorkflow', () => ({
            state: 'locked', // locked, upload, preview
            inputCode: '',
            codeError: '',
            ovatrCode: '',
            isDragging: false,
            isProcessing: false,
            progressMessage: '',
            isSaving: false,
            saveMessage: '',
            showScrollButton: false,

            // For the dropdown menus
            khmerMonths: ['មករា', 'កុម្ភៈ', 'មីនា', 'មេសា', 'ឧសភា', 'មិថុនា', 'កក្កដា', 'សីហា', 'កញ្ញា', 'តុលា', 'វិច្ឆិកា', 'ធ្នូ'],

            uiState: {
                auditors: [{title: 'លោក', name: ''}],
                contact_title: 'លោក',
                contact_name: '',
                req_from_month: '',
                req_from_year: '',
                req_to_month: '',
                req_to_year: '',
                audit_start: '',
                audit_end: '',
                request_submission_date: '',
            },

            formData: {
                // Core
                company_name_kh: '',
                company_name_en: '',
                vatin: '',
                old_vatin: '',
                enterprise_id: '',
                file_barcode: '',
                status: '',
                reg_date: '',
                success_date: '',
                taxpayer_type: '',
                tax_year: '',
                registered_entity: '',

                // Contact
                phone: '',
                email: '',
                address_main: '',
                address_office: '',

                // Operations
                employee_count: '',
                total_salary: '',
                property_type: '',
                rent_per_month: '',
                enterprise_form: '',
                add_ent_form: '',
                signage: '',

                // Tables
                business_activities: [],
                enterprise_accounts: [],
                related_institutions: [],

                // Report Info specific fields
                i_moc_number: '',
                i_moc_date: '',
                i_patent_date: '',
                i_patent_amount: '',
                i_vat_cert_date: '',
                i_contact_position: '',
                i_amount_requested: '',

                // Estimates
                h_date: '',
                h_real_12m: '',
                h_real_3m: '',
                h_est_12m: '',
                h_est_3m: '',
            },

            init() {
                window.addEventListener('scroll', () => {
                    this.showScrollButton = window.pageYOffset > 300;
                });
                const savedDraft = localStorage.getItem('crosscheck_draft');
                if (savedDraft) {
                    try {
                        const parsed = JSON.parse(savedDraft);
                        if (parsed.state) this.state = parsed.state;
                        if (parsed.ovatrCode) this.ovatrCode = parsed.ovatrCode;
                        if (parsed.tempFilePath) this.tempFilePath = parsed.tempFilePath;
                        if (parsed.formData) this.formData = {...this.formData, ...parsed.formData};
                        if (parsed.uiState) this.uiState = {...this.uiState, ...parsed.uiState};
                    } catch (e) {
                        console.error('Failed to parse saved state from local storage', e);
                    }
                }
                this.$watch('state', () => this.persistState());
                this.$watch('ovatrCode', () => this.persistState());
                this.$watch('tempFilePath', () => this.persistState());
                this.$watch('formData', () => this.persistState(), {deep: true});
                this.$watch('uiState', () => this.persistState(), {deep: true});
            },

            persistState() {
                const draft = {state: this.state, ovatrCode: this.ovatrCode, tempFilePath: this.tempFilePath, formData: this.formData, uiState: this.uiState};
                localStorage.setItem('crosscheck_draft', JSON.stringify(draft));
            },

            clearSession() {
                if (confirm('Warning: This will clear all your progress and current data. Continue?')) {
                    localStorage.removeItem('crosscheck_draft');
                    window.location.reload();
                }
            },

            formatKhmerDate(dateStr) {
                if (!dateStr) return '';
                const parts = dateStr.split('-');
                if (parts.length !== 3) return '';
                const year = parts[0];
                const monthIndex = parseInt(parts[1], 10) - 1;
                const day = parseInt(parts[2], 10);
                return `ថ្ងៃទី${day} ខែ${this.khmerMonths[monthIndex]} ឆ្នាំ${year}`;
            },

            validateCode() {
                const code = this.inputCode.toUpperCase();
                if (code.length === 0) {
                    this.codeError = '';
                    return;
                }
                if (!code.startsWith('OVATR')) {
                    this.codeError = 'Must start with "OVATR"';
                    return;
                }
                if (code.length === 18) {
                    this.codeError = '';
                    this.isProcessing = true;
                    setTimeout(() => {
                        this.ovatrCode = code;
                        this.state = 'upload';
                        this.inputCode = '';
                        this.isProcessing = false;
                    }, 500);
                } else if (code.length > 5) {
                    this.codeError = `Verifying... (${code.length}/18)`;
                } else {
                    this.codeError = '';
                }
            },

            handleDrop(e) {
                this.isDragging = false;
                if (e.dataTransfer.files.length > 0) this.uploadFile(e.dataTransfer.files[0]);
            },
            handleFileSelect(e) {
                if (e.target.files.length > 0) this.uploadFile(e.target.files[0]);
            },

            uploadFile(file) {
                if (!file.name.match(/\.(xlsx|xls)$/i)) {
                    alert('Invalid file format. Please upload .xlsx');
                    return;
                }
                this.isProcessing = true;
                const fd = new FormData();
                fd.append('file', file);
                fetch('{% url "crosscheck:upload_init" %}', {method: 'POST', body: fd})
                    .then((r) => r.json())
                    .then((res) => {
                        this.isProcessing = false;
                        if (res.status === 'success') {
                            this.formData = {...this.formData, ...res.data};
                            this.tempFilePath = res.temp_path;
                            this.state = 'preview';
                        } else {
                            alert('Upload Error: ' + res.message);
                        }
                    })
                    .catch((e) => {
                        this.isProcessing = false;
                        console.error(e);
                        alert('System Error: Upload failed.');
                    });
            },

            resetUpload() {
                if (confirm('Discard current data and upload new file?')) {
                    this.state = 'upload';
                    this.tempFilePath = '';
                }
            },

            saveComputedData() {
                if (!this.tempFilePath) {
                    alert('Error: Source file lost. Please upload again.');
                    return;
                }
                this.isSaving = true;
                this.saveMessage = 'Saving Company Info...';

                // CREATE A COPY OF FORM DATA to safely manipulate before sending
                let payload = {...this.formData};
                payload.OVATR = this.ovatrCode;

                // 1. Process Auditors
                payload.i_auditor_names = this.uiState.auditors
                    .filter((a) => a.name.trim() !== '')
                    .map((a) => `${a.title} ${a.name}`)
                    .join(', ');

                // 2. Process Requested Period
                let reqDate = '';
                if (this.uiState.req_from_month && this.uiState.req_from_year) {
                    reqDate = `ខែ${this.uiState.req_from_month} ឆ្នាំ${this.uiState.req_from_year}`;
                    if (this.uiState.req_to_month && this.uiState.req_to_year) reqDate += ` ដល់ខែ${this.uiState.req_to_month} ឆ្នាំ${this.uiState.req_to_year}`;
                }
                payload.i_request_date = reqDate;

                // 3. Process Audit Timeline
                let auditTimeline = '';
                if (this.uiState.audit_start) {
                    auditTimeline = `ពី${this.formatKhmerDate(this.uiState.audit_start)}`;
                    if (this.uiState.audit_end) auditTimeline += ` ដល់${this.formatKhmerDate(this.uiState.audit_end)}`;
                }
                payload.i_audit_timeline = auditTimeline;

                // 4. Process Contact & Submission Date
                payload.i_contact_person = this.uiState.contact_name.trim() !== '' ? `${this.uiState.contact_title} ${this.uiState.contact_name}` : '';
                payload.i_request_submission_date = this.uiState.request_submission_date ? `ស្នើសុំបង្វិលសងអាករលើតម្លៃបន្ថែមតាមអនឡាញចុះ${this.formatKhmerDate(this.uiState.request_submission_date)}` : '';

                // 5. STRIP COMMAS FROM ALL NUMERIC FIELDS BEFORE SENDING TO DB
                const numericFields = ['i_patent_amount', 'i_amount_requested', 'employee_count', 'total_salary', 'rent_per_month', 'h_real_12m', 'h_real_3m', 'h_est_12m', 'h_est_3m'];
                numericFields.forEach((field) => {
                    if (payload[field]) {
                        payload[field] = String(payload[field]).replace(/,/g, '');
                    }
                });

                // Send the payload instead of this.formData
                fetch('{% url "crosscheck:save_company_info" %}', {method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'}, body: JSON.stringify(payload)})
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.status !== 'success') throw new Error(data.message);
                        this.saveMessage = 'Processing Tax Paid...';
                        return fetch('{% url "crosscheck:save_taxpaid" %}', {method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'}, body: JSON.stringify({ovatr: this.ovatrCode, temp_path: this.tempFilePath})});
                    })
                    .then((response) => response.json())
                    .then((taxData) => {
                        if (taxData.status !== 'success' && taxData.status !== 'warning') throw new Error('TaxPaid Error: ' + taxData.message);
                        this.saveMessage = 'Processing Purchase Invoices...';
                        return fetch('{% url "crosscheck:save_purchase" %}', {method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'}, body: JSON.stringify({ovatr: this.ovatrCode, temp_path: this.tempFilePath})});
                    })
                    .then((response) => response.json())
                    .then((purchData) => {
                        if (purchData.status !== 'success') throw new Error('Purchase Error: ' + purchData.message);
                        this.saveMessage = 'Processing Sale Invoices...';
                        return fetch('{% url "crosscheck:save_sale" %}', {method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'}, body: JSON.stringify({ovatr: this.ovatrCode, temp_path: this.tempFilePath})});
                    })
                    .then((response) => response.json())
                    .then((saleData) => {
                        if (saleData.status !== 'success') console.warn('Sale Error: ' + saleData.message);
                        this.saveMessage = 'Processing Reverse Charge...';
                        return fetch('{% url "crosscheck:save_reverse_charge" %}', {method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'}, body: JSON.stringify({ovatr: this.ovatrCode, temp_path: this.tempFilePath})});
                    })
                    .then((response) => response.json())
                    .then((rcData) => {
                        if (rcData.status === 'success') {
                            this.saveMessage = 'Data Saved! Redirecting...';
                            this.downloadAnnex3();
                        } else {
                            this.isSaving = false;
                            alert('Warning during Reverse Charge save: ' + rcData.message);
                        }
                    })
                    .catch((err) => {
                        this.isSaving = false;
                        console.error(err);
                        this.saveMessage = 'Error';
                        alert('Process Failed: ' + err.message);
                    });
            },

            downloadAnnex3() {
                localStorage.removeItem('crosscheck_draft');
                const url = "{% url 'crosscheck:processing' %}?ovatr_code=" + this.ovatrCode;
                window.location.href = url;
            },
        }));
    });
</script>
{% endblock %}
